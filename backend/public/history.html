<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Historique des envois</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --violet:#4A148C;
      --violet-2:#6420c1;
      --ok:#1e7a37;
      --wait:#e67e22;
      --bg:#f6f6f6;
      --muted:#666;
    }
    body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);margin:0}
    .wrap{max-width:1100px;margin:28px auto;padding:0 14px}
    h1{color:#222;text-align:center;margin:6px 0 14px;font-size:1.8rem}
    .card{background:#fff;border-radius:12px;box-shadow:0 4px 16px #0001;padding:8px 8px 14px}
    table{width:100%;border-collapse:collapse}
    thead th{background:var(--violet);color:#fff;font-weight:bold;padding:12px;border-top-left-radius:8px}
    thead th:last-child{border-top-right-radius:8px}
    th,td{padding:12px;border-bottom:1px solid #eee;text-align:left;vertical-align:middle}
    tr:hover{background:#faf7ff}
    .status-ok{color:#fff;background:var(--ok);border-radius:999px;padding:.25em .7em;font-weight:bold;display:inline-block}
    .status-wait{color:#fff;background:var(--wait);border-radius:999px;padding:.25em .7em;font-weight:bold;display:inline-block}
    .muted{color:var(--muted)}
    .btn{display:inline-flex;align-items:center;gap:8px;border:0;border-radius:8px;padding:8px 12px;background:var(--violet-2);color:#fff;cursor:pointer;font-weight:bold}
    .btn.small{padding:6px 10px;font-size:.92rem}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn:hover{filter:brightness(1.05)}
    .chip{display:inline-block;border-radius:999px;padding:.2em .7em;background:#eef;border:1px solid #dde;color:#334}
    .wallet-ok{color:var(--ok);font-weight:bold}
    .copy-done{font-size:.9rem;color:var(--ok);margin-left:8px}
    .toolbar{display:flex;justify-content:flex-end;gap:10px;margin:8px 2px 12px}
    .tx-hash{font-family:monospace}
    @media (max-width:820px){ .hide-md{display:none} }
    @media (max-width:560px){
      .hide-sm{display:none}
      td,th{padding:10px 8px}
      h1{font-size:1.4rem}
    }
  </style>
</head>
<body>
  <!-- CONFIG CENTRALE -->
  <script src="config.js"></script>

  <div class="wrap">
    <h1>Historique des envois</h1>

    <div class="card">
      <div class="toolbar">
        <button class="btn small" id="refreshBtn">Rafraîchir</button>
      </div>

      <table aria-label="Historique des envois">
        <thead>
          <tr>
            <th>Lien</th>
            <th class="hide-sm">Montant</th>
            <th class="hide-md">Réseau</th>
            <th class="hide-sm">Téléphone</th>
            <th>Wallet receveur</th>
            <th>Statut</th>
            <th class="hide-md">Créé</th>
            <th class="hide-md">Réclamé</th>
            <th>Tx / Actions</th>
          </tr>
        </thead>
        <tbody id="history-body">
          <tr><td colspan="9" class="muted">Chargement…</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // Utilise la config centrale si présente, sinon fallback local
    const BACKEND = (window.LINKISEND_CONFIG && window.LINKISEND_CONFIG.BACKEND_BASE)
      ? window.LINKISEND_CONFIG.BACKEND_BASE
      : `${location.protocol}//${location.hostname}:8000`;

    function fmtDate(s){
      if(!s) return "";
      try { return new Date(s).toLocaleString(); } catch(e){ return s; }
    }
    function short(s, n=10){
      if(!s) return "";
      return s.length<=n*2 ? s : `${s.slice(0,n)}…${s.slice(-n)}`;
    }
    async function copyToClipboard(text){
      try{
        await navigator.clipboard.writeText(text);
        return true;
      }catch(e){
        const ta = document.createElement('textarea');
        ta.value = text; document.body.appendChild(ta);
        ta.select(); const ok = document.execCommand('copy');
        document.body.removeChild(ta); return ok;
      }
    }

    function renderRows(items){
      const tbody = document.getElementById('history-body');
      tbody.innerHTML = "";

      if(!items || items.length===0){
        tbody.innerHTML = `<tr><td colspan="9" class="muted">Aucun envoi pour le moment.</td></tr>`;
        return;
      }

      items.forEach(it=>{
        const tr = document.createElement('tr');

        const linkUrl = `${BACKEND}/s/${it.short_id || ""}`;
        const isClaimed = !!it.claimed;

        const statusHtml = isClaimed
          ? `<span class="status-ok">Réclamé</span>`
          : `<span class="status-wait">En attente</span>`;

        const walletHtml = isClaimed
          ? `<span class="wallet-ok" title="${it.recipient_wallet || ''}">${short(it.recipient_wallet||'', 6)}</span>`
          : (it.recipient_wallet ? short(it.recipient_wallet, 6) : "<span class='muted'>—</span>");

        const txHtml = isClaimed
          ? `<div class="tx-hash" title="${it.sim_tx_hash||''}">${short(it.sim_tx_hash||'', 8)}</div>`
          : `<span class="muted">—</span>`;

        tr.innerHTML = `
          <td><span class="chip" title="${linkUrl}">${it.short_id || ""}</span></td>
          <td class="hide-sm">${it.amount} ${it.currency}</td>
          <td class="hide-md">${it.network}</td>
          <td class="hide-sm">${it.recipient_phone || ""}</td>
          <td>${walletHtml}</td>
          <td>${statusHtml}</td>
          <td class="hide-md">${fmtDate(it.created_at)}</td>
          <td class="hide-md">${fmtDate(it.claimed_at)}</td>
          <td>
            ${txHtml}
            <div style="margin-top:6px">
              <button class="btn small copy-btn" data-url="${linkUrl}">Copier</button>
              <span class="copy-done" style="display:none">Copié !</span>
            </div>
          </td>
        `;

        // action copier
        const btn = tr.querySelector('.copy-btn');
        const done = tr.querySelector('.copy-done');
        btn.addEventListener('click', async ()=>{
          btn.disabled = true;
          const ok = await copyToClipboard(btn.dataset.url);
          done.style.display = ok ? 'inline' : 'none';
          setTimeout(()=>{ done.style.display='none'; btn.disabled=false; }, 1200);
        });

        tbody.appendChild(tr);
      });
    }

    async function loadHistory(){
      const tbody = document.getElementById('history-body');
      tbody.innerHTML = `<tr><td colspan="9" class="muted">Chargement…</td></tr>`;
      try{
        const res = await fetch(`${BACKEND}/api/history`);
        const data = await res.json();
        renderRows(data.items || []);
      }catch(e){
        tbody.innerHTML = `<tr><td colspan="9" class="muted">Erreur lors du chargement.</td></tr>`;
      }
    }

    document.getElementById('refreshBtn').addEventListener('click', loadHistory);
    loadHistory();
  </script>
</body>
</html>
