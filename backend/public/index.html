<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LinkiSend ‚Äî Envoyer des cryptos</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --brand:#27ae60;           /* vert principal (boutons) */
      --brand-press:#219653;     /* vert press√© */
      --accent:#5a2ca0;          /* violet secondaire √©ventuel */
      --text:#1f2937;
      --muted:#6b7280;
      --bg:#f6f7f8;
      --card:#ffffff;
      --ring:rgba(39,174,96,.25);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font:16px/1.45 "Inter",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    }
    .wrap{
      max-width:420px; margin:24px auto; padding:0 16px;
    }
    .hero{
      text-align:center; margin-bottom:14px;
    }
    .badge{
      display:inline-block; padding:6px 10px; font-size:.78rem;
      background:#e8f7ee; color:var(--brand); border-radius:999px; font-weight:600;
    }
    h1{
      margin:10px 0 6px; font-size:1.45rem; line-height:1.2;
    }
    .sub{ color:var(--muted); font-size:.96rem; }

    .card{
      background:var(--card); border-radius:var(--radius);
      box-shadow:0 8px 30px rgba(0,0,0,.06);
      padding:18px; margin-top:12px;
    }
    label{
      display:block; font-weight:600; margin:14px 0 6px;
      font-size:.95rem;
    }
    input,select{
      width:100%; border:1px solid #e5e7eb; background:#fff; color:var(--text);
      padding:12px 13px; border-radius:10px; outline:none;
      transition:border .15s, box-shadow .15s;
      font-size:1rem;
    }
    input:focus, select:focus{
      border-color:var(--brand);
      box-shadow:0 0 0 4px var(--ring);
    }
    .row{
      display:grid; grid-template-columns:1fr 1fr; gap:12px;
    }

    .actions{ margin-top:18px; display:grid; gap:10px; }
    .btn{
      appearance:none; border:0; cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center;
      padding:13px 16px; border-radius:12px; font-weight:700; font-size:1.02rem;
      transition:transform .05s ease, box-shadow .15s ease, background .15s ease, opacity .15s;
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed }
    .btn-primary{ background:var(--brand); color:#fff; box-shadow:0 8px 18px rgba(39,174,96,.28) }
    .btn-primary:hover{ background:var(--brand-press) }
    .btn-primary:active{ transform:translateY(1px) }
    .btn-ghost{ background:#f2f3f5; color:#111; }
    .btn-mm{ background:#f0f7ff; color:#1d4ed8; }

    .hint{ margin-top:6px; color:var(--muted); font-size:.88rem }
    .foot-note{ margin-top:14px; color:var(--muted); font-size:.82rem; text-align:center }

    .alert{
      margin-top:14px; padding:12px 14px; border-radius:12px; font-size:.96rem;
      display:none;
    }
    .alert.ok{ background:#e8f7ee; color:#0f5132; border:1px solid #b7ebc4 }
    .alert.err{ background:#fde8e8; color:#912018; border:1px solid #f5c2c7 }
    .link-out{
      word-break:break-all; font-weight:600;
      color:#0f5132; text-decoration:underline;
    }

    /* responsive tiny tweak */
    @media (max-width:360px){
      .row{ grid-template-columns:1fr }
    }
  </style>
</head>
<body>
  <!-- Config centrale -->
  <script src="config.js"></script>

  <div class="wrap">
    <div class="hero">
      <span class="badge">LinkiSend</span>
      <h1>Envoyer des cryptos</h1>
      <div class="sub">G√©n√®re un lien de virement en 10 secondes.</div>
    </div>

    <form id="sendForm" class="card" autocomplete="on">
      <div class="row">
        <div>
          <label for="currency">Token</label>
          <select id="currency">
            <option>USDT</option>
            <option>USDC</option>
            <option>ETH</option>
            <option>BTC</option>
            <option>SOL</option>
            <option>BNB</option>
            <option>AVAX</option>
            <option>DAI</option>
            <option>LINK</option>
            <option>WBTC</option>
          </select>
        </div>
        <div>
          <label for="amount">Montant (crypto)</label>
          <input id="amount" type="number" inputmode="decimal" min="0" step="0.000001" placeholder="0.01" />
        </div>
      </div>

      <label for="wallet">Ton wallet (exp√©diteur)</label>
      <input id="wallet" type="text" placeholder="0xABCDEF..." />

      <div class="hint">
        <button type="button" id="btnConnectMM" class="btn btn-mm" style="margin-top:8px;">üîó Connecter MetaMask</button>
        <span id="mmState" class="hint"></span>
      </div>

      <label for="phone">Num√©ro du destinataire</label>
      <input id="phone" type="tel" placeholder="+33..." />

      <label for="network">R√©seau</label>
      <select id="network">
        <option>Ethereum</option>
        <option>BNB Chain</option>
        <option>Polygon</option>
        <option>Solana</option>
        <option>Avalanche</option>
      </select>

      <div class="actions">
        <button id="btnGenerate" class="btn btn-primary" type="submit">G√©n√©rer le lien</button>
        <!-- Optionnel : bouton secondaire (historique plus tard) -->
        <!-- <button class="btn btn-ghost" type="button" id="btnHistory">Voir l‚Äôhistorique</button> -->
      </div>

      <div id="ok" class="alert ok"></div>
      <div id="err" class="alert err"></div>

      <div class="foot-note">Aucun transfert on-chain n‚Äôest effectu√© tant que le lien n‚Äôest pas r√©clam√©.</div>
    </form>
  </div>

  <script>
    // ----- BACKEND base -----
    const BACKEND = (window.LINKISEND_CONFIG && window.LINKISEND_CONFIG.BACKEND_BASE)
      ? window.LINKISEND_CONFIG.BACKEND_BASE
      : `${location.protocol}//${location.hostname}:8000`;

    const $ = (id)=>document.getElementById(id);
    const form = $('sendForm');
    const btn = $('btnGenerate');
    const okBox = $('ok');
    const errBox = $('err');

    // ---- MetaMask (optionnel) ----
    const btnMM = $('btnConnectMM');
    const mmState = $('mmState');

    btnMM.addEventListener('click', async ()=>{
      if (!window.ethereum){ alert("MetaMask non d√©tect√©."); return; }
      try{
        const accs = await window.ethereum.request({ method:'eth_requestAccounts' });
        if (accs && accs[0]){
          $('wallet').value = accs[0];
          mmState.textContent = "Connect√© ‚úî";
        }
      }catch(e){
        alert("Connexion MetaMask refus√©e.");
      }
    });

    // ---- Helpers ----
    function show(el, msg){ el.style.display='block'; el.innerHTML = msg; }
    function hide(el){ el.style.display='none'; el.textContent=''; }

    function phoneLooksOk(s){
      if(!s) return false;
      const digits = (s+'').replace(/\D/g,'');
      return digits.length >= 6;
    }
    function evmLooksOk(s){
      return /^0x[a-fA-F0-9]{40}$/.test((s||'').trim());
    }

    // ---- Submit ----
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      hide(okBox); hide(errBox);

      const payload = {
        currency: $('currency').value,
        amount: parseFloat($('amount').value),
        sender_wallet: $('wallet').value.trim(),
        recipient_phone: $('phone').value.trim(),
        network: $('network').value
      };

      // validations rapides
      if(!payload.amount || payload.amount<=0){
        show(errBox, "Indique un montant valide."); return;
      }
      if(!payload.sender_wallet){
        show(errBox, "Ton wallet est requis."); return;
      }
      if(!evmLooksOk(payload.sender_wallet)){
        show(errBox, "Le wallet doit √™tre une adresse EVM valide (0x...)."); return;
      }
      if(!phoneLooksOk(payload.recipient_phone)){
        show(errBox, "Num√©ro de t√©l√©phone invalide."); return;
      }

      btn.disabled = true; btn.textContent = "G√©n√©ration‚Ä¶";
      try{
        const res = await fetch(`${BACKEND}/create-link`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if(!res.ok) throw new Error(data?.detail || "Erreur lors de la g√©n√©ration");

        const link = `${BACKEND}/s/${data.short_id}`;
        show(okBox, `Lien g√©n√©r√© : <br><a class="link-out" href="${link}" target="_blank" rel="noopener">${link}</a>`);
      }catch(err){
        show(errBox, err.message || "Erreur r√©seau");
      }finally{
        btn.disabled = false; btn.textContent = "G√©n√©rer le lien";
      }
    });

    // (Optionnel) Historique c√¥t√© front si on ajoute une page plus tard
    // $('btnHistory')?.addEventListener('click', ()=> location.href = 'history.html');
  </script>
</body>
</html>
