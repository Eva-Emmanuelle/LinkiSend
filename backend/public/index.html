<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>LinkiSend ‚Äî Envoyer des cryptos</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="assets/icons/icon-maskable-512.png">
  <meta name="theme-color" content="#0b0f14">
  <link rel="icon" href="assets/icons/icon-maskable-512.png" />

  <style>
    :root{--bg:#0b0f14;--bg-soft:#0f141b;--card:#121821;--card-2:#0f1620;--text:#e6edf3;--text-dim:#9fb0c0;--stroke:#1f2a37;--focus:#334155;--shadow:0 12px 40px rgba(0,0,0,.45);--radius:14px;--radius-sm:10px;--gap:12px}
    *,*:before,*:after{box-sizing:border-box}html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif;background:radial-gradient(1200px 600px at 20% -10%,#132034 0%,transparent 60%),radial-gradient(900px 500px at 110% 0%,#1a2334 0%,transparent 60%),var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
    .wrap{max-width:420px;margin:40px auto 64px;padding:0 16px}.brand{display:flex;align-items:center;justify-content:center;margin-bottom:18px;position:relative}.brand img.word{max-width:240px;height:auto;display:block}.brand img.arrow{position:absolute;left:0;top:50%;transform:translateY(-50%);max-width:60px;height:auto}
    .lang-toggle{position:absolute;right:0;top:50%;transform:translateY(-50%);font-size:12px;color:#9fb0c0;cursor:pointer;border:1px solid var(--stroke);padding:4px 8px;border-radius:999px;background:#0e141c}.lang-toggle:hover{background:#101924}
    .card{background:linear-gradient(180deg,var(--card),var(--card-2));border:1px solid var(--stroke);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px 16px}.card h2{margin:4px 2px 2px;font-size:22px;font-weight:750}.sub{color:var(--text-dim);margin:0 2px 14px;font-size:13px}
    .row{display:flex;gap:var(--gap)}.col{flex:1}label{display:block;margin:10px 2px 6px;font-size:13px;color:var(--text-dim)}
    select,input{width:100%;height:44px;padding:10px 12px;border-radius:var(--radius-sm);border:1px solid var(--stroke);background:#0e141c;color:var(--text);outline:none}
    select:focus,input:focus{border-color:var(--focus);box-shadow:0 0 0 3px rgba(51,65,85,.35)}
    .hint{font-size:12px;color:var(--text-dim);margin:6px 2px 0}
    .btn{width:100%;height:46px;border:0;border-radius:12px;font-weight:700;font-size:15px;cursor:pointer;background:radial-gradient(circle at 20% 20%,#8b5cf6,#06b6d4,#22c55e);color:#fff;box-shadow:0 10px 24px rgba(34,197,94,.2);margin-top:14px}
    .btn:hover{box-shadow:0 12px 32px rgba(34,197,94,.28)}.btn:active{transform:translateY(1px)}
    .wallet-link{display:inline-flex;align-items:center;gap:8px;color:#93c5fd;text-decoration:none;font-weight:600;font-size:14px;padding:8px 10px;border-radius:10px;border:1px dashed var(--stroke);background:#0a1220;margin:8px 2px 4px;width:max-content}
    .wallet-link:hover{background:#0d1729}
    .result,.error{margin:14px 2px 0;padding:10px 12px;border-radius:10px;font-size:13px;border:1px solid var(--stroke)}.error{background:#fee2e2;color:#991b1b;border:1px solid #f87171}
    .result-cta{margin:14px 2px 0;padding:16px;border-radius:14px;background:#ecfdf5;border:1px solid #bbf7d0;color:#064e3b;display:none}
    .row-cta{display:flex;gap:10px;align-items:stretch;flex-wrap:wrap}
    .toast{position:fixed;right:16px;bottom:16px;background:#10b981;color:white;padding:10px 14px;border-radius:10px;box-shadow:var(--shadow);opacity:0;transform:translateY(6px);transition:opacity .2s,transform .2s;z-index:60}.toast.show{opacity:1;transform:translateY(0)}
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(3,6,12,.6);backdrop-filter:blur(4px);z-index:50;padding:20px}.modal.open{display:grid}.modal-card{width:min(420px,95vw);background:linear-gradient(180deg,var(--card),var(--card-2));border:1px solid var(--stroke);border-radius:16px;box-shadow:var(--shadow);padding:16px}
    .modal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}.modal-head h3{margin:0;font-size:18px}.x{appearance:none;border:0;background:transparent;color:var(--text-dim);font-size:22px;cursor:pointer}
    .providers{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}.pv{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid var(--stroke);border-radius:12px;background:#0e141c;color:var(--text);cursor:pointer;font-weight:600}
    .pv img{width:20px;height:20px}.tag{margin-left:auto;font-size:11px;padding:2px 6px;border-radius:999px;background:linear-gradient(90deg,#8b5cf6,#06b6d4,#22c55e);color:#fff;border:0;font-weight:600}
    .phone-row{display:flex;gap:8px;align-items:center}.dial{position:relative;display:flex}.dial-btn{height:36px;padding:0 10px;border-radius:8px;border:1px solid var(--stroke);background:#0a1220;color:#e6edf3;display:inline-flex;align-items:center;gap:6px;cursor:pointer}
    .dial-btn:hover{background:#0d1729}.dial-panel{position:absolute;left:0;top:44px;z-index:30;width:260px;background:#0d1420;border:1px solid var(--stroke);border-radius:10px;box-shadow:var(--shadow);display:none}
    .dial-head{display:flex;align-items:center;gap:6px;padding:8px 10px;border-bottom:1px solid rgba(255,255,255,.06)}.dial-search-input{flex:1;height:32px;border:1px solid var(--stroke);background:#0e141c;color:#e6edf3;border-radius:8px;padding:0 8px;outline:none}
    .dial-list{max-height:260px;overflow:auto}.dial-item{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.04);cursor:pointer}.dial-item:last-child{border-bottom:0}
    .iso{font-weight:600;color:#e6edf3;width:26px;display:inline-block}.dialcode{color:#cfe1ff}.country{color:#9fb0c0;font-size:12px}
    @media (max-width:540px){.brand{justify-content:flex-start!important;gap:8px!important;margin:10px 0 20px!important;padding:0 8px}.brand img.arrow{position:static!important;transform:none!important;max-width:28px!important;height:auto!important;margin-right:6px}.brand img.word{max-width:170px!important}.lang-toggle{right:8px!important;font-size:11px;padding:3px 8px}}
    #installBtn{position:fixed;right:14px;bottom:90px;z-index:80;display:none;align-items:center;gap:8px;padding:10px 14px;border-radius:999px;border:1px solid var(--stroke);background:#0e141c;color:#e6edf3;font-weight:700;cursor:pointer;box-shadow:var(--shadow)}
    #installBtn:active{transform:translateY(1px)}
    #splash{position:fixed;inset:0;z-index:9999;display:grid;place-items:center;background:radial-gradient(1200px 600px at 20% -10%,#132034 0%,transparent 60%),radial-gradient(900px 500px at 110% 0%,#1a2334 0%,transparent 60%),var(--bg);transition:opacity .35s ease}
    #splash img{width:300px;height:auto;filter:drop-shadow(0 12px 30px rgba(0,0,0,.35));opacity:.96}#splash.hide{opacity:0;pointer-events:none}
    .modal{padding:env(safe-area-inset-top) 16px env(safe-area-inset-bottom) 16px}.modal-card{width:min(440px,92vw);max-height:88vh;overflow:auto}
    @media (max-width:380px){.modal-card{width:94vw}.providers{grid-template-columns:1fr!important}}
    @media (max-height:640px){.modal-card{max-height:84vh}}
    /* Effet sur üìñ et üíæ */
.emoji-btn {
  display: inline-block;            /* ‚Üê important pour que :hover/transform marchent */
  transition: transform 0.1s ease, opacity 0.1s ease;
  cursor: pointer;
}

/* Survol : l√©ger zoom */
.emoji-btn:hover {
  transform: scale(1.2);
}

/* Clic : bouton enfonc√© */
.emoji-btn:active {
  transform: scale(0.9);
  opacity: 0.7;
}
  </style>

  <script>
  document.addEventListener("DOMContentLoaded",function(){
    const s=document.getElementById('splash');if(!s)return;
    const isStandalone=(window.matchMedia&&window.matchMedia('(display-mode: standalone)').matches)||(window.navigator.standalone===true);
    if(isStandalone){s.remove();return}
    let done=false;function hide(){if(done)return;done=true;s.classList.add('hide');setTimeout(()=>s.remove(),400)}
    window.addEventListener('load',hide);setTimeout(hide,1200)
  });
  </script>

  <!-- CONFIG + pays -->
  <script src="config.js"></script>
  <script src="countries.js"></script>

  <!-- CHARGEUR ROBUSTE WalletConnect: local si OK, sinon fallback CDN -->
  <script>
    (function(){
      function inject(src){
        return new Promise((resolve,reject)=>{
          const s=document.createElement('script');
          s.src=src; s.async=true;
          s.onload=resolve; s.onerror=()=>reject(new Error('load fail '+src));
          document.head.appendChild(s);
        });
      }
      async function loadLocalOrCdn(){
        const local="/assets/vendor/wc/ethereum-provider.bundle.min.js";
        try{
          const r=await fetch(local,{cache:'no-store'});
          const ct=(r.headers.get('content-type')||'').toLowerCase();
          const txt=await r.text();
          if(!r.ok || ct.includes('text/html') || /^\s*<!doctype html/i.test(txt)) throw new Error('local is html/404');
          await inject(local+'?v='+Date.now());
        }catch(_){
          await inject("https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider@2/dist/index.umd.js");
        }
      }
      window.__wcProviderBootstrap = loadLocalOrCdn();
    })();
  </script>
</head>

<body>
  <script>
  (function(){
    const isStandalone=(window.matchMedia&&window.matchMedia('(display-mode: standalone)').matches)||(window.navigator.standalone===true);
    const ua=(navigator.userAgent||navigator.vendor||window.opera||"").toLowerCase();
    const isMobileUA=/android|iphone|ipad|ipod|iemobile|opera mini|mobile/i.test(ua);
    if(!isStandalone && isMobileUA){
      function browserHelp(){
        if(ua.includes('samsungbrowser'))return"Sur Samsung Internet : menu ‚ãÆ > Ajouter page √† > √âcran d'accueil.";
        if(ua.includes('firefox'))return"Sur Firefox Android : menu ‚ãÆ > Installer.";
        if(ua.includes('crios')||ua.includes('iphone')||ua.includes('ipad'))return"Sur iPhone/iPad (Safari) : bouton Partager ‚éã > Ajouter √† l‚Äô√©cran d‚Äôaccueil.";
        if(ua.includes('chrome'))return"Sur Chrome Android : menu ‚ãÆ > Installer l‚Äôapplication (ou Ajouter √† l‚Äô√©cran d‚Äôaccueil).";
        return"Ouvre le menu du navigateur et choisis ¬´ Ajouter √† l‚Äô√©cran d‚Äôaccueil ¬ª ou ¬´ Installer l‚Äôapplication ¬ª.";
      }
      document.write(`
        <style>body > :not(#install-gate){display:none!important}</style>
        <div id="install-gate" style="min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:24px;background:#0b0f14;color:#e6edf3;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;">
          <img src="assets/branding/logo-arrow.svg" alt="LinkiSend" style="width:96px;height:auto;margin-bottom:18px;opacity:.95;"/>
          <h2 style="margin:0 0 10px;font-size:22px;">Installe l‚Äôapp LinkiSend üì≤</h2>
          <p style="margin:0 0 16px;color:#9fb0c0;font-size:14px;max-width:340px;">Pour utiliser LinkiSend, installe l‚Äôapplication sur ton t√©l√©phone.</p>
          <button id="installNow" style="display:inline-flex;align-items:center;gap:8px;padding:10px 16px;border-radius:999px;border:1px solid #1f2a37;background:#0e141c;color:#e6edf3;font-weight:700;cursor:pointer;">üì≤ Installer l‚Äôapp</button>
          <div id="installHint" style="margin-top:10px;color:#9fb0c0;font-size:12px;">${browserHelp()}</div>
        </div>
      `);
      let _d=null;window.addEventListener('beforeinstallprompt',(e)=>{e.preventDefault();_d=e});
      window.addEventListener('click',async(ev)=>{
        const b=document.getElementById('installNow');if(!b||ev.target!==b)return;
        if(_d){_d.prompt();try{await _d.userChoice}catch{} _d=null}else{alert(document.getElementById('installHint').textContent)}
      });
    }
  })();
  </script>

  <div id="splash"><img src="assets/branding/logo-arrow.svg" alt="LinkiSend" /></div>

  <div class="wrap">
    <div class="brand">
      <img src="assets/branding/logo-arrow.svg" alt="Fl√®che" class="arrow" />
      <img src="assets/branding/logo-word.svg" alt="LinkiSend" class="word" />
      <span id="langToggle" class="lang-toggle">FR / EN</span>
    </div>

    <div class="card" role="region" aria-label="Formulaire d‚Äôenvoi">
      <h2 id="title">Envoyer des cryptos</h2>
      <p class="sub" id="subtitle">G√©n√®re un lien en 10&nbsp;secondes.</p>

      <label for="wallet" id="lbl-wallet">Ton wallet (exp√©diteur)</label>
      <input type="text" id="wallet" placeholder="0xABCDEF..." autocomplete="off" />
      <a href="#" id="connectWalletLink" class="wallet-link" aria-haspopup="dialog">Connecter un wallet</a>

      <div class="row">
        <div class="col">
          <label for="currency" id="lbl-token">Token</label>
<select id="currency"></select>
<span id="tokenBalanceInfo" style="display:block;font-style:italic;color:#9fb0c0;font-size:12px;margin-top:4px;">
  Solde: 0
</span>
        </div>
        <div class="col">
          <label for="amount" id="lbl-amount">Montant</label>
          <input type="number" id="amount" inputmode="decimal" min="0" step="0.00001" placeholder="0.01" />
          <span id="usdValue" style="display:block;font-style:italic;color:#9fb0c0;font-size:12px;margin-top:2px;">
  ‚âà 0.00 $
</span>
        </div>
      </div>

      <label for="network" id="lbl-network">R√©seau</label>
      <select id="network">
        <option>Ethereum</option><option>BNB Chain</option>
        <option>Polygon</option><option>Arbitrum One</option>
<option>Solana</option><option>Avalanche</option>
      </select>

      <label id="lbl-phone">Num√©ro du destinataire</label>
      <div class="phone-row">
        <div class="dial">
          <button id="dialBtn" class="dial-btn"><span class="iso">FR</span><span id="dialCode">+33</span></button>
          <div id="dialPanel" class="dial-panel">
            <div class="dial-head"><input id="dialSearch" class="dial-search-input" placeholder="Rechercher..."/></div>
            <div id="dialList" class="dial-list"></div>
          </div>
        </div>
        <input type="text" id="phone" placeholder="612345678" inputmode="tel"/>
      </div>

      <div class="contact-actions">
        <span class="emoji-btn" id="showContacts" title="Afficher les contacts">üìñ</span>
        <span class="emoji-btn" id="saveContact" title="Enregistrer ce num√©ro">üíæ</span>
      </div>
      <div class="contacts" id="contactsList"></div>

      <button id="generateBtn" class="btn">G√©n√©rer le lien</button>
      <p class="hint" id="hint">Aucun transfert on-chain n‚Äôest effectu√© tant que le lien n‚Äôest pas r√©clam√©.</p>

      <div id="result" class="result-cta" aria-live="polite">
        <h3 id="resultTitle" style="margin:0 0 10px;font-size:18px;">Lien pr√™t ‚úÖ</h3>
        <div class="row-cta" style="display:inline-flex;align-items:center;">
          <code id="the-link"></code>
          <span id="copyLinkBtn" style="cursor:pointer;margin-left:4px;" title="Copier">üìã</span>
        </div>
        <div class="sub-cta" id="validityText" style="margin-top:10px;">
          ‚è≥ Validit√© : 24h ‚Ä¢ Aucun transfert on-chain n‚Äôa lieu tant que le lien n‚Äôest pas r√©clam√©.
        </div>
      </div>

      <div id="error" class="error" style="display:none"></div>
    </div>
  </div>

  <div class="toast" id="toast">Lien copi√© ‚úÖ</div>

  <div class="modal" id="walletModal" role="dialog" aria-modal="true" aria-labelledby="walletModalTitle">
    <div class="modal-card">
      <div class="modal-head">
        <h3 id="walletModalTitle">Connecter un wallet</h3>
        <button class="x" id="walletModalClose" aria-label="Fermer">‚úï</button>
      </div>
      <div class="providers">
        <button class="pv" data-wallet="metamask"><img src="assets/wallets/metamask.svg" alt="MetaMask" />MetaMask <span class="tag">EVM</span></button>
        <button class="pv" data-wallet="walletconnect"><img src="assets/wallets/walletconnect.svg" alt="WalletConnect" />WalletConnect <span class="tag">EVM</span></button>
        <button class="pv" data-wallet="uniswap"><img src="assets/wallets/uniswap.svg" alt="Uniswap" />Uniswap <span class="tag">DEX</span></button>
        <button class="pv" data-wallet="phantom"><img src="assets/wallets/phantom.svg" alt="Phantom" />Phantom <span class="tag">Solana</span></button>
      </div>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', ()=> {
    const BACKEND=(window.LINKISEND_CONFIG&&window.LINKISEND_CONFIG.BACKEND_BASE)?window.LINKISEND_CONFIG.BACKEND_BASE:`${location.protocol}//${location.hostname}:8000`;
    const resultDiv=document.getElementById('result');const errorDiv=document.getElementById('error');const walletInput=document.getElementById('wallet');const linkEl=document.getElementById('the-link');
    const dialBtn=document.getElementById('dialBtn');const dialPanel=document.getElementById('dialPanel');const dialSearch=document.getElementById('dialSearch');const dialList=document.getElementById('dialList');let currentDial={iso:"FR",code:"+33"};
    const langToggle=document.getElementById('langToggle');const userPref=localStorage.getItem('lang');let lang=userPref||((navigator.language||'fr').toLowerCase().startsWith('fr')?'fr':'en');
    const t={fr:{title:"Envoyer des cryptos",subtitle:"G√©n√®re un lien en 10 secondes.",wallet:"Ton wallet (exp√©diteur)",token:"Token",amount:"Montant",network:"R√©seau",phone:"Num√©ro du destinataire",hint:"Aucun transfert on-chain n‚Äôest effectu√© tant que le lien n‚Äôest pas r√©clam√©.",generate:"G√©n√©rer le lien",search:"Rechercher...",resultTitle:"Lien pr√™t ‚úÖ",validity:"‚è≥ Validit√© : 24h ‚Ä¢ Aucun transfert on-chain n‚Äôa lieu tant que le lien n‚Äôest pas r√©clam√©.",connectWallet:"Connecter un wallet",savePh:"Nom du contact",save:"Enregistrer",cancel:"Annuler",saved:"Contact enregistr√© ‚úÖ",needNumber:"Saisis un num√©ro avant."},en:{title:"Send crypto",subtitle:"Generate a link in 10 seconds.",wallet:"Your wallet (sender)",token:"Token",amount:"Amount",network:"Network",phone:"Recipient phone",hint:"No on-chain transfer happens until the link is claimed.",generate:"Generate link",search:"Search...",resultTitle:"Link ready ‚úÖ",validity:"‚è≥ Valid for 24h ‚Ä¢ No on-chain transfer until the link is claimed.",connectWallet:"Connect a wallet",savePh:"Contact name",save:"Save",cancel:"Cancel",saved:"Contact saved ‚úÖ",needNumber:"Enter a number first."}};
    function applyLang(){document.getElementById("title").textContent=t[lang].title;document.getElementById("subtitle").textContent=t[lang].subtitle;document.getElementById("lbl-wallet").textContent=t[lang].wallet;document.getElementById("lbl-token").textContent=t[lang].token;document.getElementById("lbl-amount").textContent=t[lang].amount;document.getElementById("lbl-network").textContent=t[lang].network;document.getElementById("lbl-phone").textContent=t[lang].phone;document.getElementById("hint").textContent=t[lang].hint;document.getElementById("generateBtn").textContent=t[lang].generate;document.getElementById("connectWalletLink").textContent=t[lang].connectWallet;document.getElementById("dialSearch").placeholder=t[lang].search;document.getElementById("resultTitle").textContent=t[lang].resultTitle;document.getElementById("validityText").textContent=t[lang].validity;document.getElementById("langToggle").textContent=(lang==='fr')?'FR / EN':'EN / FR';if(dialPanel.style.display==='block')renderDialList(dialSearch.value.toLowerCase());if(saveNameInput)saveNameInput.placeholder=t[lang].savePh;if(saveConfirmBtn)saveConfirmBtn.textContent=`‚úÖ ${t[lang].save}`;if(saveCancelBtn)saveCancelBtn.textContent=`‚úñÔ∏è ${t[lang].cancel}`;}
    langToggle.addEventListener('click',()=>{lang=(lang==='fr')?'en':'fr';localStorage.setItem('lang',lang);applyLang()});

    const modal=document.getElementById('walletModal');const openModal=()=>{modal.classList.add('open')};const closeModal=()=>{modal.classList.remove('open')};
    document.getElementById('connectWalletLink').addEventListener('click',(e)=>{e.preventDefault();openModal()});document.getElementById('walletModalClose').addEventListener('click',closeModal);modal.addEventListener('click',(e)=>{if(e.target===modal)closeModal()});

    const discovered=[];window.addEventListener('eip6963:announceProvider',(event)=>{try{discovered.push(event.detail)}catch{}});try{window.dispatchEvent(new Event('eip6963:requestProvider'))}catch{}
    function isStandaloneApp(){return (window.matchMedia&&window.matchMedia('(display-mode: standalone)').matches)||(window.navigator.standalone===true)}
    const isMobile=/android|iphone|ipad|ipod/i.test(navigator.userAgent||"");
    function getProviderBy(match6963,matchLegacy){const d=discovered.find(x=>{try{return match6963(x)}catch{return false}});if(d&&d.provider)return d.provider;if(window.ethereum){if(Array.isArray(window.ethereum.providers)){const p=window.ethereum.providers.find(p=>{try{return matchLegacy(p)}catch{return false}});if(p)return p}if(matchLegacy(window.ethereum))return window.ethereum}return null}
    function loadScript(src){return new Promise((resolve,reject)=>{const s=document.createElement('script');s.src=src;s.async=true;s.onload=resolve;s.onerror=()=>reject(new Error("√âchec chargement "+src));document.head.appendChild(s)})}

    function getWcGlobal(){
      const mod=window['@walletconnect/ethereum-provider'];
      if(mod&&(mod.EthereumProvider?.init||mod.default?.EthereumProvider?.init)){return mod.EthereumProvider||mod.default.EthereumProvider}
      return window.EthereumProvider||window.WalletConnectEthereumProvider||(window.WalletConnectProvider&&(window.WalletConnectProvider.init?window.WalletConnectProvider:window.WalletConnectProvider.default))||(window.WalletConnect&&window.WalletConnect.EthereumProvider)
    }

    async function loadWalletConnectProvider(){
      try{await window.__wcProviderBootstrap}catch{} // attend le bootstrap local/CDN
      let EP=getWcGlobal(); if(EP) return EP;
      const umd=["https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider@2/dist/index.umd.js","https://unpkg.com/@walletconnect/ethereum-provider@2/dist/index.umd.js"];
      for(const u of umd){try{await loadScript(u+"?v="+Date.now());EP=getWcGlobal();if(EP)return EP}catch{}}
      return null;
    }

    modal.querySelectorAll('.pv').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const provider=btn.getAttribute('data-wallet');
        if(provider==='metamask'){
          const eth=getProviderBy(d=>/metamask/i.test(d?.info?.rdns||'')||/metamask/i.test(d?.info?.name||''),p=>!!p.isMetaMask);
          if(!eth||!eth.request){if(isStandaloneApp()&&!isMobile){window.open(window.location.href,'_blank');return}
            if(isMobile){const path=location.host+location.pathname+location.search;location.href=`https://metamask.app.link/dapp/${path}`;return}
            alert("MetaMask non d√©tect√©. Installe l‚Äôextension puis recharge la page.");return}
          try{const accounts=await eth.request({method:'eth_requestAccounts'});if(accounts&&accounts[0])walletInput.value=accounts[0];closeModal()}catch(e){console.error(e);alert("Connexion MetaMask refus√©e ou erreur.")}
// üîÑ Mise √† jour auto quand on change de sous-compte MetaMask
if (eth && typeof eth.on === "function") {
  eth.on("accountsChanged", (accs) => {
    if (Array.isArray(accs) && accs[0]) {
      walletInput.value = accs[0];
    } else {
      walletInput.value = "";
    }
  });
}
          // üïí Fallback : v√©rifie r√©guli√®rement l‚Äôadresse MetaMask
let lastMetaMaskAddr = walletInput.value;
setInterval(async () => {
  try {
    if (eth && typeof eth.request === "function") {
      const accs = await eth.request({ method: "eth_accounts" });
      if (Array.isArray(accs) && accs[0]) {
        const current = accs[0];
        if (current !== lastMetaMaskAddr) {
          walletInput.value = current;
          lastMetaMaskAddr = current;
        }
      }
    }
  } catch(e) {
    console.warn("Polling MetaMask error:", e);
  }
}, 2000);
          // === LinkiSend ¬∑ EVM balances (format MetaMask, auto-refresh) ===
const walletEl   = document.getElementById('wallet');
const tokenSel   = document.getElementById('token');
const networkSel = document.getElementById('network');

const ERC20_REGISTRY = {
  // Tu pourras ajouter Polygon/Arbitrum ensuite : m√™me structure.
  Ethereum: [
    { symbol: 'ETH',  native: true,  decimals: 18 },
    { symbol: 'USDT', address: '0xdAC17F958D2ee523a2206206994597C13D831ec7', decimals: 6  },
    { symbol: 'USDC', address: '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48', decimals: 6  },
    { symbol: 'DAI',  address: '0x6B175474E89094C44Da98b954EedeAC495271d0F', decimals: 18 },
  ],
};

// Arrondi ‚Äúfa√ßon MetaMask‚Äù : 5 d√©cimales max + trim des z√©ros
function fmtAmount(n) {
  if (!isFinite(n) || n === 0) return '0';
  const s = n.toFixed(5);
  return s.replace(/\.?0+$/,'');
}

// Lecture balance ERC-20 par eth_call (balanceOf)
async function readErc20Balance(eth, addr, tokenAddr, decimals) {
  // balanceOf(address) => 0x70a08231 + 12*'00' + 20 bytes address
  const method = '0x70a08231';
  const paddedAddr = '0'.repeat(24) + addr.toLowerCase().replace(/^0x/,'');
  const data = method + paddedAddr;
  const res = await eth.request({ method: 'eth_call', params: [{ to: tokenAddr, data }, 'latest'] });
  const raw = BigInt(res || '0x0');
  const denom = 10n ** BigInt(decimals);
  // conversion BigInt ‚Üí Number en s√©curit√© pour l‚Äôaffichage
  const asNumber = Number(raw) / Number(denom);
  return asNumber;
}

// Lecture balance native (ETH) par eth_getBalance
async function readNativeBalance(eth, addr) {
  const hex = await eth.request({ method: 'eth_getBalance', params: [addr, 'latest'] });
  const wei = BigInt(hex || '0x0');
  const ethNum = Number(wei) / 1e18;
  return ethNum;
}

// Reconstruit la liste Token avec les montants du r√©seau s√©lectionn√©
async function refreshEvmBalances() {
  if (!walletEl || !tokenSel || !networkSel) return;
  const addr = (walletEl.value || '').trim();
  if (!addr || !addr.startsWith('0x')) return;

  const eth = window.ethereum;
  if (!eth || typeof eth.request !== 'function') return;

  const network = networkSel.value || 'Ethereum';
  const registry = ERC20_REGISTRY[network];
  if (!registry) return;

  // 1) R√©cup√®re les soldes
  const balances = [];
  for (const t of registry) {
    try {
      const amount = t.native
        ? await readNativeBalance(eth, addr)
        : await readErc20Balance(eth, addr, t.address, t.decimals);
      balances.push({ symbol: t.symbol, amount, decimals: t.decimals, native: !!t.native });
    } catch (e) {
      balances.push({ symbol: t.symbol, amount: 0, decimals: t.decimals, native: !!t.native });
      console.warn('balance error', t.symbol, e);
    }
  }

  // 2) Met √† jour le <select id="token"> avec ‚ÄúSYMBOL ‚Äî montant‚Äù
  //    (on conserve uniquement les tokens connus du r√©seau actif)
  tokenSel.innerHTML = ''; // on repart propre
  for (const b of balances) {
    const opt = document.createElement('option');
    opt.value = b.symbol;
    opt.textContent = `${b.symbol} ‚Äî ${fmtAmount(b.amount)}`;
    opt.dataset.balance = String(b.amount);
    tokenSel.appendChild(opt);
  }

  // 3) S√©lectionne par d√©faut le 1er token au solde > 0, sinon ETH
  const firstPos = Array.from(tokenSel.options).find(o => Number(o.dataset.balance) > 0);
  if (firstPos) tokenSel.value = firstPos.value;
  else if (Array.from(tokenSel.options).some(o => o.value === 'ETH')) tokenSel.value = 'ETH';
}

// --- D√©clencheurs automatiques ---

// a) √Ä chaque changement d‚Äôadresse (listener + polling que tu as d√©j√†) ‚Üí on rafra√Æchit
if (eth && typeof eth.on === 'function') {
  eth.on('accountsChanged', () => {
    refreshEvmBalances();
  });
}

// b) Sur notre polling d‚Äôadresse (toutes les 2s), on a d√©j√† mis √† jour walletEl.value.
//    On ajoute ici un petit observateur qui relance le scan si la valeur change.
let _lastAddrForScan = (walletEl?.value || '').trim();
setInterval(() => {
  const cur = (walletEl?.value || '').trim();
  if (cur && cur !== _lastAddrForScan) {
    _lastAddrForScan = cur;
    refreshEvmBalances();
  }
}, 1200);

// c) Si l‚Äôutilisateur change le r√©seau manuellement ‚Üí on rescannera ce r√©seau
if (networkSel) {
  networkSel.addEventListener('change', () => {
    // On respecte ton choix : on scanne la cha√Æne choisie
    refreshEvmBalances();
  });
}

// d) Premier affichage apr√®s connexion MetaMask
refreshEvmBalances();
                } else if (provider === "phantom") {
          const ph = window.solana;
          if (ph && ph.isPhantom) {
            try {
              const resp = await ph.connect();
              walletInput.value = resp.publicKey.toString();
              // üîÑ garde le champ √† jour si l'utilisateur change de compte ou se d√©connecte
              if (typeof ph.on === "function") {
                ph.on("accountChanged", (pubKey) => {
                  walletInput.value = pubKey ? pubKey.toString() : "";
                });
              }
              closeModal();
            } catch (err) {
              console.error(err);
              alert("Connexion Phantom refus√©e ou erreur.");
            }
          } else {
            window.open("https://phantom.app/", "_blank");
          }

                } else if (provider === "uniswap") {
          const uni = getProviderBy(
            d => /uniswap/i.test(d?.info?.rdns || '') || /uniswap/i.test(d?.info?.name || ''),
            p => !!p.isUniswap || p?.providerName === 'uniswap'
          );

          // Extension d√©tect√©e
          if (uni && typeof uni.request === "function") {
            try {
              const accounts = await uni.request({ method: "eth_requestAccounts" });
              if (accounts && accounts[0]) walletInput.value = accounts[0];

              // üîÑ garde le champ √† jour si le compte change
              if (typeof uni.on === "function") {
                uni.on("accountsChanged", (acc) => {
                  if (Array.isArray(acc) && acc[0]) walletInput.value = acc[0];
                });
              }

              closeModal();
              return;
            } catch (err) {
              console.error(err);
              alert("Connexion Uniswap refus√©e ou erreur.");
              return;
            }
          }

          // Pas d‚Äôextension : on ouvre l‚Äôapp Uniswap
          if (isMobile) {
            alert("Sur mobile, la connexion directe au wallet Uniswap n‚Äôest pas dispo sans WalletConnect. J‚Äôouvre l‚Äôapp web.");
            window.open(`https://app.uniswap.org/#/swap?chain=ethereum`, "_blank", "noopener,noreferrer");
            closeModal();
            return;
          }
          if (isStandaloneApp()) { window.open(window.location.href, '_blank'); return; }
          alert("Extension Uniswap non d√©tect√©e. J‚Äôouvre l‚Äôapp Uniswap dans un nouvel onglet.");
          window.open(`https://app.uniswap.org/#/swap?chain=ethereum`, "_blank", "noopener,noreferrer");
          closeModal();

                } else if (provider === "walletconnect") {
          try {
            if (window.__wcConnecting) return;
            window.__wcConnecting = true;

            const EP = await loadWalletConnectProvider();
            if (!EP || !EP.init) throw new Error("Provider WalletConnect indisponible (chargement)");

            if (!window.__wcProvider) {
              window.__wcProvider = await EP.init({
                projectId: "9c945cd5bef5c1e1905266cf0219736d",
                showQrModal: true,
                chains: [1],
                optionalChains: [137, 10, 42161, 56, 43114],
                methods: [
                  "eth_requestAccounts","eth_sendTransaction","personal_sign",
                  "eth_signTypedData","eth_signTypedData_v4","eth_sign"
                ],
                events: ["chainChanged","accountsChanged"]
              });

              // üîó Auto-remplissage du champ au changement de compte
              window.__wcProvider.on("accountsChanged", (acc) => {
                if (Array.isArray(acc) && acc[0]) {
                  walletInput.value = acc[0];
                }
              });
            }

            // ‚úÖ Connexion (affiche le QR si n√©cessaire)
            await window.__wcProvider.connect();

            // üßæ R√©cup√®re et place l‚Äôadresse
            let accounts = null;
            try {
              accounts = await window.__wcProvider.request({ method: "eth_requestAccounts" });
            } catch {
              accounts = await window.__wcProvider.request({ method: "eth_accounts" });
            }
            if (accounts && accounts[0]) {
              walletInput.value = accounts[0];
            }

            closeModal();
          } catch (err) {
            console.error("WalletConnect connect error:", err);
            alert("Connexion WalletConnect refus√©e ou erreur.");
          } finally {
            window.__wcConnecting = false;
          }
        }else{
          alert("Connexion via "+provider+" arrive bient√¥t.");
        }
      });
    });

    function renderDialList(f=""){dialList.innerHTML="";const filter=f.toLowerCase();COUNTRIES.filter(d=>!filter||d.en.toLowerCase().includes(filter)||d.fr.toLowerCase().includes(filter)||d.code.includes(filter)||d.iso.toLowerCase().includes(filter)).forEach(d=>{const name=(lang==="fr")?d.fr:d.en;const row=document.createElement("div");row.className="dial-item";row.innerHTML=`<span class="iso">${d.iso}</span><span class="dialcode">${d.code}</span><span class="country">${name}</span>`;row.onclick=()=>{currentDial={iso:d.iso,code:d.code};dialBtn.innerHTML=`<span class="iso">${d.iso}</span><span id="dialCode">${d.code}</span>`;dialPanel.style.display="none"};dialList.appendChild(row)})}
    dialBtn.addEventListener('click',(e)=>{e.stopPropagation();dialPanel.style.display=(dialPanel.style.display==="block"?"none":"block");if(dialPanel.style.display==="block"){renderDialList("");dialSearch.value="";dialSearch.focus()}});
    dialSearch.oninput=()=>renderDialList(dialSearch.value);
    document.addEventListener("click",e=>{if(!dialPanel.contains(e.target)&&!dialBtn.contains(e.target)){dialPanel.style.display="none"}});

    const contactsList=document.getElementById("contactsList");const showContacts=document.getElementById("showContacts");const saveContact=document.getElementById("saveContact");
    let contacts=JSON.parse(localStorage.getItem("contacts")||"[]");if(showContacts)showContacts.textContent="üìñ";
    function persistContacts(){localStorage.setItem("contacts",JSON.stringify(contacts))}
    function renderContacts(){contactsList.innerHTML="";if(contacts.length===0){contactsList.style.display="none";return}
      contacts.forEach((c,idx)=>{const row=document.createElement("div");row.className="contact-item";row.style.display="flex";row.style.alignItems="center";row.style.justifyContent="space-between";row.style.gap="8px";
        const left=document.createElement("div");left.textContent=`${c.name} (${c.phone})`;left.style.flex="1 1 auto";left.style.whiteSpace="nowrap";left.style.overflow="hidden";left.style.textOverflow="ellipsis";
        const del=document.createElement("button");del.type="button";del.title=(lang==='fr')?"Supprimer":"Delete";del.textContent="üóëÔ∏è";del.style.border="1px solid var(--stroke)";del.style.background="#0a1220";del.style.color="#ffffff";del.style.borderRadius="6px";del.style.padding="4px 6px";del.style.cursor="pointer";del.style.flex="0 0 auto";
        left.onclick=()=>{document.getElementById("phone").value=c.phone.replace(c.code,"");currentDial={iso:c.iso,code:c.code};dialBtn.innerHTML=`<span class="iso">${c.iso}</span><span id="dialCode">${c.code}</span>`;contactsList.style.display="none"};
        del.onclick=(ev)=>{ev.stopPropagation();contacts.splice(idx,1);persistContacts();renderContacts()};
        row.appendChild(left);row.appendChild(del);contactsList.appendChild(row)})
    }renderContacts();

    const actionsBar=document.querySelector('.contact-actions');const saveInline=document.createElement('div');saveInline.style.display='none';saveInline.style.marginTop='8px';saveInline.style.padding='10px';saveInline.style.border='1px solid var(--stroke)';saveInline.style.borderRadius='8px';saveInline.style.background='#0e1420';saveInline.style.boxShadow='var(--shadow)';saveInline.style.gap='8px';saveInline.style.alignItems='center';saveInline.style.justifyContent='space-between';
    const saveNameInput=document.createElement('input');saveNameInput.type='text';saveNameInput.id='saveName';saveNameInput.placeholder=t[lang].savePh;saveNameInput.style.width='100%';saveNameInput.style.padding='8px 10px';saveNameInput.style.border='1px solid var(--stroke)';saveNameInput.style.borderRadius='6px';saveNameInput.style.background='#0a1220';saveNameInput.style.color='#e6edf3';saveNameInput.style.marginRight='8px';
    const btnsWrap=document.createElement('div');btnsWrap.style.display='flex';btnsWrap.style.gap='8px';btnsWrap.style.marginTop='8px';
    const saveConfirmBtn=document.createElement('button');saveConfirmBtn.type='button';saveConfirmBtn.textContent=`‚úÖ ${t[lang].save}`;saveConfirmBtn.style.border='1px solid var(--stroke)';saveConfirmBtn.style.background='#0a1220';saveConfirmBtn.style.color='#ffffff';saveConfirmBtn.style.borderRadius='8px';saveConfirmBtn.style.padding='6px 10px';saveConfirmBtn.style.cursor='pointer';
    const saveCancelBtn=document.createElement('button');saveCancelBtn.type='button';saveCancelBtn.textContent=`‚úñÔ∏è ${t[lang].cancel}`;saveCancelBtn.style.border='1px solid var(--stroke)';saveCancelBtn.style.background='#0a1220';saveCancelBtn.style.color='#ffffff';saveCancelBtn.style.borderRadius='8px';saveCancelBtn.style.padding='6px 10px';saveCancelBtn.style.cursor='pointer';
    saveInline.appendChild(saveNameInput);btnsWrap.appendChild(saveConfirmBtn);btnsWrap.appendChild(saveCancelBtn);saveInline.appendChild(btnsWrap);actionsBar.insertAdjacentElement('afterend',saveInline);
    function toggleSaveInline(open){saveInline.style.display=open?'block':'none';if(open){saveNameInput.value='';saveNameInput.focus()}}
    document.getElementById('showContacts').onclick=()=>{contactsList.style.display=(contactsList.style.display==="block"?"none":"block");renderContacts()};
    document.getElementById('saveContact').onclick=()=>{const num=document.getElementById("phone").value.trim();if(!num){alert(t[lang].needNumber);return}toggleSaveInline(true)};
    saveConfirmBtn.onclick=()=>{const num=document.getElementById("phone").value.trim();if(!num){alert(t[lang].needNumber);return}const pseudo=saveNameInput.value.trim();if(!pseudo){saveNameInput.focus();return}const phone=currentDial.code+num;contacts.push({name:pseudo,phone,iso:currentDial.iso,code:currentDial.code});persistContacts();renderContacts();toggleSaveInline(false)};
    saveCancelBtn.onclick=()=>toggleSaveInline(false);

    document.getElementById('generateBtn').addEventListener('click',async()=>{
      const amount=parseFloat(document.getElementById('amount').value);
      const currency=document.getElementById('currency').value;
      const sender_wallet=walletInput.value.trim();
      const localPhone=document.getElementById('phone').value.trim();
      const recipient_phone=`${currentDial.code}${localPhone}`;
      const network=document.getElementById('network').value;
      resultDiv.style.display='none';errorDiv.style.display='none';
      if(!amount||!currency||!sender_wallet||!localPhone||!network){errorDiv.textContent=(lang==='fr')?"Merci de remplir tous les champs obligatoires.":"Please fill in all required fields.";errorDiv.style.display='block';return}
      try{
        const res=await fetch(`${BACKEND}/create-link`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({amount,currency,sender_wallet,recipient_phone,network})});
        const data=await res.json();if(!res.ok)throw new Error(data.detail||"Erreur lors de la g√©n√©ration du lien");
        const lien=`https://linkisend.io/${data.short_id}`;linkEl.textContent=lien;resultDiv.style.display='block';
      }catch(err){errorDiv.textContent=err.message||(lang==='fr'?'Erreur r√©seau':'Network error');errorDiv.style.display='block'}
    });

    const copyBtn=document.getElementById('copyLinkBtn');if(copyBtn){copyBtn.addEventListener('click',()=>{navigator.clipboard.writeText(linkEl.textContent).then(()=>{copyBtn.textContent="‚úÖ";setTimeout(()=>copyBtn.textContent="üìã",1500)})})}

    if("serviceWorker" in navigator){navigator.serviceWorker.register("/service-worker.js").then(()=>console.log("SW enregistr√© ‚úÖ")).catch(err=>console.error("SW erreur:",err))}
    let deferredPrompt=null;window.addEventListener('beforeinstallprompt',(e)=>{e.preventDefault();deferredPrompt=e;const b=document.getElementById('installBtn');if(b)b.style.display='inline-flex'});
    document.getElementById('installBtn').addEventListener('click',async()=>{if(!deferredPrompt)return;deferredPrompt.prompt();await deferredPrompt.userChoice;deferredPrompt=null;document.getElementById('installBtn').style.display='none'});
    window.addEventListener('appinstalled',()=>{const b=document.getElementById('installBtn');if(b)b.style.display='none'});
    applyLang();
  });
  </script>

  <button id="installBtn" aria-label="Installer l‚Äôapplication">üì≤ Installer</button>
  <script>
// Mapping entre symboles et IDs CoinGecko
const COINGECKO_IDS = {
  ETH: "ethereum",
  BNB: "binancecoin",
  MATIC: "matic-network",
  AVAX: "avalanche-2",
  SOL: "solana",
  USDT: "tether",
  USDC: "usd-coin",
  DAI: "dai",
  WBTC: "wrapped-bitcoin",
  LINK: "chainlink",
  BONK: "bonk",
  RAY: "raydium"
};

async function updateUsdValue(){
  const amountEl = document.getElementById("amount");
  const tokenEl  = document.getElementById("currency");
  const usdEl    = document.getElementById("usdValue");

  if (!amountEl || !tokenEl || !usdEl) return;

  const amount = parseFloat(amountEl.value);
  const sym = tokenEl.value;
  const id = COINGECKO_IDS[sym];

  if (!amount || !id){
    usdEl.textContent = "‚âà 0.00 $ (index√© sur CoinGecko)";
    return;
  }

  try {
    const url = `https://api.coingecko.com/api/v3/simple/price?ids=${id}&vs_currencies=usd`;
    const res = await fetch(url);
    const data = await res.json();
    const price = data[id].usd;
    const usdVal = (amount * price).toFixed(2);
    usdEl.textContent = `‚âà ${usdVal} $ (index√© sur CoinGecko)`;
  } catch(e){
    console.error("Erreur CoinGecko", e);
    usdEl.textContent = "(Erreur CoinGecko)";
  }
}

// Mettre √† jour quand on change le montant ou le token
document.getElementById("amount")?.addEventListener("input", updateUsdValue);
document.getElementById("currency")?.addEventListener("change", updateUsdValue);
</script>
  <script>
/* Fermer la liste de contacts par d√©faut et ne l‚Äôouvrir que via üìñ */
document.addEventListener('DOMContentLoaded', () => {
  const box = document.getElementById('contactsList');
  const btn = document.getElementById('showContacts');
  if (!box) return;

  // 1) Toujours cach√© au chargement, m√™me s'il y a des contacts
  box.style.display = 'none';

  // 2) Ouvrir/fermer uniquement via le bouton üìñ
  if (btn) {
    btn.onclick = () => {
      box.style.display = (box.style.display === 'block') ? 'none' : 'block';
    };
  }
});
</script>
  <!-- ====== LINKISEND: START SCANNER INTERNE (EVM + SOL) ====== -->
<script>
/* ====== LinkiSend ¬∑ Scanner EVM minimal (ETH + ERC20) ====== */
(function(){
  const walletEl   = document.getElementById('wallet');
  const tokenSel   = document.getElementById('currency');
  const networkSel = document.getElementById('network');
  const balInfoEl  = document.getElementById('tokenBalanceInfo');
  if(!walletEl || !tokenSel || !networkSel || !balInfoEl) return;

  /* -- Prix CoinGecko pour la ligne ‚âà $ sous ‚ÄúToken‚Äù -- */
  const CG_ID = {ETH:'ethereum',USDT:'tether',USDC:'usd-coin',DAI:'dai',WBTC:'wrapped-bitcoin',LINK:'chainlink'};
  async function setBalanceLine(sym, amountStr){
    try{
      const id = CG_ID[sym]; if(!id){ balInfoEl.textContent=''; return; }
      const r  = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${id}&vs_currencies=usd`);
      const j  = await r.json(); const p = j?.[id]?.usd;
      if(typeof p!=='number'){ balInfoEl.textContent=''; return; }
      const usd = (parseFloat(amountStr||'0') * p);
      balInfoEl.textContent = usd < 0.01 ? '‚âà < 0.01 $' : `‚âà ${usd.toFixed(2)} $`;
    }catch{ balInfoEl.textContent=''; }
  }
  function updateBalanceLineFromSelect(){
    const opt = tokenSel.options[tokenSel.selectedIndex];
    if(!opt) return;
    const sym = opt.value;
    const amountStr = (opt.textContent||'').split('‚Äî').pop().trim();
    setBalanceLine(sym, amountStr);
  }
  tokenSel.addEventListener('change', updateBalanceLineFromSelect);

  /* -- Formatage fa√ßon MetaMask (5 d√©cimales max) -- */
  const fmt = n => {
    const x = Number(n||0);
    if(!isFinite(x) || x===0) return '0';
    return x.toFixed(5).replace(/\.?0+$/,'');
  };

  /* -- Adresses ERC-20 (Mainnet ETH + Arbitrum One) -- */
  const ERC20 = {
    // chainId -> { native:{symbol,dec}, tokens:{SYM:{addr,dec}} }
    '0x1': { native:{symbol:'ETH',dec:18}, tokens:{
      USDT:{addr:'0xdAC17F958D2ee523a2206206994597C13D831ec7',dec:6},
      USDC:{addr:'0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48',dec:6},
      DAI :{addr:'0x6B175474E89094C44Da98b954EedeAC495271d0F',dec:18},
      WBTC:{addr:'0x2260FAC5E5542a773Aa44fBCfeDf7C193bc2C599',dec:8},
      LINK:{addr:'0x514910771AF9Ca656af840dff83E8264EcF986CA',dec:18},
    }},
    '0xa4b1': { native:{symbol:'ETH',dec:18}, tokens:{ // Arbitrum One
      USDT:{addr:'0xfd086bc7cd5c481dcc9c85ebe478a1c0b69fcbb9',dec:6},
      USDC:{addr:'0xaf88d065e77c8cc2239327c5edb3a432268e5831',dec:6},
      DAI :{addr:'0xda10009cbd5d07dd0cecc66161fc93d7c9000da1',dec:18},
      WBTC:{addr:'0x2f2a2543b76a4166549f7aab2e75bef0aefc5b0f',dec:8},
      LINK:{addr:'0xf97f4df75117a78c1a5a0dbb814af92458539fb4',dec:18},
    }},
  };
  const FALLBACK_LIST = ['ETH','USDT','USDC','DAI','WBTC','LINK'];

  /* -- Helpers bas niveau EVM -- */
  function hexToFloat(hex, dec){
    try{
      const raw = BigInt(hex||'0x0');
      const den = 10n ** BigInt(dec);
      return Number(raw) / Number(den);
    }catch{ return 0; }
  }
  function data_balanceOf(addr){
    return '0x70a08231' + addr.toLowerCase().replace(/^0x/,'').padStart(64,'0');
  }

  function setSelect(items){
    const prev = tokenSel.value;
    tokenSel.innerHTML = '';
    for(const it of items){
      const o = document.createElement('option');
      o.value = it.symbol;
      o.textContent = `${it.symbol} ‚Äî ${fmt(it.amount)}`;
      tokenSel.appendChild(o);
    }
    if(items.some(i=>i.symbol===prev)) tokenSel.value = prev;
    updateBalanceLineFromSelect();
  }

  async function scanEvmBalances(){
    const addr = (walletEl.value||'').trim();
    if(!addr || !addr.startsWith('0x')) { setSelect(FALLBACK_LIST.map(s=>({symbol:s,amount:0}))); return; }

    const eth = window.ethereum;
    if(!eth || typeof eth.request!=='function'){
      setSelect(FALLBACK_LIST.map(s=>({symbol:s,amount:0}))); return;
    }

    // lit le chainId actuel
    let chainId = '0x1';
    try{ chainId = await eth.request({method:'eth_chainId'}); }catch{}

    const reg = ERC20[chainId]; // si inconnu : on affiche juste ETH natif √† 0
    const items = [];

    // natif
    try{
      const balHex = await eth.request({method:'eth_getBalance', params:[addr,'latest']});
      const sym = reg?.native?.symbol || 'ETH';
      const dec = reg?.native?.dec    ?? 18;
      items.push({symbol:sym, amount: hexToFloat(balHex, dec)});
    }catch{ items.push({symbol: reg?.native?.symbol || 'ETH', amount:0}); }

    // ERC20 connus de ce r√©seau (ou la fallback list si r√©seau inconnu)
    const tokens = reg?.tokens;
    const wanted = tokens ? Object.keys(tokens) : FALLBACK_LIST.filter(s=>s!=='ETH');
    for(const sym of wanted){
      if(sym==='ETH') continue;
      if(!tokens){ items.push({symbol:sym, amount:0}); continue; }
      const {addr:tokenAddr, dec} = tokens[sym];
      try{
        const hex = await eth.request({method:'eth_call', params:[{to:tokenAddr, data:data_balanceOf(addr)}, 'latest']});
        items.push({symbol:sym, amount: hexToFloat(hex, dec)});
      }catch{ items.push({symbol:sym, amount:0}); }
    }

    // tri du plus gros au plus petit
    items.sort((a,b)=> b.amount - a.amount);
    setSelect(items);
  }

  /* -- Triggers -- */
  async function refresh(){ await scanEvmBalances(); }

  // au d√©marrage
  refresh();

  // quand l‚Äôadresse change (saisie ou coll√©e)
  let last = walletEl.value;
  setInterval(()=>{ const cur = walletEl.value; if(cur!==last){ last=cur; refresh(); } }, 800);

  // quand le r√©seau du select change ‚Üí on rescanner (m√™me si chainId diff√®re, on retombe sagement)
  networkSel.addEventListener('change', refresh);

  // √©v√©nements MetaMask si dispo
  const eth = (window.ethereum && Array.isArray(window.ethereum.providers))
    ? window.ethereum.providers.find(p=>p && (p.isMetaMask || p.isCoinbaseWallet || p.isRabby))
    : window.ethereum;
  if(eth && typeof eth.on==='function'){
    eth.on('accountsChanged', refresh);
    eth.on('chainChanged',  refresh);
  }

  // utile au debug console
  window.refresh = refresh;
})();
</script>
<!-- ====== LINKISEND: END SCANNER INTERNE ====== -->
  <script>
/* LinkiSend ‚Äî r√©seau pilot√© par l‚ÄôUI + resync au chargement
   - L‚ÄôUI s‚Äôaligne au chargement sur le chainId r√©el du provider
   - Le changement dans le s√©lecteur "R√©seau" d√©clenche un wallet_switchEthereumChain
   - Fallback: si Arbitrum n‚Äôest pas ajout√©, on l‚Äôajoute (wallet_addEthereumChain)
   - Garde-fou contre doublons
*/
(function () {
  if (window.__lsSyncAttached) return;
  window.__lsSyncAttached = true;

  const eth = window.ethereum;
  if (!eth) { console.warn('MetaMask non d√©tect√©'); return; }

  // --- Mapping cha√Ænes
  const NAME_TO_ID = {
    ethereum: '0x1',
    arbitrum: '0xa4b1',
  };
  const ID_TO_REGEX = {
    '0x1': /ethereum/i,
    '0xa4b1': /arbitrum/i,
  };

  function getNetworkSelect() {
    const selects = document.querySelectorAll('select');
    for (const s of selects) {
      if ([...s.options].some(o => /ethereum|arbitrum/i.test(o.textContent))) return s;
    }
    return null;
  }

  async function currentChainId() {
    try { return await eth.request({ method: 'eth_chainId' }); }
    catch { return null; }
  }

  async function alignUITo(chainId) {
    const select = getNetworkSelect();
    if (!select) return;
    const want = ID_TO_REGEX[chainId] || /ethereum/i;
    const opt = [...select.options].find(o => want.test(o.textContent));
    if (opt && select.value !== opt.value) {
      select.value = opt.value;
      select.dispatchEvent(new Event('change', { bubbles: true }));
      console.log('‚úÖ UI align√©e sur', opt.textContent.trim(), '(', chainId, ')');
    }
  }

  function parseSelectedChainId(select) {
    const label = (select.options[select.selectedIndex]?.textContent || '').toLowerCase();
    return /arbitrum/.test(label) ? NAME_TO_ID.arbitrum : NAME_TO_ID.ethereum;
  }

  async function ensureArbitrumAdded() {
    try {
      await eth.request({
        method: 'wallet_addEthereumChain',
        params: [{
          chainId: '0xa4b1',
          chainName: 'Arbitrum One',
          nativeCurrency: { name: 'Ether', symbol: 'ETH', decimals: 18 },
          rpcUrls: ['https://arb1.arbitrum.io/rpc'],
          blockExplorerUrls: ['https://arbiscan.io/']
        }]
      });
    } catch (e) {
      // 4001 user rejected; autres codes => on laisse l‚Äôutilisateur d√©cider
      console.warn('addChain Arbitrum:', e?.code || e);
    }
  }

  async function switchTo(chainId) {
    try {
      await eth.request({
        method: 'wallet_switchEthereumChain',
        params: [{ chainId }]
      });
      // Laisse MetaMask finaliser, puis recharge pour resynchroniser montants/listes
      setTimeout(() => location.reload(), 150);
    } catch (e) {
      // 4902 = cha√Æne inconnue, on tente de l‚Äôajouter (Arbitrum) puis on recommence
      if (e && e.code === 4902 && chainId === '0xa4b1') {
        await ensureArbitrumAdded();
        await switchTo(chainId);
      } else if (e && e.code !== 4001) {
        console.warn('switch error:', e);
      }
    }
  }

  // --- 1) Alignement initial sur le provider r√©el
  (async () => {
    const cid = await currentChainId();
    window.__lsLastCid = cid;
    await alignUITo(cid);
  })();

  // --- 2) L‚ÄôUI pilote MetaMask : on hook le select
  const select = getNetworkSelect();
  if (select && !select.__lsBound) {
    select.__lsBound = true;
    select.addEventListener('change', async () => {
      const targetId = parseSelectedChainId(select);
      const current = await currentChainId();
      if (current !== targetId) {
        await switchTo(targetId);
      }
    });
  }

  // --- 3) S√©curit√© : si le provider change en arri√®re-plan, on s‚Äôaligne
  clearInterval(window.__lsAlignPoll);
  window.__lsAlignPoll = setInterval(async () => {
    const cid = await currentChainId();
    if (cid && cid !== window.__lsLastCid) {
      window.__lsLastCid = cid;
      await alignUITo(cid); // pas de popup, on refl√®te juste l‚Äô√©tat r√©el
    }
  }, 1500);
})();
</script>
</body>
</html>
