<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>LinkiSend â€” Envoyer des cryptos</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <!-- PWA iOS (splash & mode app) -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="assets/icons/icon-maskable-512.png">
  <meta name="theme-color" content="#0b0f14">
  <style>
    :root{
      --bg:#0b0f14;--bg-soft:#0f141b;--card:#121821;--card-2:#0f1620;
      --text:#e6edf3;--text-dim:#9fb0c0;--stroke:#1f2a37;--focus:#334155;
      --shadow:0 12px 40px rgba(0,0,0,.45);--radius:14px;--radius-sm:10px;--gap:12px;
    }
    *,*:before,*:after{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif;
      background:
        radial-gradient(1200px 600px at 20% -10%,#132034 0%,transparent 60%),
        radial-gradient(900px 500px at 110% 0%,#1a2334 0%,transparent 60%),
        var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
    }
    .wrap{max-width:420px;margin:40px auto 64px;padding:0 16px;}
    .brand{display:flex;align-items:center;justify-content:center;margin-bottom:18px;position:relative;}
    .brand img.word{max-width:240px;height:auto;display:block;}
    .brand img.arrow{position:absolute;left:0;top:50%;transform:translateY(-50%);max-width:60px;height:auto;}
    .lang-toggle{
      position:absolute;right:0;top:50%;transform:translateY(-50%);
      font-size:12px;color:#9fb0c0;cursor:pointer;border:1px solid var(--stroke);
      padding:4px 8px;border-radius:999px;background:#0e141c;
    }
    .lang-toggle:hover{background:#101924}

    .card{
      background:linear-gradient(180deg,#101723,#0f1620);border:1px solid var(--stroke);
      box-shadow:var(--shadow);border-radius:var(--radius);padding:18px 16px
    }
    h2{margin:0 0 6px;font-size:22px}
    .sub{margin:0 0 16px;color:var(--text-dim);font-size:13px}
    label{display:block;margin:10px 0 6px;font-size:13px;color:var(--text-dim)}
    input,select,button{
      width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--stroke);
      background:#0e141c;color:var(--text);font-size:14px;outline:none
    }
    input:focus,select:focus,button:focus{box-shadow:0 0 0 3px rgba(59,130,246,.25)}
    .row{display:flex;gap:var(--gap)}
    .col{flex:1}
    .wallet-link{display:inline-block;margin-top:8px;font-size:13px;color:#6fb6ff;text-decoration:none}
    .wallet-link:hover{text-decoration:underline}
    .btn{
      background:linear-gradient(90deg,#8b5cf6,#06b6d4,#22c55e);border:0;font-weight:700;
      cursor:pointer;margin-top:14px
    }
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .hint{margin:8px 0 0;color:var(--text-dim);font-size:12px}
    .result-cta{display:none;margin-top:14px;padding:12px;border:1px solid var(--stroke);border-radius:12px;background:#0f1620}
    code{user-select:all}
    .error{display:none;margin-top:10px;color:#fca5a5;font-size:13px}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#121a26;color:#fff;border:1px solid var(--stroke);padding:10px 14px;border-radius:12px;display:none}

    /* Modal wallet */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5)}
    .modal-card{width:360px;max-width:96vw;border-radius:14px;background:#0e141c;border:1px solid var(--stroke);box-shadow:var(--shadow);padding:14px}
    .modal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .modal-head .x{border:0;background:transparent;color:#9fb0c0;font-size:18px;cursor:pointer}
    .providers{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
    .pv{
      display:flex;align-items:center;gap:10px;padding:10px;border:1px solid var(--stroke);
      border-radius:12px;background:#0e141c;color:var(--text);cursor:pointer;font-weight:600
    }
    .pv img{width:20px;height:20px}
    .tag{
      margin-left:auto;font-size:11px;padding:2px 6px;border-radius:999px;
      background:linear-gradient(90deg,#8b5cf6,#06b6d4,#22c55e);
      color:#fff;border:0;font-weight:600;
    }
    .pv:hover{background:#101924}

    /* Phone & contacts */
    .phone-row{display:flex;gap:10px}
    .dial{position:relative}
    .dial-btn{width:auto;display:inline-flex;gap:6px;align-items:center}
    .dial .iso{font-weight:700}
    .dial .dial-panel{
      position:absolute;left:0;top:calc(100% + 6px);z-index:5;display:none;width:260px;max-height:320px;overflow:auto;
      border:1px solid var(--stroke);border-radius:12px;background:#0e141c;box-shadow:var(--shadow)
    }
    .dial-head{padding:8px;border-bottom:1px solid var(--stroke)}
    .dial-search-input{width:100%}
    .dial-list{padding:6px}
    .dial-item{display:flex;gap:8px;align-items:center;padding:8px;border-radius:10px;cursor:pointer}
    .dial-item:hover{background:#101924}
    .dialcode{opacity:.65}

    .emoji-btn{cursor:pointer;font-size:18px}
    .contact-actions{display:flex;gap:12px;align-items:center;margin-top:8px}
    .contacts{margin-top:6px}

    .mini-form{display:none;margin-top:8px;padding:10px;border:1px dashed var(--stroke);border-radius:12px}
    .mini-row{display:flex;gap:10px}
    .mini-row input{flex:1}
    .mini-row .btn-mini{width:auto}

    .install{display:flex;justify-content:center;margin-top:12px}
    .install .pwa{display:none;width:auto}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="brand">
      <img src="assets/branding/logo-arrow.svg" alt="" class="arrow" />
      <img src="assets/branding/logo-word.svg" alt="LinkiSend" class="word" />
      <span id="langToggle" class="lang-toggle">FR / EN</span>
    </div>

    <div class="card" role="region" aria-label="Formulaire dâ€™envoi">
      <h2 id="title">Envoyer des cryptos</h2>
      <p class="sub" id="subtitle">GÃ©nÃ¨re un lien en 10&nbsp;secondes.</p>

      <!-- 1) WALLET -->
      <label for="wallet" id="lbl-wallet">Ton wallet (expÃ©diteur)</label>
      <input type="text" id="wallet" placeholder="0xABCDEF..." autocomplete="off" />
      <a href="#" id="connectWalletLink" class="wallet-link" aria-haspopup="dialog">Connecter un wallet</a>

      <!-- 2) TOKEN & MONTANT -->
      <div class="row">
        <div class="col">
          <label for="currency" id="lbl-token">Token</label>
          <select id="currency">
            <option>USDT</option><option>USDC</option><option>ETH</option>
            <option>BTC</option><option>SOL</option><option>BNB</option>
            <option>AVAX</option><option>DAI</option><option>LINK</option>
          </select>
        </div>
        <div class="col">
          <label for="amount" id="lbl-amount">Montant</label>
          <input type="number" id="amount" inputmode="decimal" min="0" step="0.00001" placeholder="0.01" />
        </div>
      </div>

      <!-- 3) RÃ‰SEAU -->
      <label for="network" id="lbl-network">RÃ©seau</label>
      <select id="network">
        <option>Ethereum</option><option>BNB Chain</option>
        <option>Polygon</option><option>Solana</option><option>Avalanche</option>
      </select>

      <!-- 4) TÃ‰LÃ‰PHONE -->
      <label id="lbl-phone">NumÃ©ro du destinataire</label>
      <div class="phone-row">
        <div class="dial">
          <button id="dialBtn" class="dial-btn"><span class="iso">FR</span><span id="dialCode">+33</span></button>
          <div id="dialPanel" class="dial-panel">
            <div class="dial-head"><input id="dialSearch" class="dial-search-input" placeholder="Rechercher..."/></div>
            <div id="dialList" class="dial-list"></div>
          </div>
        </div>
        <input type="text" id="phone" placeholder="612345678" inputmode="tel"/>
      </div>

      <!-- ðŸ“–/ðŸ’¾ actions contacts -->
      <div class="contact-actions">
        <span class="emoji-btn" id="showContacts" title="Afficher les contacts">ðŸ“–</span>
        <span class="emoji-btn" id="saveContact" title="Enregistrer ce numÃ©ro">ðŸ’¾</span>
      </div>
      <div class="contacts" id="contactsList"></div>

      <button id="generateBtn" class="btn">GÃ©nÃ©rer le lien</button>

      <p class="hint" id="hint">Aucun transfert on-chain nâ€™est effectuÃ© tant que le lien nâ€™est pas rÃ©clamÃ©.</p>

      <!-- Bloc rÃ©sultat -->
      <div id="result" class="result-cta" aria-live="polite">
        <h3 id="resultTitle" style="margin:0 0 10px;font-size:18px;">Lien prÃªt âœ…</h3>
        <div class="row-cta" style="display:inline-flex;align-items:center;">
          <code id="the-link"></code>
          <span id="copyLinkBtn" style="cursor:pointer;margin-left:4px;" title="Copier">ðŸ“‹</span>
        </div>
        <div class="val" style="margin-top:6px;color:#9fb0c0;font-size:12px">
          <span id="validityText">Valide 24h</span>
        </div>
      </div>

      <div class="install">
        <button id="installBtn" class="btn pwa">Installer lâ€™app</button>
      </div>

      <div id="error"  class="error"  style="display:none"></div>
    </div>
  </div>

  <!-- Toast copie (conservÃ© au cas oÃ¹) -->
  <div class="toast" id="toast">Lien copiÃ© âœ…</div>

  <!-- Modal choix wallet (inchangÃ©e) -->
  <div class="modal" id="walletModal" role="dialog" aria-modal="true" aria-labelledby="walletModalTitle">
    <div class="modal-card">
      <div class="modal-head">
        <h3 id="walletModalTitle">Connecter un wallet</h3>
        <button class="x" id="walletModalClose" aria-label="Fermer">âœ•</button>
      </div>
      <div class="providers">
        <div class="pv" data-wallet="metamask"><img src="assets/wallets/metamask.svg" alt=""><span>MetaMask</span><span class="tag">EVM</span></div>
        <div class="pv" data-wallet="walletconnect"><img src="assets/wallets/walletconnect.svg" alt=""><span>WalletConnect</span><span class="tag">EVM</span></div>
        <div class="pv" data-wallet="coinbase"><img src="assets/wallets/coinbase.svg" alt=""><span>Coinbase</span><span class="tag">EVM</span></div>
        <div class="pv" data-wallet="phantom"><img src="assets/wallets/phantom.svg" alt=""><span>Phantom</span><span class="tag">Solana</span></div>
      </div>
    </div>
  </div>

  <script>
    const BACKEND = (()=>{
      const loc = window.location;
      if (loc.hostname.includes("localhost") || loc.hostname.startsWith("127.")) {
        return "http://127.0.0.1:8000";
      }
      return "https://api.linkisend.io";
    })();

    const copyLinkBtn = document.getElementById('copyLinkBtn');
    const linkEl = document.getElementById('the-link');
    const toast = document.getElementById('toast');

    copyLinkBtn.addEventListener('click', ()=>{
      const text = linkEl.textContent.trim();
      if(!text) return;
      navigator.clipboard.writeText(text).then(()=>{
        toast.style.display='block';
        setTimeout(()=> toast.style.display='none', 1200);
      });
    });

    // ====== Phone format & contacts (abrÃ©gÃ© ici, inchangÃ©) ======
    const dialBtn = document.getElementById('dialBtn');
    const dialPanel = document.getElementById('dialPanel');
    const dialSearch = document.getElementById('dialSearch');
    const dialList = document.getElementById('dialList');
    let currentDial = { iso:"FR", code:"+33" };

    // ====== Langue (FR/EN) ======
    const langToggle = document.getElementById('langToggle');
    const userPref = localStorage.getItem('lang');
    let lang = userPref || ((navigator.language||'fr').toLowerCase().startsWith('fr') ? 'fr' : 'en');

    const t = {
      fr:{title:"Envoyer des cryptos",subtitle:"GÃ©nÃ¨re un lien en 10 secondes.",wallet:"Ton wallet (expÃ©diteur)",token:"Token",amount:"Montant",network:"RÃ©seau",phone:"NumÃ©ro du destinataire",hint:"Aucun transfert on-chain nâ€™est effectuÃ© tant que le lien nâ€™est pas rÃ©clamÃ©.",generate:"GÃ©nÃ©rer le lien",connectWallet:"Connecter un wallet",search:"Rechercherâ€¦",resultTitle:"Lien prÃªt âœ…",validity:"Valide 24h",savePh:"Nom du contact",save:"Enregistrer",cancel:"Annuler",saved:"Contact enregistrÃ© âœ…",needNumber:"Saisis un numÃ©ro avant."},
      en:{title:"Send crypto",subtitle:"Generate a link in 10 seconds.",wallet:"Your wallet (sender)",token:"Token",amount:"Amount",network:"Network",phone:"Recipient phone",hint:"No on-chain transfer occurs until the link is claimed.",generate:"Generate link",connectWallet:"Connect a wallet",search:"Searchâ€¦",resultTitle:"Link ready âœ…",validity:"Valid 24h",savePh:"Contact name",save:"Save",cancel:"Cancel",saved:"Contact saved âœ…",needNumber:"Enter a number first."}
    };

    function applyLang(){
      document.getElementById("title").textContent = t[lang].title;
      document.getElementById("subtitle").textContent = t[lang].subtitle;
      document.getElementById("lbl-wallet").textContent = t[lang].wallet;
      document.getElementById("lbl-token").textContent = t[lang].token;
      document.getElementById("lbl-amount").textContent = t[lang].amount;
      document.getElementById("lbl-network").textContent = t[lang].network;
      document.getElementById("lbl-phone").textContent = t[lang].phone;
      document.getElementById("hint").textContent = t[lang].hint;
      document.getElementById("generateBtn").textContent = t[lang].generate;
      document.getElementById("connectWalletLink").textContent = t[lang].connectWallet;
      document.getElementById("dialSearch").placeholder = t[lang].search;
      document.getElementById("resultTitle").textContent = t[lang].resultTitle;
      document.getElementById("validityText").textContent = t[lang].validity;
      document.getElementById("langToggle").textContent = (lang === 'fr') ? 'FR / EN' : 'EN / FR';
      if (dialPanel.style.display === 'block') renderDialList(dialSearch.value.toLowerCase());
      // MAJ textes du mini-formulaire contact (si prÃ©sent)
      const saveNameInput = document.getElementById('saveNameInput');
      const saveBtn = document.getElementById('saveBtn');
      const cancelBtn = document.getElementById('cancelBtn');
      if (saveNameInput) saveNameInput.placeholder = t[lang].savePh;
      if (saveBtn) saveBtn.textContent = t[lang].save;
      if (cancelBtn) cancelBtn.textContent = t[lang].cancel;
    }
    applyLang();
    langToggle.addEventListener('click', ()=>{ lang = (lang==='fr'?'en':'fr'); localStorage.setItem('lang',lang); applyLang(); });

    // ====== Ouverture/fermeture du modal wallet ======
    const modal = document.getElementById('walletModal');
    const openModal = ()=> modal.style.display='flex';
    const closeModal = ()=> modal.style.display='none';
    document.getElementById('connectWalletLink').addEventListener('click', (e)=>{ e.preventDefault(); openModal(); });
    document.getElementById('walletModalClose').addEventListener('click', closeModal);
    modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });

    // ====== Connexion wallets ======
    modal.querySelectorAll('.pv').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const provider = btn.getAttribute('data-wallet');

        if(provider === 'metamask'){
          // === MetaMask robuste : standalone PWA, mobile, multi-providers ===
          const isStandaloneApp =
            (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) ||
            (window.navigator.standalone === true);
          const isMobile = /android|iphone|ipad|ipod/i.test(navigator.userAgent || "");

          const eth = (window.ethereum && Array.isArray(window.ethereum.providers))
            ? window.ethereum.providers.find(p => p && p.isMetaMask)
            : window.ethereum;

          if (!eth || !eth.request) {
            if (isStandaloneApp && !isMobile) {
              window.open(window.location.href, '_blank'); // ouvrir dans un onglet "normal"
              return;
            }
            window.open("https://metamask.io/download/", "_blank");
            return;
          }
          try{
            const accounts = await eth.request({ method:'eth_requestAccounts' });
                await handleMetaMaskConnected(eth, accounts);
          }catch(err){
            console.error(err);
            alert("Connexion MetaMask refusÃ©e ou erreur.");
            return;
          }

        } else if (provider === 'walletconnect') {
          alert("Connexion via " + provider + " arrive bientÃ´t.");

        } else if (provider === 'coinbase') {
          alert("Connexion via " + provider + " arrive bientÃ´t.");

        } else if (provider === 'phantom') {
          const sol = window.solana;
          if (sol && sol.isPhantom) {
            try{
              const resp = await sol.connect({ onlyIfTrusted:false });
              const walletAddress = resp.publicKey.toString();
              document.getElementById('wallet').value = walletAddress;
              closeModal();
              solanaRescan(walletAddress);
            }catch(err){
              console.error(err);
              alert("Connexion Phantom refusÃ©e ou erreur.");
            }
          } else {
            window.open("https://phantom.app/", "_blank");
          }
        } else {
          // Tous les autres wallets encore non implÃ©mentÃ©s
          alert("Connexion via " + provider + " arrive bientÃ´t.");
        }
      });
    });

    // ====== Indicatifs (COUNTRIES) ======
    function renderDialList(f=""){
      dialList.innerHTML="";
      const filter = f.toLowerCase();
      COUNTRIES
        .filter(d =>
          !filter ||
          d.en.toLowerCase().includes(filter) ||
          d.fr.toLowerCase().includes(filter) ||
          d.code.includes(filter) ||
          d.iso.toLowerCase().includes(filter)
        )
        .forEach(d=>{
          const name = (lang === "fr") ? d.fr : d.en;
          const row = document.createElement("div");
          row.className = "dial-item";
          row.innerHTML = `<span class="iso">${d.iso}</span><span class="dialcode">${d.code}</span><span class="country">${name}</span>`;
          row.onclick = ()=>{
            currentDial = { iso:d.iso, code:d.code };
            document.querySelector('.dial-btn .iso').textContent = d.iso;
            document.getElementById('dialCode').textContent = d.code;
            dialPanel.style.display='none';
          };
          dialList.appendChild(row);
        });
    }
    renderDialList();

    dialBtn.addEventListener('click', ()=>{
      dialPanel.style.display = (dialPanel.style.display==='block'?'none':'block');
      if (dialPanel.style.display==='block'){ dialSearch.value=''; renderDialList(); }
    });
    dialSearch.addEventListener('input', (e)=> renderDialList(e.target.value) );
    document.addEventListener('click', (e)=>{
      if (!dialPanel.contains(e.target) && !dialBtn.contains(e.target)) dialPanel.style.display='none';
    });

    // ====== Contact mini-form (abrÃ©gÃ©) ======
    document.getElementById('saveContact').addEventListener('click', ()=>{
      const phone = document.getElementById('phone').value.trim();
      if(!phone){ alert(t[lang].needNumber); return; }
      const name = prompt(t[lang].savePh) || "";
      if(!name) return;
      const list = JSON.parse(localStorage.getItem('contacts') || "[]");
      list.push({ name, code:currentDial.code, phone });
      localStorage.setItem('contacts', JSON.stringify(list));
      alert(t[lang].saved);
    });

    document.getElementById('showContacts').addEventListener('click', ()=>{
      const box = document.getElementById('contactsList');
      const list = JSON.parse(localStorage.getItem('contacts') || "[]");
      box.innerHTML = list.map(c=>`<div>${c.name} â€” <code>${c.code}${c.phone}</code></div>`).join('') || "<div style='color:#9fb0c0'>Aucun contact</div>";
    });

    // ====== Wallet-aware dynamic token/network ======
    const currencySelect = document.getElementById('currency');
    const networkSelect  = document.getElementById('network');
    const walletInput    = document.getElementById('wallet');

    let CURRENT_WALLET = { type:null, evm:null, solana:null }; // {type:'evm'|'solana', evm:{eth,account,chainId}, solana:{address}}

    const EVM_CHAINS = {
      '0x1': { key:'ethereum',    name:'Ethereum',   native:{symbol:'ETH', decimals:18},
        tokens:[
          {symbol:'USDC', address:'0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606EB48', decimals:6},
          {symbol:'USDT', address:'0xdAC17F958D2ee523a2206206994597C13D831ec7', decimals:6},
          {symbol:'DAI',  address:'0x6B175474E89094C44Da98b954EedeAC495271d0F', decimals:18},
          {symbol:'WBTC', address:'0x2260FAC5E5542a773Aa44fBCfeDf7C193bc2C599', decimals:8}
        ]},
      '0x38': { key:'bsc',         name:'BNB Chain',  native:{symbol:'BNB', decimals:18},
        tokens:[
          {symbol:'USDC', address:'0x8ac76a51cc950d9822d68b83fe1ad97b32cd580d', decimals:18},
          {symbol:'USDT', address:'0x55d398326f99059fF775485246999027B3197955', decimals:18},
          {symbol:'DAI',  address:'0x1AF3F329e8BE154074D8769D1FFa4eE058B1DBc3', decimals:18},
          {symbol:'WBTC', address:'0x7130d2A12B9BCbFAe4f2634d864A1Ee1Ce3Ead9c', decimals:18}
        ]},
      '0x89': { key:'polygon',     name:'Polygon',    native:{symbol:'MATIC', decimals:18},
        tokens:[
          {symbol:'USDC', address:'0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174', decimals:6},
          {symbol:'USDT', address:'0xC2132D05D31c914a87C6611C10748AaCbD9b0f',   decimals:6},
          {symbol:'DAI',  address:'0x8f3Cf7ad23Cd3CaDbD9735AFf958023239c6A063', decimals:18},
          {symbol:'WBTC', address:'0x1BFD67037B42Cf73acF2047067bd4F2C47D9BfD6', decimals:8}
        ]},
      '0xa86a': { key:'avalanche', name:'Avalanche',  native:{symbol:'AVAX', decimals:18},
        tokens:[
          {symbol:'USDC', address:'0xB97EF9Ef8734C71904D8002F8b6Bc66Dd9c48a6E', decimals:6},
          {symbol:'USDT', address:'0x9702230A8Ea53601f5cD2dc00fDBc13d4dF4A8c7', decimals:6},
          {symbol:'DAI',  address:'0xd586E7F844cEa2F87f50152665BCbc2C279D8d70', decimals:18},
          {symbol:'WBTC', address:'0x50b7545627a5162F82A992c33b87aDc75187B218', decimals:8}
        ]}
    };

    const SOLANA_DEFAULTS = [
      {symbol:'SOL',  mint:null, decimals:9},
      {symbol:'USDC', mint:'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v', decimals:6},
      {symbol:'USDT', mint:'Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB', decimals:6},
      {symbol:'BONK', mint:'DezXAZ8z7PnrnRJjz3wXBoRgixCa6xjnB7YaB1pPB263', decimals:5},
      {symbol:'RAY',  mint:'4k3Dyjzvzp8eMZWUXbBCaJXipqAVCbi6y5b9VPVuyV7y', decimals:6},
    ];

    const EVM_NETWORK_ORDER = ['0x1','0x38','0x89','0xa86a'];

    function setOptions(selectEl, values){
      const current = selectEl.value;
      selectEl.innerHTML = '';
      values.forEach(v=>{
        const opt = document.createElement('option');
        opt.value = v.value;
        opt.textContent = v.label;
        selectEl.appendChild(opt);
      });
      const hasPrev = values.some(v=>v.value===current);
      if (hasPrev) selectEl.value = current;
    }

    async function evmCall(eth, to, data){
      return await eth.request({ method:'eth_call', params:[ { to, data }, 'latest' ]});
    }
    function erc20BalanceOfData(addr){
      const method = '70a08231'; // balanceOf(address)
      const padded = addr.replace(/^0x/,'').padStart(64,'0');
      return '0x'+method+padded;
    }

    async function getEvmBalances(eth, account, chainId){
      const chain = EVM_CHAINS[chainId];
      if(!chain) return { items:[], any:false };

      const items = [];
      // Native
      try{
        const hexBal = await eth.request({ method:'eth_getBalance', params:[account, 'latest'] });
        const nativeRaw = BigInt(hexBal);
        if (nativeRaw > 0n){
          items.push({symbol:chain.native.symbol, type:'native', decimals:chain.native.decimals});
        }
      }catch(e){ console.warn('native balance error', e); }

      // ERC20s (registry)
      for(const tok of chain.tokens){
        try{
          const data = erc20BalanceOfData(account);
          const res = await evmCall(eth, tok.address, data);
          const bal = BigInt(res);
          if (bal > 0n){
            items.push({symbol:tok.symbol, address:tok.address, decimals:tok.decimals});
          }
        }catch(e){ console.warn('erc20 balance error', tok.symbol, e); }
      }

      if(items.length === 0){
        // defaults (limit to 5): native + top 4 stables/bluechips
        const defaults = [ {symbol:chain.native.symbol, type:'native', decimals:chain.native.decimals} ];
        const preferred = ['USDC','USDT','DAI','WBTC'];
        for(const s of preferred){
          const tok = chain.tokens.find(x=>x.symbol===s);
          if (tok) defaults.push({symbol:tok.symbol, address:tok.address, decimals:tok.decimals});
          if (defaults.length>=5) break;
        }
        return { items:defaults, any:false };
      }
      // tri simple: natif dâ€™abord
      items.sort((a,b)=> (a.type==='native'? -1: 1) - (b.type==='native'? -1: 1) || a.symbol.localeCompare(b.symbol));
      return { items, any:true };
    }

    function populateCurrencyEVM(list){
      setOptions(currencySelect, list.items.map(x=>({ value:x.symbol, label:x.symbol })));
    }

    function populateNetworkEVM(currentChainId){
      const opts = EVM_NETWORK_ORDER
        .filter(cid => EVM_CHAINS[cid])
        .map(cid=>({ value:EVM_CHAINS[cid].name, label:EVM_CHAINS[cid].name, cid }));
      setOptions(networkSelect, opts.map(o=>({value:o.label, label:o.label})));
      networkSelect.value = EVM_CHAINS[currentChainId]?.name || opts[0]?.label || 'Ethereum';
      networkSelect.disabled = false;
      networkSelect.dataset.mode = 'evm';
      networkSelect.dataset.chainId = currentChainId;
    }

    async function switchEvmChain(targetName){
      const want = Object.entries(EVM_CHAINS).find(([,v])=>v.name===targetName);
      if(!want) return;
      const [chainId] = want;
      if(!CURRENT_WALLET.evm?.eth) return;
      const eth = CURRENT_WALLET.evm.eth;
      try{
        await eth.request({ method:'wallet_switchEthereumChain', params:[{ chainId }]});
      }catch(e){
        console.warn('switch chain failed', e);
      }
      await evmRescan(eth, CURRENT_WALLET.evm.account);
    }

    async function evmRescan(eth, account){
      const chainId = await eth.request({method:'eth_chainId'});
      CURRENT_WALLET = { type:'evm', evm:{ eth, account, chainId }, solana:null };
      const { items } = await getEvmBalances(eth, account, chainId);
      populateCurrencyEVM({items});
      populateNetworkEVM(chainId);
    }

    async function handleMetaMaskConnected(eth, accounts){
      if(!accounts || !accounts.length) return;
      const account = accounts[0];
      walletInput.value = account;
      closeModal();
      await evmRescan(eth, account);
      // events
      eth.removeAllListeners?.('accountsChanged');
      eth.on?.('accountsChanged', (acc)=> handleMetaMaskConnected(eth, acc));
      eth.removeAllListeners?.('chainChanged');
      eth.on?.('chainChanged', ()=> evmRescan(eth, account));
    }

    networkSelect.addEventListener('change', (e)=>{
      if (networkSelect.dataset.mode === 'evm'){
        switchEvmChain(networkSelect.value);
      }
    });

    // ====== Solana (Phantom) ======
    const SOLANA_RPC = "https://api.mainnet-beta.solana.com";
    const TOKEN_PROGRAM_ID = "TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA";

    function populateNetworkSolana(){
      setOptions(networkSelect, [{value:'Solana', label:'Solana'}]);
      networkSelect.disabled = true;
      networkSelect.dataset.mode = 'solana';
    }

    async function solanaRpc(body){
      const res = await fetch(SOLANA_RPC, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      return await res.json();
    }

    async function solanaRescan(address){
      CURRENT_WALLET = { type:'solana', evm:null, solana:{ address } };
      populateNetworkSolana();

      let list = [];
      // SOL balance
      try{
        const r = await solanaRpc({jsonrpc:"2.0", id:1, method:"getBalance", params:[address]});
        const lamports = r?.result?.value || 0;
        if (lamports > 0) list.push({symbol:'SOL'});
      }catch(e){ console.warn('SOL balance err', e); }

      // Token accounts by owner
      try{
        const r = await solanaRpc({jsonrpc:"2.0", id:2, method:"getTokenAccountsByOwner",
          params:[address, { programId: TOKEN_PROGRAM_ID }, { encoding:"jsonParsed" }]
        });
        const accounts = r?.result?.value || [];
        const byMint = {};
        for(const acc of accounts){
          const info = acc?.account?.data?.parsed?.info;
          const mint = info?.mint;
          const uiAmount = info?.tokenAmount?.uiAmount || 0;
          if (uiAmount > 0){
            byMint[mint] = (byMint[mint] || 0) + uiAmount;
          }
        }
        const known = SOLANA_DEFAULTS.slice(1); // skip SOL
        for(const tok of known){
          if (byMint[tok.mint] && byMint[tok.mint] > 0){
            list.push({symbol:tok.symbol});
          }
        }
      }catch(e){ console.warn('SPL scan err', e); }

      if (list.length === 0){
        // defaults (limit 5)
        list = SOLANA_DEFAULTS.slice(0,5).map(x=>({symbol:x.symbol}));
      }else{
        // sort SOL first
        list.sort((a,b)=> (a.symbol==='SOL'?-1:1) - (b.symbol==='SOL'?-1:1) || a.symbol.localeCompare(b.symbol));
      }
      setOptions(currencySelect, list.map(x=>({value:x.symbol,label:x.symbol})));
    }

    // === Service Worker ===
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/service-worker.js")
        .then(() => console.log("SW enregistrÃ© âœ…"))
        .catch(err => console.error("SW erreur:", err));
    }

    // === Bouton d'installation PWA ===
    let deferredPrompt = null;

    window.addEventListener('beforeinstallprompt', (e)=>{
      e.preventDefault();
      deferredPrompt = e;
      const b = document.getElementById('installBtn');
      if (b) b.style.display = 'inline-flex';
    });

    document.getElementById('installBtn').addEventListener('click', async ()=>{
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
      document.getElementById('installBtn').style.display='none';
    });

    // ====== GÃ©nÃ©ration du lien (inchangÃ©e) ======
    document.getElementById('generateBtn').addEventListener('click', async ()=>{
      const amount = document.getElementById('amount').value;
      const currency = document.getElementById('currency').value;
      const sender_wallet = document.getElementById('wallet').value.trim();
      const localPhone = document.getElementById('phone').value.trim();
      const recipient_phone = `${currentDial.code}${localPhone}`;
      const network = document.getElementById('network').value;

      const resultDiv = document.getElementById('result');
      const errorDiv = document.getElementById('error');

      resultDiv.style.display='none';
      errorDiv.style.display='none';

      if (!amount || !currency || !sender_wallet || !localPhone || !network){
        errorDiv.textContent = (lang==='fr')
          ? "Merci de remplir tous les champs obligatoires."
          : "Please fill in all required fields.";
        errorDiv.style.display='block';
        return;
      }

      try{
        const res = await fetch(`${BACKEND}/create-link`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ amount, currency, sender_wallet, recipient_phone, network })
        });
        const data = await res.json();
        if(!res.ok) throw new Error(data.detail || "Erreur lors de la gÃ©nÃ©ration du lien");

        const lien = `https://linkisend.io/${data.short_id}`;
        linkEl.textContent = lien;
        resultDiv.style.display='block';
      }catch(err){
        const errorDiv2 = document.getElementById('error');
        errorDiv2.textContent = err.message || (lang==='fr'?'Erreur rÃ©seau':'Network error');
        errorDiv2.style.display='block';
      }
    });

    // ====== DonnÃ©es pays (abrÃ©gÃ©) ======
    const COUNTRIES=[{"iso":"FR","code":"+33","fr":"France","en":"France"},{"iso":"ES","code":"+34","fr":"Espagne","en":"Spain"},{"iso":"US","code":"+1","fr":"Ã‰tats-Unis","en":"United States"},{"iso":"GB","code":"+44","fr":"Royaume-Uni","en":"United Kingdom"}];
  </script>
</body>
</html>
