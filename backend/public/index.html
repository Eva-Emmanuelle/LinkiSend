<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LinkiSend</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background:#0f172a;
      color:#e2e8f0;
      margin:0;
      padding:0;
    }
    .container { max-width:600px; margin:20px auto; padding:20px; }
    label { display:block; margin-top:15px; font-weight:bold; }
    input, select, button {
      width:100%; padding:10px; margin-top:5px;
      border-radius:8px; border:none;
      font-size:16px;
    }
    input, select { background:#1e293b; color:#f1f5f9; }
    button {
      background:#4f46e5; color:white; font-weight:bold;
      cursor:pointer; margin-top:20px;
    }
    button:hover { background:#4338ca; }
    .emoji-btn {
      display:inline-block;
      transition: transform 0.1s ease, opacity 0.1s ease;
      cursor:pointer;
    }
    .emoji-btn:hover { transform:scale(1.2); }
    .emoji-btn:active { transform:scale(0.9); opacity:0.7; }
  </style>
</head>
<body>
  <div class="container">
    <h1>LinkiSend</h1>

    <label for="wallet">Adresse Wallet</label>
    <input type="text" id="wallet" placeholder="0x..." />

    <label for="currency" id="lbl-token">Token</label>
    <select id="currency">
      <option>USDT</option>
      <option>USDC</option>
      <option>ETH</option>
      <option>BTC</option>
      <option>SOL</option>
      <option>BNB</option>
      <option>AVAX</option>
      <option>DAI</option>
      <option>LINK</option>
    </select>
    <!-- Ajout pour solde + équivalent USD -->
    <span id="tokenBalanceInfo" style="display:block;font-style:italic;color:#9fb0c0;font-size:12px;margin-top:4px;">
      Solde: 0
    </span>

    <label for="amount" id="lbl-amount">Montant</label>
    <input type="number" id="amount" inputmode="decimal" min="0" step="0.00001" placeholder="0.01" />
    <p id="usdValue" style="font-style:italic;color:#9fb0c0;font-size:13px;margin:2px 0 0;">
      ≈ 0.00 $
    </p>

    <label for="network">Réseau</label>
    <select id="network">
      <option value="ethereum">Ethereum</option>
      <option value="bsc">BNB Chain</option>
      <option value="polygon">Polygon</option>
      <option value="avalanche">Avalanche</option>
      <option value="solana">Solana</option>
    </select>

    <button id="generate">Générer le lien</button>
  </div>

  <!-- ====== LINKISEND: START SCANNER INTERNE MULTI-RÉSEAUX ====== -->
  <script>
  (function(){
    const walletInput = document.getElementById('wallet');
    const currencySel = document.getElementById('currency');
    const balInfoEl   = document.getElementById('tokenBalanceInfo');

    const CG_ID = {
      ETH:'ethereum', BNB:'binancecoin', MATIC:'matic-network', AVAX:'avalanche-2', SOL:'solana',
      USDT:'tether', USDC:'usd-coin', DAI:'dai', WBTC:'wrapped-bitcoin', LINK:'chainlink',
      BONK:'bonk', RAY:'raydium'
    };

    function toDecimalString(hexOrStr, decimals){
      if (hexOrStr == null) return "0";
      let big;
      if (typeof hexOrStr === "string" && hexOrStr.startsWith("0x")) big = BigInt(hexOrStr);
      else big = BigInt(String(hexOrStr));
      const d = BigInt(decimals);
      const base = 10n ** d;
      const intPart = big / base;
      const frac = big % base;
      if (frac === 0n) return intPart.toString();
      return `${intPart}.${frac.toString().padStart(Number(d),'0')}`.replace(/0+$/, '');
    }

    function setSelect(items){
      const prev = currencySel.value;
      currencySel.innerHTML = '';
      for (const it of items){
        const o = document.createElement('option');
        o.value = it.symbol;
        o.textContent = `${it.symbol} — ${it.amountStr}`;
        currencySel.appendChild(o);
      }
      if (items.some(i=>i.symbol===prev)) currencySel.value = prev;
    }

    async function setBalanceLine(symbol, amountStr){
      try{
        const id = CG_ID[symbol];
        if (!id){ balInfoEl.textContent = `Solde: ${amountStr} ${symbol}`; return; }
        const r = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${id}&vs_currencies=usd`);
        const j = await r.json();
        const p = j?.[id]?.usd;
        if (typeof p !== 'number'){ balInfoEl.textContent = `Solde: ${amountStr} ${symbol}`; return; }
        const usd = (parseFloat(amountStr || "0") * p).toFixed(2);
        balInfoEl.textContent = `Solde: ${amountStr} ${symbol} — ≈ ${usd} $`;
      }catch{
        balInfoEl.textContent = `Solde: ${amountStr} ${symbol}`;
      }
    }

    currencySel.addEventListener('change', ()=>{
      const opt = currencySel.options[currencySel.selectedIndex];
      if (!opt) return;
      const sym = opt.value;
      const amountStr = (opt.textContent||'').split('—').pop().trim();
      setBalanceLine(sym, amountStr);
    });

    const EVM = {
      '0x1': { native:{symbol:'ETH',dec:18}, tokens:{
        USDT:{addr:'0xdAC17F958D2ee523a2206206994597C13D831ec7',dec:6},
        USDC:{addr:'0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606EB48',dec:6},
        DAI :{addr:'0x6B175474E89094C44Da98b954EedeAC495271d0F',dec:18},
        WBTC:{addr:'0x2260FAC5E5542a773Aa44fBCfeDf7C193bc2C599',dec:8},
        LINK:{addr:'0x514910771AF9Ca656af840dff83E8264EcF986CA',dec:18}
      }}
      // idem pour BNB, Polygon, Avalanche...
    };

    function erc20BalanceOfData(owner){
      return '0x70a08231' + owner.replace(/^0x/,'').padStart(64,'0');
    }

    async function scanEvm(eth, account){
      let chainId;
      try{ chainId = await eth.request({method:'eth_chainId'}); }catch{ chainId = undefined; }
      const reg = chainId ? EVM[chainId] : undefined;
      const items = [];
      let natSymbol = reg?.native?.symbol || 'ETH';
      let natDec    = reg?.native?.dec || 18;
      let nativeHex = '0x0';
      try{ nativeHex = await eth.request({method:'eth_getBalance', params:[account,'latest']}); }catch{}
      const natStr = toDecimalString(nativeHex, natDec);
      items.push({symbol:natSymbol, amountStr:natStr, amountNum:parseFloat(natStr||'0')});
      if (reg){
        const data = erc20BalanceOfData(account);
        for (const [sym,tok] of Object.entries(reg.tokens)){
          try{
            const hex = await eth.request({method:'eth_call', params:[{to:tok.addr,data},'latest']});
            const str = toDecimalString(hex, tok.dec);
            items.push({symbol:sym, amountStr:str, amountNum:parseFloat(str||'0')});
          }catch{
            items.push({symbol:sym, amountStr:'0', amountNum:0});
          }
        }
      }
      items.sort((a,b)=> b.amountNum - a.amountNum);
      setSelect(items);
      const first = items[0]; if (first) setBalanceLine(first.symbol, first.amountStr);
    }

    // Solana simplifié
    const SOLANA_RPC = "https://api.mainnet-beta.solana.com";
    async function scanSolana(address){
      const items = [];
      let lamports = 0;
      try{
        const r = await fetch(SOLANA_RPC,{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({jsonrpc:"2.0",id:1,method:"getBalance",params:[address]})});
        const j = await r.json();
        lamports = j?.result?.value || 0;
      }catch{}
      const solStr = (lamports/1e9).toString();
      items.push({symbol:'SOL', amountStr:solStr, amountNum:parseFloat(solStr||'0')});
      items.sort((a,b)=> b.amountNum - a.amountNum);
      setSelect(items);
      const first = items[0]; if (first) setBalanceLine(first.symbol, first.amountStr);
    }

    async function refresh(){
      const addr = (walletInput.value || '').trim();
      if (!addr){ currencySel.innerHTML=''; balInfoEl.textContent=''; return; }
      if (addr.startsWith('0x') && window.ethereum && window.ethereum.request){
        await scanEvm(window.ethereum, addr);
      } else {
        await scanSolana(addr);
      }
    }

    refresh(); // lancement initial
    let last = walletInput.value;
    setInterval(()=>{ const cur = walletInput.value; if (cur !== last){ last=cur; refresh(); }},1000);
    const eth = window.ethereum;
    if (eth && eth.on){
      eth.on('accountsChanged', refresh);
      eth.on('chainChanged', refresh);
    }
  })();
  </script>
  <!-- ====== LINKISEND: END SCANNER INTERNE MULTI-RÉSEAUX ====== -->
</body>
</html>
