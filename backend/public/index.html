<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>LinkiSend ‚Äî Envoyer des cryptos</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <link rel="manifest" href="/manifest.json">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="/static/assets/icons/icon-maskable-512.png">
<meta name="theme-color" content="#0b0f14">
<link rel="icon" href="/static/assets/icons/icon-maskable-512.png">
  <!-- Flag-icons (CDN) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flag-icons/css/flag-icons.min.css">

  <style>
    :root{--bg:#0b0f14;--bg-soft:#0f141b;--card:#121821;--card-2:#0f1620;--text:#e6edf3;--text-dim:#9fb0c0;--stroke:#1f2a37;--focus:#334155;--shadow:0 12px 40px rgba(0,0,0,.45);--radius:14px;--radius-sm:10px;--gap:12px}
    *,*:before,*:after{box-sizing:border-box}html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif;background:radial-gradient(1200px 600px at 20% -10%,#132034 0%,
    transparent 60%),radial-gradient(900px 500px at 110% 0%,#1a2334 0%,transparent 60%),var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
    .wrap{max-width:420px;margin:40px auto 64px;padding:0 16px}
    .brand {
  display: flex;
  justify-content: center;
  align-items: center;
  margin-bottom: 22px;
  position: relative;
  width: 100%;
}
    .brand img.logo {
  max-width:220px;
  height:auto;
  display:block;
  transform: translateX(-14%);
}
@media (max-width:480px) {
  .brand img.logo {
    max-width:140px;
  }
}
    .card {
  background:linear-gradient(180deg,var(--card),var(--card-2));
  border:1px solid var(--stroke);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:22px 18px;
}
.card h2{margin:4px 2px 2px;font-size:22px;font-weight:750}.sub{color:var(--text-dim);margin:0 2px 14px;font-size:13px}
    .row{display:flex;gap:var(--gap)}.col{flex:1}label{display:block;margin:14px 2px 8px;font-size:13px;color:var(--text-dim)}
    select,input{width:100%;height:44px;padding:10px 12px;border-radius:var(--radius-sm);border:1px solid var(--stroke);background:#0e141c;color:var(--text);outline:none}
    select:focus,input:focus{border-color:var(--focus);box-shadow:0 0 0 3px rgba(51,65,85,.35)}
    .hint {
  font-size:12px;
  color:var(--text-dim);
  margin:8px 2px 2px;
      line-height: 1.4;
}
    .phone-row {
  display: flex;
  gap: 8px;
  align-items: center;
}
    .btn {
  width:100%;
  height:46px;
  border:0;
  border-radius:12px;
  font-weight:700;
  font-size:15px;
  cursor:pointer;
  background:radial-gradient(circle at 20% 20%,#8b5cf6,#06b6d4,#22c55e);
  color:#fff;
  box-shadow:0 10px 24px rgba(34,197,94,.2);
  margin-top:18px;
}
    .btn:hover{box-shadow:0 12px 32px rgba(34,197,94,.28)}.btn:active{transform:translateY(1px)}
    .wallet-link{display:inline-flex;align-items:center;gap:8px;color:#93c5fd;text-decoration:none;font-weight:600;font-size:14px;padding:8px 10px;border-radius:10px;border:1px dashed var(--stroke);background:#0a1220;margin:8px 2px 4px;width:max-content}
    .wallet-link:hover{background:#0d1729}
    .result,.error{margin:14px 2px 0;padding:10px 12px;border-radius:10px;font-size:13px;border:1px solid var(--stroke)}.error{background:#fee2e2;color:#991b1b;border:1px solid #f87171}
    .result-cta{margin:14px 2px 0;padding:16px;border-radius:14px;background:#ecfdf5;border:1px solid #bbf7d0;color:#064e3b;display:none}
    .row-cta{display:flex;gap:10px;align-items:stretch;flex-wrap:wrap}
    .toast{position:fixed;right:16px;bottom:16px;background:#10b981;color:white;padding:10px 14px;border-radius:10px;box-shadow:var(--shadow);opacity:0;transform:translateY(6px);transition:opacity .2s,transform .2s;z-index:60}.toast.show{opacity:1;transform:translateY(0)}
    .-row{display:flex;gap:8px;align-items:center}.dial{position:relative;display:flex}.dial-btn{height:44px;padding:0 10px;border-radius:8px;border:1px solid var(--stroke);background:#0e141c;color:#e6edf3;display:inline-flex;align-items:center;gap:6px;cursor:pointer}
    .dial-btn:hover{background:#0d1729}.dial-panel{position:absolute;left:0;top:44px;z-index:30;width:260px;background:#0d1420;border:1px solid var(--stroke);border-radius:10px;box-shadow:var(--shadow);display:none}
    .dial-head{display:flex;align-items:center;gap:6px;padding:8px 10px;border-bottom:1px solid rgba(255,255,255,.06)}.dial-search-input{flex:1;height:32px;border:1px solid var(--stroke);background:#0e141c;color:#e6edf3;border-radius:8px;padding:0 8px;outline:none}
    .dial-list{max-height:260px;overflow:auto}.dial-item{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.04);cursor:pointer}.dial-item:last-child{border-bottom:0}
    .iso{font-weight:600;color:#e6edf3;width:26px;display:inline-block}.dialcode{color:#cfe1ff}.country{color:#9fb0c0;font-size:12px}
@media (max-width:540px){
  .brand{
    justify-content:center!important;
    gap:10px!important;
    margin:10px 0 20px!important;
    padding:0 8px;
  }
  .brand img.arrow{
    position:static!important;
    transform:none!important;
    max-width:70px!important;
    height:auto!important;
    margin-right:6px;
  }
  .brand img.word{max-width:170px!important}
  .lang-toggle{right:8px!important;font-size:11px;padding:3px 8px}
}
    #installBtn{position:fixed;right:14px;bottom:90px;z-index:80;display:none;align-items:center;gap:8px;padding:10px 14px;border-radius:999px;border:1px solid var(--stroke);background:#0e141c;color:#e6edf3;font-weight:700;cursor:pointer;box-shadow:var(--shadow)}
    #installBtn:active{transform:translateY(1px)}
    #splash{position:fixed;inset:0;z-index:9999;display:grid;place-items:center;background:radial-gradient(1200px 600px at 20% -10%,#132034 0%,transparent 60%),radial-gradient(900px 500px at 110% 0%,#1a2334 0%,transparent 60%),var(--bg);transition:opacity .35s ease}
    #splash img{width:300px;height:auto;filter:drop-shadow(0 12px 30px rgba(0,0,0,.35));opacity:.96}#splash.hide{opacity:0;pointer-events:none}
  
    /* Effet sur üìñ et üíæ */
.emoji-btn {
  display: inline-block;            /* ‚Üê important pour que :hover/transform marchent */
  transition: transform 0.1s ease, opacity 0.1s ease;
  cursor: pointer;
}

/* Survol : l√©ger zoom */
.emoji-btn:hover {
  transform: scale(1.2);
}

/* Clic : bouton enfonc√© */
.emoji-btn:active {
  transform: scale(0.9);
  opacity: 0.7;
}
  .dial-btn img.flag {
  display: inline-block;
  vertical-align: middle;
  margin-top: -1px;
} 
    #title {
  font-size: 20px;
  </style>

  <script>
  document.addEventListener("DOMContentLoaded",function(){
    const s=document.getElementById('splash');if(!s)return;
    const isStandalone=(window.matchMedia&&window.matchMedia('(display-mode: standalone)').matches)||(window.navigator.standalone===true);
    if(isStandalone){s.remove();return}
    let done=false;function hide(){if(done)return;done=true;s.classList.add('hide');setTimeout(()=>s.remove(),400)}
    window.addEventListener('load',hide);setTimeout(hide,1200)
  });
  </script>

  <!-- CONFIG + pays -->
  <script src="config.js"></script>
<script src="countries.js"></script>
  <!-- WalletConnect SignClient v3 + Ethers.js -->
<script src="https://cdn.jsdelivr.net/npm/@walletconnect/sign-client@2.11.2/dist/index.min.js"></script>

<!-- Patch pour exposer SignClient dans la PWA -->
<script>
  if (typeof window.WalletConnectSignClient === "undefined" &&
      window.WalletConnect && window.WalletConnect.SignClient) {
    window.WalletConnectSignClient = window.WalletConnect.SignClient;
  }
</script>

<script src="https://cdn.jsdelivr.net/npm/ethers@6.12.0/dist/ethers.umd.min.js"></script>
</head>
<body>
  
  <script>
const isStandalone =
  window.matchMedia("(display-mode: standalone)").matches ||
  window.navigator.standalone === true;
const isMobile = /android|iphone|ipad|ipod|opera mini|mobile/i.test(
  navigator.userAgent.toLowerCase()
);

if (!isStandalone) {
  document.body.innerHTML = `
    <div style="background:#0b0f14;color:#fff;font-family:Inter,Arial,sans-serif;
    display:flex;align-items:center;justify-content:center;height:100vh;text-align:center;flex-direction:column;">
      <img src="/static/assets/icons/icon-maskable-512.png" alt="LinkiSend" style="width:90px;height:auto;margin-bottom:20px;">
      <h2>Installe l‚Äôapplication LinkiSend</h2>
      <p style="color:#9fb0c0;">Pour utiliser LinkiSend, ajoute-la √† ton √©cran d‚Äôaccueil.</p>
      <button id="installNow" style="margin-top:18px;padding:10px 20px;border-radius:10px;
      border:none;background:#3B82F6;color:#fff;font-weight:700;cursor:pointer;">üì≤ Installer</button>
    </div>
  `;

  let deferredPrompt;
  window.addEventListener("beforeinstallprompt", (e) => {
    e.preventDefault();
    deferredPrompt = e;
  });

  document.getElementById("installNow").onclick = async () => {
    if (deferredPrompt) {
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      if (outcome === "accepted") location.reload();
    } else {
      alert("Utilise le menu de ton navigateur pour 'Ajouter √† l‚Äô√©cran d‚Äôaccueil'");
    }
  };

  throw new Error("PWA install prompt screen displayed");
}
</script>
  <div class="wrap">
    <div class="brand">
      <img src="/assets/branding/logo.svg" alt="LinkiSend" class="logo" style="max-width:180px;height:auto;">
      <!-- S√©lecteur de langue (globe) -->
<div class="lang-menu" style="position:absolute;right:0;top:0;z-index:12;">
  <button id="langBtn" aria-haspopup="listbox" aria-expanded="false" title="Language"
          style="display:inline-flex;align-items:center;gap:6px;border:1px solid var(--stroke);background:#0e141c;color:#9fb0c0;border-radius:999px;height:28px;padding:0 10px;cursor:pointer;">
    üåê
  </button>
  <div id="langMenu" role="listbox"
     style="display:none;position:absolute;right:0;top:36px;min-width:260px;background:#0d1420;border:1px solid var(--stroke);border-radius:10px;box-shadow:var(--shadow);padding:8px;z-index:20;">

  <!-- Grille responsive : 1 colonne mobile, 2 colonnes desktop -->
  <style>
    /* scope local au menu */
    #langMenu .lang-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 6px;
    }
    @media (min-width: 520px) {
      #langMenu .lang-grid { grid-template-columns: 1fr 1fr; }
    }
    #langMenu .lang-btn {
      width: 100%;
      text-align: left;
      padding: 8px 10px;
      background: #0e141c;
      color: #e6edf3;
      border: 1px solid var(--stroke);
      border-radius: 8px;
      cursor: pointer;
    }
    #langMenu .lang-btn:hover { background:#0d1729; }
  </style>

  <div class="lang-grid">
  <button data-lang="ar" class="lang-btn" role="option">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</button>
  <button data-lang="zh" class="lang-btn" role="option">‰∏≠Êñá</button>
  <button data-lang="de" class="lang-btn" role="option">Deutsch</button>
  <button data-lang="en" class="lang-btn" role="option">English</button>
  <button data-lang="es" class="lang-btn" role="option">Espa√±ol</button>
  <button data-lang="fr" class="lang-btn" role="option">Fran√ßais</button>
  <button data-lang="hi" class="lang-btn" role="option">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</button>
  <button data-lang="it" class="lang-btn" role="option">Italiano</button>
  <button data-lang="pt" class="lang-btn" role="option">Portugu√™s</button>
  <button data-lang="ru" class="lang-btn" role="option">–†—É—Å—Å–∫–∏–π</button>
  </div>
</div>
</div>
</div>
    <div class="card" role="region" aria-label="Formulaire d‚Äôenvoi">
      <h2 id="title">Envoyer des cryptos</h2>
      <p class="sub" id="subtitle">G√©n√®re un lien en 10&nbsp;secondes.</p>

      <label for="wallet" id="lbl-wallet">Ton wallet (exp√©diteur)</label>
      <input type="text" id="wallet" placeholder="Connecte ton wallet" autocomplete="off" disabled style="opacity:0.6; cursor:not-allowed;" />
      <button id="walletConnectBtn" class="wallet-link" style="gap:6px;cursor:pointer;">
  <img src="/assets/wallets/walletconnect.svg" alt="WalletConnect" width="20" height="20" style="display:inline-block;vertical-align:middle;">
  <span>WalletConnect</span>
</button>
      <div class="row">
        <div class="col">
          <label for="currency" id="lbl-token">Token</label>
<select id="currency"></select>
        </div>
        <div class="col">
          <label for="amount" id="lbl-amount">Montant</label>
          <input type="number" id="amount" inputmode="decimal" min="0" step="0.00001" placeholder="0.00" />
          <p id="usdValue" class="hint">‚âà 0.00 $ (index√© sur CoinGecko)</p>
</span>
        </div>
      </div>
      <label id="lbl-phone">Num√©ro du destinataire</label>
      <div class="phone-row">
        <div class="dial">
          <button id="dialBtn" class="dial-btn">
  <span class="fi fi-fr" style="width:18px;height:12px;border-radius:2px;object-fit:cover;margin-right:4px;display:inline-block"></span>
  <span id="dialCode">+33</span>
</button>
          <div id="dialPanel" class="dial-panel">
            <div class="dial-head"><input id="dialSearch" class="dial-search-input" placeholder="Rechercher..."/></div>
            <div id="dialList" class="dial-list"></div>
          </div>
        </div>
        <input type="text" id="phone" placeholder="612345678" inputmode="tel"/>
      </div>

       <div class="contact-actions" style="margin-top:16px; display:flex; align-items:center; gap:8px; cursor:pointer;" id="openContactsArea">
  <span class="emoji-btn" title="Ouvrir mes contacts">üìñ</span>
  <span style="font-size:13px; color:var(--text-dim);">Ouvrir mes contacts</span>
</div>

<script>
document.getElementById('openContactsArea').addEventListener('click', async () => {
  if ('contacts' in navigator && 'select' in navigator.contacts) {
    try {
      const contacts = await navigator.contacts.select(['name', 'tel'], { multiple: false });
      if (contacts.length > 0) {
        const phoneInput = document.getElementById('phone');
        const dialBtn = document.getElementById('dialBtn');
        const dialCodeSpan = document.getElementById('dialCode');
        const telField =
          contacts[0].tel?.[0]?.number ||
          contacts[0].tel?.[0] ||
          contacts[0].tel ||
          "";

        if (phoneInput && telField) {
          const raw = String(telField).trim();
          let clean = raw.replace(/[\s()-]/g, "");

          // normalise 00 ‚Üí +
          if (clean.startsWith("00")) clean = "+" + clean.slice(2);

          let detectedCode = "";
          let detectedIso = "";
          let national = clean;

          if (clean.startsWith("+") && Array.isArray(COUNTRIES)) {
            const digits = clean.slice(1);
            const codes = COUNTRIES.map(c => (c.code || "").replace("+", "")).filter(Boolean);
            let best = "";
            for (const code of codes) {
              if (digits.startsWith(code) && code.length > best.length) best = code;
            }
            if (best) {
              detectedCode = "+" + best;
              const country = COUNTRIES.find(c => c.code === detectedCode);
              detectedIso = country ? country.iso : "";
              national = digits.slice(best.length);
            } else {
              national = digits;
            }
          } else {
            // aucun indicatif d√©tect√©
            national = clean.replace(/[^\d]/g, "");
          }

          // ‚úÖ Mise √† jour du champ num√©ro
          phoneInput.value = national;

          // ‚úÖ Mise √† jour du drapeau et de l‚Äôindicatif LinkiSend
          if (detectedCode && detectedIso && dialBtn && dialCodeSpan) {
            dialCodeSpan.textContent = detectedCode;
            dialBtn.innerHTML =
              `<span class="fi fi-${detectedIso.toLowerCase()}"
                    style="width:18px;height:12px;border-radius:2px;object-fit:cover;display:inline-block;margin-right:6px;"></span>
               <span id="dialCode">${detectedCode}</span>`;
          }
        }
      }
    } catch (err) {
      alert("Impossible d'acc√©der aux contacts : " + err.message);
    }
  } else {
    alert("Cette fonction n‚Äôest pas disponible sur ton appareil ou navigateur.");
  }
});
</script>
      <div class="contacts" id="contactsList"></div>

      <button id="generateBtn" class="btn">G√©n√©rer le lien</button>
      <p class="hint" id="hint">Aucun transfert on-chain n‚Äôest effectu√© tant que le lien n‚Äôest pas r√©clam√©.</p>

      <div id="result" class="result-cta" aria-live="polite">
        <h3 id="resultTitle" style="margin:0 0 10px;font-size:18px;">Lien pr√™t ‚úÖ</h3>
        <div class="row-cta" style="display:inline-flex;align-items:center;">
          <code id="the-link"></code>
          <span id="copyLinkBtn" style="cursor:pointer;margin-left:4px;" title="Copier">üìã</span>
        </div>
        <div class="sub-cta" id="validityText" style="margin-top:10px;">
          ‚è≥ Validit√© : 24h ‚Ä¢ Aucun transfert on-chain n‚Äôa lieu tant que le lien n‚Äôest pas r√©clam√©.
        </div>
      </div>

      <div id="error" class="error" style="display:none"></div>
    </div>
  </div>

  <div class="toast" id="toast">Lien copi√© ‚úÖ</div>

  <script>
    let currencySel;
    const BACKEND = `${location.protocol}//${location.hostname}`;
  document.addEventListener('DOMContentLoaded', ()=> {
    const resultDiv=document.getElementById('result');
    const errorDiv=document.getElementById('error');
    const walletInput=document.getElementById('wallet');
    // === Initialisation anticip√©e de WalletConnect SignClient ===
let wcReady = false;
let signClient;

(async () => {
  try {
    signClient = await window.WalletConnectSignClient.init({
      projectId: "9c945cd5bef5c1e1905266cf0219736d",
      metadata: {
        name: "LinkiSend",
        description: "Envoyer des cryptos via lien s√©curis√©",
        url: "https://linkisend.io",
        icons: ["https://linkisend.io/static/assets/icons/icon-maskable-512.png"],
      },
    });
    window.LinkiSend = window.LinkiSend || {};
    window.LinkiSend.signClient = signClient;
    wcReady = true;
    console.log("‚úÖ WalletConnect pr√™t d√®s le chargement");
    // === Reconnexion automatique si session sauvegard√©e ===
try {
  const sessions = signClient.session.getAll();
  if (sessions.length > 0) {
    const lastSession = sessions[sessions.length - 1];
    console.log("üîÑ Reprise de session WalletConnect", lastSession);
    window.LinkiSend.session = lastSession;

    // Si tu veux afficher l'adresse connect√©e automatiquement :
    const accounts = lastSession.namespaces.eip155.accounts;
    const addr = accounts[0].split(":")[2];
    const wcBtn = document.getElementById("walletConnectBtn");
    wcBtn.querySelector("span").textContent = addr.slice(0, 6) + "..." + addr.slice(-4);
    wcBtn.disabled = true;
    wcBtn.style.opacity = "1";
  }
} catch (e) {
  console.warn("Aucune session √† reprendre ou erreur WalletConnect:", e);
}
  } catch (err) {
    console.error("Erreur init WalletConnect:", err);
  }
})();

const wcBtn = document.getElementById("walletConnectBtn");

if (wcBtn && walletInput) {
  wcBtn.addEventListener("click", async () => {
    wcBtn.disabled = true;
wcBtn.style.opacity = "0.6";
wcBtn.querySelector("span").textContent = "Connexion...";

// attend que SignClient soit pr√™t (max 3 s)
let waited = 0;
while (!wcReady && waited < 3000) {
  await new Promise(r => setTimeout(r, 200));
  waited += 200;
}

if (!signClient) {
  alert("WalletConnect non pr√™t. R√©essaie dans quelques secondes.");
  wcBtn.disabled = false;
  wcBtn.style.opacity = "1";
  wcBtn.querySelector("span").textContent = "WalletConnect";
  return;
}
    try {

      // 2Ô∏è‚É£ Demande de connexion (ouvre directement le wallet mobile)
      const { uri, approval } = await signClient.connect({
        requiredNamespaces: {
          eip155: {
            methods: ["eth_sendTransaction", "personal_sign", "eth_signTypedData"],
            chains: ["eip155:1", "eip155:56", "eip155:137", "eip155:43114"],
            events: ["accountsChanged", "chainChanged"],
          },
        },
      });

      if (uri) {
        // Deep-link WalletConnect ‚Üí ouverture du wallet mobile
        window.open(`wc:${uri}`, "_blank");
      }

      // 3Ô∏è‚É£ Attente approbation utilisateur
      const session = await approval();
      if (!session || !session.namespaces.eip155) throw new Error("Session invalide");

      // 4Ô∏è‚É£ R√©cup√®re l‚Äôadresse principale
      const accounts = session.namespaces.eip155.accounts;
      const address = accounts[0].split(":")[2];
      walletInput.value = address;

      // 5Ô∏è‚É£ Initialisation du provider Ethers li√© √† WalletConnect
      const ethersProvider = new ethers.BrowserProvider({
        request: async (payload) => await signClient.request(payload),
      });

      window.LinkiSend = { signClient, ethersProvider, session };

      wcBtn.disabled = false;
      wcBtn.style.opacity = "1";
      wcBtn.querySelector("span").textContent = "WalletConnect";
      alert("‚úÖ Connect√© : " + address);
    } catch (err) {
      console.error("Erreur connexion WC:", err);
      alert("Erreur WalletConnect : " + (err.message || "inconnue"));
      wcBtn.disabled = false;
      wcBtn.style.opacity = "1";
      wcBtn.querySelector("span").textContent = "WalletConnect";
    }
  });
}
    currencySel = document.getElementById('currency');
    const linkEl=document.getElementById('the-link');
    const dialBtn=document.getElementById('dialBtn');
    const dialPanel=document.getElementById('dialPanel');
    const dialSearch=document.getElementById('dialSearch');
    const dialList=document.getElementById('dialList');
    dialSearch.addEventListener("input", () => {
  renderDialList(dialSearch.value.toLowerCase());
  dialList.scrollTop = 0; // pour que la liste remonte en haut
});

    // Ouvrir/fermer le panneau des indicatifs quand on clique sur le bouton
dialBtn.addEventListener("click", (e) => {
  e.stopPropagation(); // √©viter que le clic ferme le panneau directement
  dialPanel.style.display = dialPanel.style.display === "block" ? "none" : "block";
  if (dialPanel.style.display === "block") {
    renderDialList(""); // afficher la liste compl√®te des pays
    dialSearch.value = ""; // reset de la recherche
    dialSearch.focus(); // focus dans la barre de recherche
  }
});
    let currentDial={iso:"FR",code:"+33"};
    let saveNameInput, saveConfirmBtn, saveCancelBtn;
    const userPref=localStorage.getItem('lang');let lang=userPref||((navigator.language||'fr').toLowerCase().startsWith('fr')?'fr':'en');
    // --- Chargement des traductions depuis les fichiers JSON ---
let translations = {};
    // --- Chargement i18n (multi-langues) ---
const SUPPORTED_LANGS = ['fr','en','es','pt','de','it','ar','zh','hi','ru'];

Promise.allSettled(
  SUPPORTED_LANGS.map(code =>
    fetch(`/static/lang/${code}.json`, { cache: 'no-store' })
      .then(r => r.ok ? r.json() : Promise.reject(code))
      .then(json => [code, json])
  )
).then(results => {
  //  l'objet translations uniquement avec les langues charg√©es avec succ√®s
  translations = results.reduce((acc, res) => {
    if (res.status === 'fulfilled') {
      const [code, json] = res.value;
      acc[code] = json;
    } else {
      console.warn('[i18n] Fichier manquant ou invalide :', res.reason);
    }
    return acc;
  }, {});
// === Forcer l'affichage du bouton "Installer" si la PWA n'est pas install√©e ===
window.addEventListener("load", () => {
  const isStandalone = window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone === true;
  const btn = document.getElementById("installBtn");
  if (!isStandalone && btn) {
    btn.style.display = "inline-flex";
  }
});

  applyLang(); // applique selon la variable 'lang' d√©j√† g√©r√©e (localStorage / navigateur)
}).catch(err => {
  console.error('i18n_load_failed:', err);
  translations = {};
  applyLang();
});
    function applyLang() {
  if (!translations || !translations[lang]) return;
  const tr = translations[lang];

  // Petite fonction utilitaire pour √©viter les erreurs
  const setText = (id, value) => {
    const el = document.getElementById(id);
    if (el && value !== undefined) el.textContent = value;
  };

  setText("title", tr.title);
  setText("subtitle", tr.subtitle);
  setText("lbl-wallet", tr.wallet);
  setText("lbl-token", tr.token);
  setText("lbl-amount", tr.amount);
  setText("lbl-phone", tr.phone);
  setText("hint", tr.hint);
  setText("generateBtn", tr.generate);
  setText("connectWalletLink", tr.connectWallet);
  setText("dialSearch", tr.search);
  setText("resultTitle", tr.resultTitle);
  setText("validityText", tr.validity);

  if (saveNameInput)  saveNameInput.placeholder = tr.savePh || '';
  if (saveConfirmBtn) saveConfirmBtn.textContent = `‚úÖ ${tr.save || 'Save'}`;
  if (saveCancelBtn)  saveCancelBtn.textContent  = `‚úñÔ∏è ${tr.cancel || 'Cancel'}`;
}
   if (dialPanel.style.display === 'block') {
  renderDialList(dialSearch.value.toLowerCase());
}    
    // --- Globe + menu langues ---
const langBtn  = document.getElementById('langBtn');
const langMenu = document.getElementById('langMenu');

function closeLangMenuOnOutside(e){
  if (!langMenu.contains(e.target) && !langBtn.contains(e.target)){
    langMenu.style.display = 'none';
    langBtn.setAttribute('aria-expanded','false');
    document.removeEventListener('click', closeLangMenuOnOutside);
  }
}

if (langBtn && langMenu){
  langBtn.addEventListener('click', (e)=>{
    e.stopPropagation();
    const open = langMenu.style.display === 'block';
    langMenu.style.display = open ? 'none' : 'block';
    langBtn.setAttribute('aria-expanded', String(!open));
    if (!open) document.addEventListener('click', closeLangMenuOnOutside);
  });

  langMenu.querySelectorAll('button[data-lang]').forEach(b=>{
    b.addEventListener('click', ()=>{
      lang = b.dataset.lang;               // variable lang d√©j√† existante dans ton code
      localStorage.setItem('lang', lang);
      applyLang();
      langMenu.style.display = 'none';
      langBtn.setAttribute('aria-expanded','false');
    });
  });
}
    function getWcGlobal(){
      const mod=window['@walletconnect/ethereum-provider'];
      if(mod&&(mod.EthereumProvider?.init||mod.default?.EthereumProvider?.init)){return mod.EthereumProvider||mod.default.EthereumProvider}
      return window.EthereumProvider||window.WalletConnectEthereumProvider||(window.WalletConnectProvider&&(window.WalletConnectProvider.init?window.WalletConnectProvider:window.WalletConnectProvider.default))||(window.WalletConnect&&window.WalletConnect.EthereumProvider)
    }

    async function loadWalletConnectProvider(){
      try{await window.__wcProviderBootstrap}catch{} // attend le bootstrap local/CDN
      let EP=getWcGlobal(); if(EP) return EP;
      const umd=["https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider@2/dist/index.umd.js","https://unpkg.com/@walletconnect/ethereum-provider@2/dist/index.umd.js"];
      for(const u of umd){try{await loadScript(u+"?v="+Date.now());EP=getWcGlobal();if(EP)return EP}catch{}}
      return null;
    }

    function renderDialList(f = "") {
  dialList.innerHTML = "";
  const filter = (f || "").toLowerCase();
  const normFilter = filter.replace(/^\+/, "");


  COUNTRIES
    .filter(d =>
      !filter ||
      d.en.toLowerCase().includes(filter) ||
      d.fr.toLowerCase().includes(filter) ||
      d.code.replace("+","").includes(normFilter) ||
      d.iso.toLowerCase().includes(filter)
    )
    .sort((a, b) => {
  // si l'indicatif commence exactement par la recherche ‚Üí priorit√©
  if (a.code.startsWith(filter) && !b.code.startsWith(filter)) return -1;
  if (!a.code.startsWith(filter) && b.code.startsWith(filter)) return 1;
  // sinon tri alphab√©tique des codes (ou des noms)
  return a.code.localeCompare(b.code);
})
    .forEach(d => {
      const name = (lang === "fr") ? d.fr : d.en;
      const row = document.createElement("div");
      row.className = "dial-item";

      row.innerHTML = `
        <span class="fi fi-${d.iso.toLowerCase()}"
              style="width:18px;height:12px;border-radius:2px;object-fit:cover;display:inline-block"></span>
        <span class="dialcode">${d.code}</span>
        <span class="country">${name}</span>
      `;

      row.onclick = () => {
        currentDial = { iso: d.iso, code: d.code };
        dialBtn.innerHTML =
          `<span class="fi fi-${d.iso.toLowerCase()}"
                  style="width:18px;height:12px;border-radius:2px;object-fit:cover;display:inline-block;margin-right:6px;"></span>
           <span id="dialCode">${d.code}</span>`;
        dialPanel.style.display = "none";
      };

      dialList.appendChild(row);
    });
}

// Fermer le panneau quand on clique ailleurs (en dehors de la fonction)
    document.addEventListener("click",e=>{if(!dialPanel.contains(e.target)&&!dialBtn.contains(e.target)){dialPanel.style.display="none"}});
    const actionsBar=document.querySelector('.contact-actions');const saveInline=document.createElement('div');saveInline.style.display='none';saveInline.style.marginTop='8px';
    saveInline.style.padding='10px';saveInline.style.border='1px solid var(--stroke)';saveInline.style.borderRadius='8px';saveInline.style.background='#0e1420';saveInline.style.boxShadow='var(--shadow)';
    saveInline.style.gap='8px';saveInline.style.alignItems='center';saveInline.style.justifyContent='space-between';
    saveNameInput = document.createElement('input');saveNameInput.type='text';saveNameInput.id='saveName';saveNameInput.placeholder = '';saveNameInput.style.width='100%';
    saveNameInput.style.padding='8px 10px';saveNameInput.style.border='1px solid var(--stroke)';saveNameInput.style.borderRadius='6px';saveNameInput.style.background='#0a1220';saveNameInput.style.color='#e6edf3';
    saveNameInput.style.marginRight='8px';
    const btnsWrap=document.createElement('div');btnsWrap.style.display='flex';btnsWrap.style.gap='8px';btnsWrap.style.marginTop='8px';
  saveConfirmBtn=document.createElement('button');saveConfirmBtn.textContent = '‚úÖ';saveConfirmBtn.style.border='1px solid var(--stroke)';
    saveConfirmBtn.style.background='#0a1220';saveConfirmBtn.style.color='#ffffff';saveConfirmBtn.style.borderRadius='8px';saveConfirmBtn.style.padding='6px 10px';saveConfirmBtn.style.cursor='pointer';
    saveCancelBtn = document.createElement('button');
saveCancelBtn.type = 'button';
saveCancelBtn.textContent = '‚ùå';
saveCancelBtn.style.border = '1px solid var(--stroke)';
    saveCancelBtn.style.background='#0a1220';saveCancelBtn.style.color='#ffffff';saveCancelBtn.style.borderRadius='8px';saveCancelBtn.style.padding='6px 10px';saveCancelBtn.style.cursor='pointer';
    saveInline.appendChild(saveNameInput);btnsWrap.appendChild(saveConfirmBtn);btnsWrap.appendChild(saveCancelBtn);saveInline.appendChild(btnsWrap);actionsBar.insertAdjacentElement('afterend',saveInline);
    function toggleSaveInline(open){saveInline.style.display=open?'block':'none';if(open){saveNameInput.value='';saveNameInput.focus()}}
    document.getElementById('generateBtn').addEventListener('click',async()=>{
      const amount=parseFloat(document.getElementById('amount').value);
      const currency=document.getElementById('currency').value;
      const sender_wallet=walletInput.value.trim();
      const localPhone=document.getElementById('phone').value.trim();
      const recipient_phone=`${currentDial.code}${localPhone}`;
      resultDiv.style.display='none';errorDiv.style.display='none';
      if (!sender_wallet && amount && currency && localPhone) {
  errorDiv.textContent = "Wallet non connect√©";
  errorDiv.style.display = "block";
  return;
}
      if (!localPhone && amount && currency && sender_wallet) {
  errorDiv.textContent = "Aucun num√©ro s√©lectionn√©";
  errorDiv.style.display = "block";
  return;
}
      if(!amount||!currency||!sender_wallet||!localPhone){errorDiv.textContent=(lang==='fr')?"Merci de remplir tous les champs obligatoires.":"Please fill in all required fields.";
      errorDiv.style.display='block';return}
      if (isNaN(amount) || amount <= 0) { errorDiv.textContent = "Montant incorrect"; errorDiv.style.display = "block"; return; }
      // V√©rifie que le wallet contient bien des fonds
const selOpt = currencySel.options[currencySel.selectedIndex];
let balanceNum = 0;
if (selOpt) {
  // Exemple d'option : "USDC ‚Äî 117.91809"
  const txt = selOpt.textContent || "";
  const parts = txt.split("‚Äî");
  if (parts.length > 1) {
    const raw = parts[1].trim().replace(",", ".");
    balanceNum = parseFloat(raw);
  }
}

if (!balanceNum || isNaN(balanceNum) || balanceNum <= 0) {
  errorDiv.textContent =
    translations?.[lang]?.noBalance ||
    (lang === "fr"
      ? "Solde insuffisant pour g√©n√©rer un lien."
      : "Insufficient balance to generate a link.");
  errorDiv.style.display = "block";
  return;
}
      try{
        const res=await fetch(`${BACKEND}/create-link`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({amount,currency,sender_wallet,recipient_phone})});
        const data=await res.json();if(!res.ok)throw new Error(data.detail||"Erreur lors de la g√©n√©ration du lien");
        const lien=`https://linkisend.io/${data.short_id}`;linkEl.textContent=lien;resultDiv.style.display='block';
      }catch(err){errorDiv.textContent=err.message||(lang==='fr'?'Erreur r√©seau':'Network error');errorDiv.style.display='block'}
    });

    const copyBtn=document.getElementById('copyLinkBtn');if(copyBtn){copyBtn.addEventListener('click',()=>{navigator.clipboard.writeText(linkEl.textContent).then(()=>{copyBtn.textContent="‚úÖ";setTimeout(()=>copyBtn.textContent="üìã",1500)})})}

    if("serviceWorker" in navigator){navigator.serviceWorker.register("/service-worker.js").then(()=>console.log("SW enregistr√© ‚úÖ")).catch(err=>console.error("SW erreur:",err))}
    let deferredPrompt=null;window.addEventListener('beforeinstallprompt',(e)=>{e.preventDefault();deferredPrompt=e;const b=document.getElementById('installBtn');if(b)b.style.display='inline-flex'});
    document.getElementById('installBtn').addEventListener('click',async()=>{if(!deferredPrompt)return;deferredPrompt.prompt();await deferredPrompt.userChoice;deferredPrompt=null;document.getElementById('installBtn').style.display='none'});
    window.addEventListener('appinstalled',()=>{const b=document.getElementById('installBtn');if(b)b.style.display='none'});
    applyLang();
  });
  </script>

  <button id="installBtn" aria-label="Installer l‚Äôapplication">üì≤ Installer</button>
  <script>
// Mapping entre symboles et IDs CoinGecko
const COINGECKO_IDS = {
  ETH: "ethereum",
  BNB: "binancecoin",
  MATIC: "matic-network",
  AVAX: "avalanche-2",
  SOL: "solana",
  USDT: "tether",
  USDC: "usd-coin",
  DAI: "dai",
  WBTC: "wrapped-bitcoin",
  LINK: "chainlink",
  BONK: "bonk",
  RAY: "raydium"
};

async function updateUsdValue(){
  const amountEl = document.getElementById("amount");
  const tokenEl  = document.getElementById("currency");
  const usdEl    = document.getElementById("usdValue");

  if (!amountEl || !tokenEl || !usdEl) return;

  const amount = parseFloat(amountEl.value);
const raw = tokenEl.value;
const sym = raw.split("‚Äî")[0].trim();
const id = COINGECKO_IDS[sym];

  if (!amount || !id){
    usdEl.textContent = "‚âà 0.00 $ (index√© sur CoinGecko)";
    return;
  }

  try {
    const url = `${BACKEND}/price?symbol=${sym}`;
    const res = await fetch(url);
    const data = await res.json();
    const price = data.usd;
    const usdVal = (amount * price).toFixed(2);
    usdEl.textContent = `‚âà ${usdVal} $ (index√© sur CoinGecko)`;
  } catch(e){
    console.error("Erreur CoinGecko", e);
    usdEl.textContent = "(Erreur CoinGecko)";
  }
}

// Mettre √† jour quand on change le montant ou le token
document.getElementById("amount")?.addEventListener("input", updateUsdValue);
document.getElementById("currency")?.addEventListener("change", updateUsdValue);
</script>
  <script>
/* Fermer la liste de contacts par d√©faut et ne l‚Äôouvrir que via üìñ */
document.addEventListener('DOMContentLoaded', () => {
  const box = document.getElementById('contactsList');
  const btn = document.getElementById('showContacts');
  if (!box) return;

  // 1) Toujours cach√© au chargement, m√™me s'il y a des contacts
  box.style.display = 'none';

  // 2) Ouvrir/fermer uniquement via le bouton üìñ
  if (btn) {
    btn.onclick = () => {
      box.style.display = (box.style.display === 'block') ? 'none' : 'block';
    };
  }
});
</script>
  <!-- ====== LINKISEND: START SCANNER INTERNE (EVM + SOL) ====== -->
<script>
(function(){
  walletInput.value = '';
  const currencySel = document.getElementById('currency');

  /* --- Prix CoinGecko pour la ligne ‚Äú‚âà $‚Äù sous Token --- */
  const CG_ID = {
    ETH:'ethereum', BNB:'binancecoin', MATIC:'matic-network', AVAX:'avalanche-2', SOL:'solana',
    USDT:'tether', USDC:'usd-coin', DAI:'dai', WBTC:'wrapped-bitcoin', LINK:'chainlink',
    BONK:'bonk', RAY:'raydium'
  };
  async function setBalanceLine(symbol, amountStr){
  try{
    const id = CG_ID[symbol];
    if (!id){ 
      balInfoEl.textContent = ""; // rien en dessous si pas de prix
      return; 
    }
    const r = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${id}&vs_currencies=usd`);
    const j = await r.json();
    const p = j?.[id]?.usd;
    if (typeof p !== 'number'){ 
      balInfoEl.textContent = ""; 
      return; 
    }

    const usd = parseFloat(amountStr || "0") * p;
    balInfoEl.textContent = usd < 0.01 
      ? "‚âà < 0.01 $" 
      : `‚âà ${usd.toFixed(2)} $`;

  }catch{
    balInfoEl.textContent = "";
  }
}
  currencySel.addEventListener('change', ()=>{
    const opt = currencySel.options[currencySel.selectedIndex];
    if (!opt) return;
    const sym = opt.value;
    const amountStr = (opt.textContent || '').split(/‚Äî|‚Äì|-/).pop().trim();

    setBalanceLine(sym, amountStr);
  });

  /* --- Outils EVM --- */
  function toDecimalString(hexOrStr, decimals){
    if (hexOrStr == null) return "0";
    let big;
    if (typeof hexOrStr === "string" && hexOrStr.startsWith("0x")) big = BigInt(hexOrStr);
    else big = BigInt(String(hexOrStr));
    const d = BigInt(decimals);
    const base = 10n ** d;
    const intPart = big / base;
    const frac = big % base;
    if (frac === 0n) return intPart.toString();
    return `${intPart}.${frac.toString().padStart(Number(d),'0')}`.replace(/0+$/,'');
  }
  function erc20BalanceOfData(owner){
    return '0x70a08231' + owner.replace(/^0x/,'').padStart(64,'0');
  }
  function setSelect(items){
  const prev = currencySel.value;
  currencySel.innerHTML = '';
  items.forEach(it=>{
    const o = document.createElement('option');
    o.value = it.symbol;
    // ‚úÖ on s√©curise ici : si amountStr n‚Äôest pas un nombre ‚Üí 0
    const num = parseFloat(it.amountStr);
    const safe = isNaN(num) ? 0 : num;
    o.textContent = `${it.symbol} ‚Äî ${safe.toFixed(5)}`;
    currencySel.appendChild(o);
  });
  if (items.some(i=>i.symbol===prev)) currencySel.value = prev;
}

  /* --- Registres supports (mainnets) --- */
  const EVM = {
    '0x1': { native:{symbol:'ETH',dec:18}, tokens:{
      USDT:{addr:'0xdAC17F958D2ee523a2206206994597C13D831ec7',dec:6},
      USDC:{addr:'0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606EB48',dec:6},
      DAI :{addr:'0x6B175474E89094C44Da98b954EedeAC495271d0F',dec:18},
      WBTC:{addr:'0x2260FAC5E5542a773Aa44fBCfeDf7C193bc2C599',dec:8},
      LINK:{addr:'0x514910771AF9Ca656af840dff83E8264EcF986CA',dec:18}
    }},
    '0x38': { native:{symbol:'BNB',dec:18}, tokens:{
      USDT:{addr:'0x55d398326f99059Ff775485246999027B3197955',dec:18},
      USDC:{addr:'0x8ac76a51cc950d9822d68b83fe1ad97b32cd580d',dec:18},
      DAI :{addr:'0x1AF3F329e8BE154074D8769D1FFa4eE058B1DBc3',dec:18},
      WBTC:{addr:'0x7130d2A12B9BCbFAe4f2634d864A1Ee1Ce3Ead9c',dec:18},
      LINK:{addr:'0xF8A0BF9cF54Bb92F17374d9e9A321E6a111a51bD',dec:18}
    }},
    '0x89': { native:{symbol:'MATIC',dec:18}, tokens:{
      USDT:{addr:'0xC2132D05D31c914a87C6611C10748AaCbD9b0f',dec:6},
      USDC:{addr:'0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174',dec:6},
      DAI :{addr:'0x8f3Cf7ad23Cd3CaDbD9735AFf958023239c6A063',dec:18},
      WBTC:{addr:'0x1BFD67037B42Cf73acF2047067bd4F2C47D9BfD6',dec:8},
      LINK:{addr:'0x53E0bca35eC356BD5ddDFebbD1Fc0fD03Fabad39',dec:18}
    }},
    '0xa86a': { native:{symbol:'AVAX',dec:18}, tokens:{
      USDT:{addr:'0x9702230A8Ea53601f5cD2dc00fDBc13d4dF4A8c7',dec:6},
      USDC:{addr:'0xB97EF9Ef8734C71904D8002F8b6Bc66Dd9c48a6E',dec:6},
      DAI :{addr:'0xd586E7F844cEa2F87f50152665BCbc2C279D8d70',dec:18},
      WBTC:{addr:'0x50b7545627a5162F82A992c33b87aDc75187B218',dec:8},
      LINK:{addr:'0x5947BB275c521040051D82396192181b413227A3',dec:18}
    }}
  };
  const NATIVE_FALLBACK = { // pour testnets ou r√©seau non mapp√© ‚Üí on montre au moins le natif
    '0x1':'ETH','0x5':'ETH','0xaa36a7':'ETH',
    '0x38':'BNB','0x61':'BNB',
    '0x89':'MATIC','0x13881':'MATIC',
    '0xa86a':'AVAX','0xa869':'AVAX'
  };
  const DEFAULT_EVM_TOKENS = ['USDT','USDC','DAI','WBTC','LINK'];

  async function scanEvm(eth, account){
  window.scanEvm = scanEvm;
  let chainId;
  try{ chainId = await eth.request({method:'eth_chainId'}); }catch{ chainId = undefined; }

    const reg = chainId ? EVM[chainId] : undefined;
    const items = [];

    // Natif
    let natSymbol = (chainId && (reg?.native?.symbol || NATIVE_FALLBACK[chainId])) || 'ETH';
    let natDec    = (reg?.native?.dec) ?? 18;
    let nativeHex = '0x0';
    try{ nativeHex = await eth.request({method:'eth_getBalance', params:[account,'latest']}); }catch{}
    const natStr = toDecimalString(nativeHex, natDec);
    items.push({symbol:natSymbol, amountStr:natStr, amountNum:parseFloat(natStr||'0')});

    // ERC20 (soit adresses connues du r√©seau, soit tokens par d√©faut √† 0 si r√©seau inconnu)
    if (reg){
      const data = erc20BalanceOfData(account);
      for (const [sym,tok] of Object.entries(reg.tokens)){
        try{
          const hex = await eth.request({method:'eth_call', params:[{to:tok.addr,data},'latest']});
          const str = toDecimalString(hex, tok.dec);
          items.push({symbol:sym, amountStr:str, amountNum:parseFloat(str||'0')});
        }catch{
          items.push({symbol:sym, amountStr:'0', amountNum:0});
        }
      }
    } else {
      for (const sym of DEFAULT_EVM_TOKENS){
        items.push({symbol:sym, amountStr:'0', amountNum:0});
      }
    }

    items.sort((a,b)=> b.amountNum - a.amountNum);
    setSelect(items);
    const first = items[0]; if (first) setBalanceLine(first.symbol, first.amountStr);
  }

  /* --- Solana (SOL + quelques SPL connus) --- */
  const SOLANA_RPC = "https://api.mainnet-beta.solana.com";
  const TOKEN_PROGRAM_ID = "TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA";
  const SOLANA = {
    native:{symbol:'SOL',dec:9},
    tokens:{
      USDC:{mint:'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v',dec:6},
      USDT:{mint:'Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB',dec:6},
      BONK:{mint:'DezXAZ8z7PnrnRJjz3wXBoRgixCa6xjnB7YaB1pPB263',dec:5},
      RAY :{mint:'4k3Dyjzvzp8eMZWUXbBCaJXipqAVCbi6y5b9VPVuyV7y',dec:6}
    }
  };
  async function solanaRpc(body){
    const r = await fetch(SOLANA_RPC,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    return r.json();
  }
  async function scanSolana(address){
    const items = [];

    // SOL
    let lamports = 0;
    try{
      const r = await solanaRpc({jsonrpc:"2.0", id:1, method:"getBalance", params:[address]});
      lamports = r?.result?.value || 0;
    }catch{}
    const solStr = (lamports/1e9).toString();
    items.push({symbol:'SOL', amountStr:solStr, amountNum:parseFloat(solStr||'0')});

    // Comptes SPL de l‚Äôadresse
    let accs = [];
    try{
      const r = await solanaRpc({
        jsonrpc:"2.0", id:2, method:"getTokenAccountsByOwner",
        params:[address, { programId: TOKEN_PROGRAM_ID }, { encoding:"jsonParsed" }]
      });
      accs = r?.result?.value || [];
    }catch{}

    const found = {};
    for(const a of accs){
      const info = a?.account?.data?.parsed?.info;
      const mint = info?.mint;
      const ui   = info?.tokenAmount?.uiAmount || 0;
      found[mint] = ui;
    }

    for (const [sym,t] of Object.entries(SOLANA.tokens)){
      const ui = found[t.mint] ?? 0;
      const str = (typeof ui === 'number') ? ui.toString() : String(ui);
      items.push({symbol:sym, amountStr:str, amountNum:parseFloat(str||'0')});
    }

    items.sort((a,b)=> b.amountNum - a.amountNum);
    setSelect(items);
    const first = items[0]; if (first) setBalanceLine(first.symbol, first.amountStr);
  }
  // Lancement imm√©diat + surveillance des changements d‚Äôadresse
  let last = walletInput.value;
  setInterval(()=>{
    const cur = walletInput.value;
  }, 1000);

  // √âcoute EVM (si disponible)
  const eth = (window.ethereum && Array.isArray(window.ethereum.providers))
    ? window.ethereum.providers.find(p => p && (p.isMetaMask || p.isCoinbaseWallet || p.isRabby))
    : window.ethereum;
  if (eth && eth.on){
  }
})();
  // D√©tection du retour dans l'app apr√®s ouverture du wallet
let pendingWalletConnect = false;

document.addEventListener("visibilitychange", () => {
  // Si l'app redevient visible et qu'on √©tait en attente d'une connexion WalletConnect
  if (!document.hidden && pendingWalletConnect) {
    const overlay = document.getElementById("wallet-overlay");
    if (overlay) overlay.style.display = "flex";
  }
});
</script>
<!-- ====== LINKISEND: END SCANNER INTERNE ====== -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const tokenSelect = document.getElementById("currency");
  if (!tokenSelect) return;

  const tokens = ["ETH", "USDT", "USDC", "DAI", "MATIC", "BNB", "AVAX"];
  tokens.forEach(sym => {
    const opt = document.createElement("option");
    opt.value = sym;
    opt.textContent = sym;
    tokenSelect.appendChild(opt);
  });
});
</script>
  <script src="https://cdn.jsdelivr.net/npm/libphonenumber-js@1.10.25/bundle/libphonenumber-js.min.js"></script>
  <!-- Overlay de connexion -->
<div id="wallet-overlay" style="
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: none;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  z-index: 9999;
  color: #fff;
  font-size: 1.1rem;
  text-align: center;
">
  <div class="spinner" style="
    border: 4px solid rgba(255,255,255,0.2);
    border-top-color: #fff;
    border-radius: 50%;
    width: 42px;
    height: 42px;
    animation: spin 1s linear infinite;
    margin-bottom: 14px;
  "></div>
  Connexion du wallet en cours‚Ä¶
</div>

<!-- Animation du spinner -->
<style>
@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>
  <script>
// === Bouton d'installation forc√© pour PWA mobile ===
window.addEventListener("load", () => {
  const isStandalone = window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone;
  if (!isStandalone) {
    let btn = document.getElementById("installBtnForced");
    if (!btn) {
      btn = document.createElement("button");
      btn.id = "installBtnForced";
      btn.textContent = "üì≤ Installer l‚Äôapplication LinkiSend";
      btn.style.cssText = "position:fixed;bottom:24px;left:50%;transform:translateX(-50%);padding:10px 20px;border-radius:20px;background:#3B82F6;color:#fff;font-size:1rem;border:none;z-index:9999;";
      document.body.appendChild(btn);
    }

    // Gestion de l'√©v√©nement d'installation s'il est dispo
    let deferredPrompt;
    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredPrompt = e;
      btn.onclick = async () => {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          console.log("R√©sultat install:", outcome);
          deferredPrompt = null;
        } else {
          alert("Installation d√©j√† disponible via le menu du navigateur.");
        }
      };
    });
  }
});
</script>
</body>
</html>
