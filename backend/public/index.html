<script>
  // Config backend (fallback localhost)
  const BACKEND = (window.LINKISEND_CONFIG && window.LINKISEND_CONFIG.BACKEND_BASE)
    ? window.LINKISEND_CONFIG.BACKEND_BASE
    : `${location.protocol}//${location.hostname}:8000`;

  // Elements
  const resultDiv = document.getElementById('result');
  const errorDiv  = document.getElementById('error');
  const walletInput = document.getElementById('wallet');

  // Modal helpers
  const modal = document.getElementById('walletModal');
  const openModal = () => { modal.classList.add('open'); };
  const closeModal = () => { modal.classList.remove('open'); };

  document.getElementById('connectWalletLink').addEventListener('click', (e)=>{
    e.preventDefault(); openModal();
  });
  document.getElementById('walletModalClose').addEventListener('click', closeModal);
  modal.addEventListener('click', (e)=>{ if (e.target === modal) closeModal(); });

  // Choix provider
  modal.querySelectorAll('.pv').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const provider = btn.getAttribute('data-wallet');

      if(provider === 'metamask'){
        if(!window.ethereum){
          alert("⚠️ MetaMask n’est pas installé. Installe l’extension pour continuer.");
          return;
        }
        try{
          const accounts = await window.ethereum.request({ method:'eth_requestAccounts' });
          if(accounts && accounts[0]){
            walletInput.value = accounts[0]; // affiche l’adresse
          }
          closeModal();
        }catch(e){
          alert("Connexion MetaMask refusée.");
        }
      }else{
        alert("Connexion via " + provider + " arrive bientôt.");
      }
    });
  });

  // Génération du lien
  document.getElementById('generateBtn').addEventListener('click', async ()=>{
    const amount = parseFloat(document.getElementById('amount').value);
    const currency = document.getElementById('currency').value;
    const sender_wallet = walletInput.value.trim();
    const recipient_phone = document.getElementById('phone').value.trim();
    const network = document.getElementById('network').value;

    resultDiv.style.display='none';
    errorDiv.style.display='none';

    if (!amount || !currency || !sender_wallet || !recipient_phone || !network){
      errorDiv.textContent = "Merci de remplir tous les champs obligatoires.";
      errorDiv.style.display='block';
      return;
    }

    try{
      const res = await fetch(`${BACKEND}/create-link`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ amount, currency, sender_wallet, recipient_phone, network })
      });
      const data = await res.json();
      if(!res.ok) throw new Error(data.detail || "Erreur lors de la génération du lien");

      const lien = `${BACKEND}/s/${data.short_id}`;
      resultDiv.innerHTML = `<b>Lien généré :</b><br><a href="${lien}" target="_blank" rel="noopener">${lien}</a>`;
      resultDiv.style.display='block';
    }catch(err){
      errorDiv.textContent = err.message || 'Erreur réseau';
      errorDiv.style.display='block';
    }
  });
</script>
