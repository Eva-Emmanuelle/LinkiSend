<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>LinkiSend ‚Äî Envoyer des cryptos</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <link rel="manifest" href="/manifest.json">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="/static/assets/icons/icon-maskable-512.png">
<meta name="theme-color" content="#0b0f14">
<link rel="icon" href="/static/assets/icons/icon-maskable-512.png">
  <!-- Flag-icons (CDN) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flag-icons/css/flag-icons.min.css">

  <style>
    :root{--bg:#0b0f14;--bg-soft:#0f141b;--card:#121821;--card-2:#0f1620;--text:#e6edf3;--text-dim:#9fb0c0;--stroke:#1f2a37;--focus:#334155;--shadow:0 12px 40px rgba(0,0,0,.45);--radius:14px;--radius-sm:10px;--gap:12px}
    *,*:before,*:after{box-sizing:border-box}html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif;background:radial-gradient(1200px 600px at 20% -10%,#132034 0%,
    transparent 60%),radial-gradient(900px 500px at 110% 0%,#1a2334 0%,transparent 60%),var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
    .wrap{max-width:420px;margin:40px auto 64px;padding:0 16px}
    .brand img.arrow {
  max-width:45px;
  height:auto;
  margin-right:8px;
  filter:drop-shadow(0 0 8px rgba(255,255,255,0.1));
}
    .brand img.word{max-width:240px;height:auto;display:block}
    .brand {
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  margin-bottom:22px;
  position:relative;
}
    .card {
  background:linear-gradient(180deg,var(--card),var(--card-2));
  border:1px solid var(--stroke);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:22px 18px;
}
.card h2{margin:4px 2px 2px;font-size:22px;font-weight:750}.sub{color:var(--text-dim);margin:0 2px 14px;font-size:13px}
    .row{display:flex;gap:var(--gap)}.col{flex:1}label{display:block;margin:14px 2px 8px;font-size:13px;color:var(--text-dim)}
    select,input{width:100%;height:44px;padding:10px 12px;border-radius:var(--radius-sm);border:1px solid var(--stroke);background:#0e141c;color:var(--text);outline:none}
    select:focus,input:focus{border-color:var(--focus);box-shadow:0 0 0 3px rgba(51,65,85,.35)}
    .hint {
  font-size:12px;
  color:var(--text-dim);
  margin:8px 2px 2px;
      line-height: 1.4;
}
    .phone-row {
  display: flex;
  gap: 8px;
  align-items: center;
}
    .btn {
  width:100%;
  height:46px;
  border:0;
  border-radius:12px;
  font-weight:700;
  font-size:15px;
  cursor:pointer;
  background:radial-gradient(circle at 20% 20%,#8b5cf6,#06b6d4,#22c55e);
  color:#fff;
  box-shadow:0 10px 24px rgba(34,197,94,.2);
  margin-top:18px;
}
    .btn:hover{box-shadow:0 12px 32px rgba(34,197,94,.28)}.btn:active{transform:translateY(1px)}
    .wallet-link{display:inline-flex;align-items:center;gap:8px;color:#93c5fd;text-decoration:none;font-weight:600;font-size:14px;padding:8px 10px;border-radius:10px;border:1px dashed var(--stroke);background:#0a1220;margin:8px 2px 4px;width:max-content}
    .wallet-link:hover{background:#0d1729}
    .result,.error{margin:14px 2px 0;padding:10px 12px;border-radius:10px;font-size:13px;border:1px solid var(--stroke)}.error{background:#fee2e2;color:#991b1b;border:1px solid #f87171}
    .result-cta{margin:14px 2px 0;padding:16px;border-radius:14px;background:#ecfdf5;border:1px solid #bbf7d0;color:#064e3b;display:none}
    .row-cta{display:flex;gap:10px;align-items:stretch;flex-wrap:wrap}
    .toast{position:fixed;right:16px;bottom:16px;background:#10b981;color:white;padding:10px 14px;border-radius:10px;box-shadow:var(--shadow);opacity:0;transform:translateY(6px);transition:opacity .2s,transform .2s;z-index:60}.toast.show{opacity:1;transform:translateY(0)}
    .-row{display:flex;gap:8px;align-items:center}.dial{position:relative;display:flex}.dial-btn{height:44px;padding:0 10px;border-radius:8px;border:1px solid var(--stroke);background:#0e141c;color:#e6edf3;display:inline-flex;align-items:center;gap:6px;cursor:pointer}
    .dial-btn:hover{background:#0d1729}.dial-panel{position:absolute;left:0;top:44px;z-index:30;width:260px;background:#0d1420;border:1px solid var(--stroke);border-radius:10px;box-shadow:var(--shadow);display:none}
    .dial-head{display:flex;align-items:center;gap:6px;padding:8px 10px;border-bottom:1px solid rgba(255,255,255,.06)}.dial-search-input{flex:1;height:32px;border:1px solid var(--stroke);background:#0e141c;color:#e6edf3;border-radius:8px;padding:0 8px;outline:none}
    .dial-list{max-height:260px;overflow:auto}.dial-item{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.04);cursor:pointer}.dial-item:last-child{border-bottom:0}
    .iso{font-weight:600;color:#e6edf3;width:26px;display:inline-block}.dialcode{color:#cfe1ff}.country{color:#9fb0c0;font-size:12px}
@media (max-width:540px){
  .brand{
    justify-content:center!important;
    gap:10px!important;
    margin:10px 0 20px!important;
    padding:0 8px;
  }
  .brand img.arrow{
    position:static!important;
    transform:none!important;
    max-width:70px!important;
    height:auto!important;
    margin-right:6px;
  }
  .brand img.word{max-width:170px!important}
  .lang-toggle{right:8px!important;font-size:11px;padding:3px 8px}
}
    #installBtn{position:fixed;right:14px;bottom:90px;z-index:80;display:none;align-items:center;gap:8px;padding:10px 14px;border-radius:999px;border:1px solid var(--stroke);background:#0e141c;color:#e6edf3;font-weight:700;cursor:pointer;box-shadow:var(--shadow)}
    #installBtn:active{transform:translateY(1px)}
    #splash{position:fixed;inset:0;z-index:9999;display:grid;place-items:center;background:radial-gradient(1200px 600px at 20% -10%,#132034 0%,transparent 60%),radial-gradient(900px 500px at 110% 0%,#1a2334 0%,transparent 60%),var(--bg);transition:opacity .35s ease}
    #splash img{width:300px;height:auto;filter:drop-shadow(0 12px 30px rgba(0,0,0,.35));opacity:.96}#splash.hide{opacity:0;pointer-events:none}
  
    /* Effet sur üìñ et üíæ */
.emoji-btn {
  display: inline-block;            /* ‚Üê important pour que :hover/transform marchent */
  transition: transform 0.1s ease, opacity 0.1s ease;
  cursor: pointer;
}

/* Survol : l√©ger zoom */
.emoji-btn:hover {
  transform: scale(1.2);
}

/* Clic : bouton enfonc√© */
.emoji-btn:active {
  transform: scale(0.9);
  opacity: 0.7;
}
  .dial-btn img.flag {
  display: inline-block;
  vertical-align: middle;
  margin-top: -1px;
} 
  </style>

  <script>
  document.addEventListener("DOMContentLoaded",function(){
    const s=document.getElementById('splash');if(!s)return;
    const isStandalone=(window.matchMedia&&window.matchMedia('(display-mode: standalone)').matches)||(window.navigator.standalone===true);
    if(isStandalone){s.remove();return}
    let done=false;function hide(){if(done)return;done=true;s.classList.add('hide');setTimeout(()=>s.remove(),400)}
    window.addEventListener('load',hide);setTimeout(hide,1200)
  });
  </script>

  <!-- CONFIG + pays -->
  <script src="/static/config.js"></script>
  <script src="/static/countries.js"></script>

  <!-- CHARGEUR ROBUSTE WalletConnect: local si OK, sinon  CDN -->
  <script>
    (function(){
      function inject(src){
        return new Promise((resolve,reject)=>{
          const s=document.createElement('script');
          s.src=src; s.async=true;
          s.onload=resolve; s.onerror=()=>reject(new Error('load fail '+src));
          document.head.appendChild(s);
        });
      }
      async function loadLocalOrCdn(){
        const local="/assets/vendor/wc/ethereum-provider.bundle.min.js";
        try{
          const r=await fetch(local,{cache:'no-store'});
          const ct=(r.headers.get('content-type')||'').toLowerCase();
          const txt=await r.text();
          if(!r.ok || ct.includes('text/html') || /^\s*<!doctype html/i.test(txt)) throw new Error('local is html/404');
          await inject(local+'?v='+Date.now());
        }catch(_){
          await inject("https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider@2/dist/index.umd.js");
        }
      }
      window.__wcProviderBootstrap = loadLocalOrCdn();
    })();
  </script>
</head>

<body>
  <script>
  (function(){
    const isStandalone=(window.matchMedia&&window.matchMedia('(display-mode: standalone)').matches)||(window.navigator.standalone===true);
    const ua=(navigator.userAgent||navigator.vendor||window.opera||"").toLowerCase();
    const isMobileUA=/android|i|ipad|ipod|iemobile|opera mini|mobile/i.test(ua);
    if(!isStandalone && isMobileUA){
      function browserHelp(){
        if(ua.includes('samsungbrowser'))return"Sur Samsung Internet : menu ‚ãÆ > Ajouter page √† > √âcran d'accueil.";
        if(ua.includes('firefox'))return"Sur Firefox Android : menu ‚ãÆ > Installer.";
        if(ua.includes('crios')||ua.includes('i')||ua.includes('ipad'))return"Sur i/iPad (Safari) : bouton Partager ‚éã > Ajouter √† l‚Äô√©cran d‚Äôaccueil.";
        if(ua.includes('chrome'))return"Sur Chrome Android : menu ‚ãÆ > Installer l‚Äôapplication (ou Ajouter √† l‚Äô√©cran d‚Äôaccueil).";
        return"Ouvre le menu du navigateur et choisis ¬´ Ajouter √† l‚Äô√©cran d‚Äôaccueil ¬ª ou ¬´ Installer l‚Äôapplication ¬ª.";
      }
      document.write(`
        <style>body > :not(#install-gate){display:none!important}</style>
        <div id="install-gate" style="min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:24px;background:#0b0f14;color:#e6edf3;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;">
          <img src="/static/assets/branding/logo-arrow.svg" alt="LinkiSend" style="width:96px;height:auto;margin-bottom:18px;opacity:.95;"/>
          <h2 style="margin:0 0 10px;font-size:22px;">Installe l‚Äôapp LinkiSend üì≤</h2>
          <p style="margin:0 0 16px;color:#9fb0c0;font-size:14px;max-width:340px;">Pour utiliser LinkiSend, installe l‚Äôapplication sur ton t√©l√©.</p>
          <button id="installNow" style="display:inline-flex;align-items:center;gap:8px;padding:10px 16px;border-radius:999px;border:1px solid #1f2a37;background:#0e141c;color:#e6edf3;font-weight:700;cursor:pointer;">üì≤ Installer l‚Äôapp</button>
          <div id="installHint" style="margin-top:10px;color:#9fb0c0;font-size:12px;">${browserHelp()}</div>
        </div>
      `);}
  </script>
  <div class="wrap">
    <div class="brand">
      <img src="/static/assets/branding/logo-arrow.svg" alt="Fl√®che" class="arrow" />
      <img src="/static/assets/branding/logo-word.svg" alt="LinkiSend" class="word" />
      <!-- S√©lecteur de langue (globe) -->
<div class="lang-menu" style="position:absolute;right:0;top:0;z-index:12;">
  <button id="langBtn" aria-haspopup="listbox" aria-expanded="false" title="Language"
          style="display:inline-flex;align-items:center;gap:6px;border:1px solid var(--stroke);background:#0e141c;color:#9fb0c0;border-radius:999px;height:28px;padding:0 10px;cursor:pointer;">
    üåê
  </button>
  <div id="langMenu" role="listbox"
     style="display:none;position:absolute;right:0;top:36px;min-width:260px;background:#0d1420;border:1px solid var(--stroke);border-radius:10px;box-shadow:var(--shadow);padding:8px;z-index:20;">

  <!-- Grille responsive : 1 colonne mobile, 2 colonnes desktop -->
  <style>
    /* scope local au menu */
    #langMenu .lang-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 6px;
    }
    @media (min-width: 520px) {
      #langMenu .lang-grid { grid-template-columns: 1fr 1fr; }
    }
    #langMenu .lang-btn {
      width: 100%;
      text-align: left;
      padding: 8px 10px;
      background: #0e141c;
      color: #e6edf3;
      border: 1px solid var(--stroke);
      border-radius: 8px;
      cursor: pointer;
    }
    #langMenu .lang-btn:hover { background:#0d1729; }
  </style>

  <div class="lang-grid">
  <button data-lang="ar" class="lang-btn" role="option">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</button>
  <button data-lang="zh" class="lang-btn" role="option">‰∏≠Êñá</button>
  <button data-lang="de" class="lang-btn" role="option">Deutsch</button>
  <button data-lang="en" class="lang-btn" role="option">English</button>
  <button data-lang="es" class="lang-btn" role="option">Espa√±ol</button>
  <button data-lang="fr" class="lang-btn" role="option">Fran√ßais</button>
  <button data-lang="hi" class="lang-btn" role="option">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</button>
  <button data-lang="it" class="lang-btn" role="option">Italiano</button>
  <button data-lang="pt" class="lang-btn" role="option">Portugu√™s</button>
  <button data-lang="ru" class="lang-btn" role="option">–†—É—Å—Å–∫–∏–π</button>
  </div>
</div>
</div>
</div>
    <div class="card" role="region" aria-label="Formulaire d‚Äôenvoi">
      <h2 id="title">Envoyer des cryptos</h2>
      <p class="sub" id="subtitle">G√©n√®re un lien en 10&nbsp;secondes.</p>

      <label for="wallet" id="lbl-wallet">Ton wallet (exp√©diteur)</label>
      <input type="text" id="wallet" placeholder="0xABCDEF..." autocomplete="off" />
      <button id="walletConnectBtn" class="wallet-link" style="gap:6px;cursor:pointer;">
  <img src="/assets/wallets/walletconnect.svg" alt="WalletConnect" width="20" height="20" style="display:inline-block;vertical-align:middle;">
  <span>WalletConnect</span>
</button>
      <div class="row">
        <div class="col">
          <label for="currency" id="lbl-token">Token</label>
<select id="currency"></select>
        </div>
        <div class="col">
          <label for="amount" id="lbl-amount">Montant</label>
          <input type="number" id="amount" inputmode="decimal" min="0" step="0.00001" placeholder="0.01" />
          <p id="usdValue" class="hint">‚âà 0.00 $ (index√© sur CoinGecko)</p>
</span>
        </div>
      </div>
      <label id="lbl-phone">Num√©ro du destinataire</label>
      <div class="phone-row">
        <div class="dial">
          <button id="dialBtn" class="dial-btn">
  <span class="fi fi-fr" style="width:18px;height:12px;border-radius:2px;object-fit:cover;margin-right:4px;display:inline-block"></span>
  <span id="dialCode">+33</span>
</button>
          <div id="dialPanel" class="dial-panel">
            <div class="dial-head"><input id="dialSearch" class="dial-search-input" placeholder="Rechercher..."/></div>
            <div id="dialList" class="dial-list"></div>
          </div>
        </div>
        <input type="text" id="phone" placeholder="612345678" inputmode="tel"/>
      </div>

       <div class="contact-actions" style="margin-top:16px; display:flex; align-items:center; gap:8px; cursor:pointer;" id="openContactsArea">
  <span class="emoji-btn" title="Ouvrir mes contacts">üìñ</span>
  <span style="font-size:13px; color:var(--text-dim);">Ouvrir mes contacts</span>
</div>

<script>
document.getElementById('openContactsArea').addEventListener('click', async () => {
  if ('contacts' in navigator && 'select' in navigator.contacts) {
    try {
      const contacts = await navigator.contacts.select(['name', 'tel'], { multiple: false });
      if (contacts.length > 0) {
        const phoneInput = document.getElementById('phone');
        const telField =
          contacts[0].tel?.[0]?.number ||
          contacts[0].tel?.[0] ||
          contacts[0].tel ||
          "";

        if (phoneInput && telField) {
          // --- Nettoyage d√©terministe bas√© sur COUNTRIES ---
          const raw = String(telField).trim();
          let clean = raw.replace(/[\s()-]/g, "");

          // normalise "00" -> "+"
          if (clean.startsWith("00")) clean = "+" + clean.slice(2);

          if (clean.startsWith("+") && Array.isArray(COUNTRIES)) {
            const digits = clean.slice(1); // apr√®s le "+"
            // extrait tous les indicatifs connus ("+34" -> "34")
            const codes = COUNTRIES.map(c => (c.code || "").replace("+", "")).filter(Boolean);
            // prend le pr√©fixe le plus long qui matche
            let best = "";
            for (const code of codes) {
              if (digits.startsWith(code) && code.length > best.length) best = code;
            }
            // si trouv√© : retire exactement l'indicatif ; sinon : retire juste le "+"
            clean = best ? digits.slice(best.length) : digits;
          }

          phoneInput.value = clean; // -> num√©ro national sans indicatif
        }
      }
    } catch (err) {
      alert("Impossible d'acc√©der aux contacts : " + err.message);
    }
  } else {
    alert("Cette fonction n‚Äôest pas disponible sur ton appareil ou navigateur.");
  }
});
</script>
      <div class="contacts" id="contactsList"></div>

      <button id="generateBtn" class="btn">G√©n√©rer le lien</button>
      <p class="hint" id="hint">Aucun transfert on-chain n‚Äôest effectu√© tant que le lien n‚Äôest pas r√©clam√©.</p>

      <div id="result" class="result-cta" aria-live="polite">
        <h3 id="resultTitle" style="margin:0 0 10px;font-size:18px;">Lien pr√™t ‚úÖ</h3>
        <div class="row-cta" style="display:inline-flex;align-items:center;">
          <code id="the-link"></code>
          <span id="copyLinkBtn" style="cursor:pointer;margin-left:4px;" title="Copier">üìã</span>
        </div>
        <div class="sub-cta" id="validityText" style="margin-top:10px;">
          ‚è≥ Validit√© : 24h ‚Ä¢ Aucun transfert on-chain n‚Äôa lieu tant que le lien n‚Äôest pas r√©clam√©.
        </div>
      </div>

      <div id="error" class="error" style="display:none"></div>
    </div>
  </div>

  <div class="toast" id="toast">Lien copi√© ‚úÖ</div>

  <script>
    let currencySel;
    const BACKEND = `${location.protocol}//${location.hostname}`;
  document.addEventListener('DOMContentLoaded', ()=> {
    const resultDiv=document.getElementById('result');
    const errorDiv=document.getElementById('error');
    const walletInput=document.getElementById('wallet');
    // === Connexion directe via WalletConnect ===
const wcBtn = document.getElementById('walletConnectBtn');
if (wcBtn && walletInput) {
  wcBtn.addEventListener('click', async () => {
    try {
      wcBtn.disabled = true;
      wcBtn.style.opacity = "0.6";
      wcBtn.querySelector("span").textContent = "Connexion...";

      // Charge le provider WalletConnect
      const EP = await loadWalletConnectProvider();
      if (!EP || !EP.init) throw new Error("Provider WalletConnect introuvable.");

      // Initialise le provider
      const provider = await EP.init({
        projectId: "9c945cd5bef5c1e1905266cf0219736d",
        showQrModal: true,
        rpc: {
    1: "https://rpc.ankr.com/eth",
    56: "https://rpc.ankr.com/bsc",
    137: "https://rpc.ankr.com/polygon",
    43114: "https://rpc.ankr.com/avalanche"
  },
        chains: [1],
        optionalChains: [137, 56, 43114],
        methods: ["eth_requestAccounts","eth_sendTransaction","personal_sign","eth_signTypedData"],
        events: ["chainChanged","accountsChanged"]
      });

      // D√©marre la connexion (ouvre QR ou deep-link)
      await provider.connect();

      // R√©cup√®re l'adresse
      const accounts = await provider.request({ method: "eth_requestAccounts" });
      const address = accounts && accounts[0] ? accounts[0] : "";

      if (address) {
        walletInput.value = address;
      } else {
        alert("Connexion annul√©e.");
      }

      // Stocke le provider globalement
      window.__wcProvider = provider;
      window.ethereum = provider;

      // R√©active le bouton
      wcBtn.disabled = false;
      wcBtn.style.opacity = "1";
      wcBtn.querySelector("span").textContent = "WalletConnect";

      // Met √† jour si l‚Äôutilisateur change de compte
      provider.on("accountsChanged", (acc) => {
        if (acc && acc[0]) walletInput.value = acc[0];
      });

    } catch (err) {
      console.error("Erreur WalletConnect:", err);
      alert("Erreur WalletConnect : " + (err.message || err));
      wcBtn.disabled = false;
      wcBtn.style.opacity = "1";
      wcBtn.querySelector("span").textContent = "WalletConnect";
    }
  });
}
    currencySel = document.getElementById('currency');
    const linkEl=document.getElementById('the-link');
    const dialBtn=document.getElementById('dialBtn');
    const dialPanel=document.getElementById('dialPanel');
    const dialSearch=document.getElementById('dialSearch');
    const dialList=document.getElementById('dialList');
    dialSearch.addEventListener("input", () => {
  renderDialList(dialSearch.value.toLowerCase());
  dialList.scrollTop = 0; // pour que la liste remonte en haut
});

    // Ouvrir/fermer le panneau des indicatifs quand on clique sur le bouton
dialBtn.addEventListener("click", (e) => {
  e.stopPropagation(); // √©viter que le clic ferme le panneau directement
  dialPanel.style.display = dialPanel.style.display === "block" ? "none" : "block";
  if (dialPanel.style.display === "block") {
    renderDialList(""); // afficher la liste compl√®te des pays
    dialSearch.value = ""; // reset de la recherche
    dialSearch.focus(); // focus dans la barre de recherche
  }
});
    let currentDial={iso:"FR",code:"+33"};
    let saveNameInput, saveConfirmBtn, saveCancelBtn;
    const userPref=localStorage.getItem('lang');let lang=userPref||((navigator.language||'fr').toLowerCase().startsWith('fr')?'fr':'en');
    // --- Chargement des traductions depuis les fichiers JSON ---
let translations = {};
    // --- Chargement i18n (multi-langues) ---
const SUPPORTED_LANGS = ['fr','en','es','pt','de','it','ar','zh','hi','ru'];

Promise.allSettled(
  SUPPORTED_LANGS.map(code =>
    fetch(`/static/lang/${code}.json`, { cache: 'no-store' })
      .then(r => r.ok ? r.json() : Promise.reject(code))
      .then(json => [code, json])
  )
).then(results => {
  //  l'objet translations uniquement avec les langues charg√©es avec succ√®s
  translations = results.reduce((acc, res) => {
    if (res.status === 'fulfilled') {
      const [code, json] = res.value;
      acc[code] = json;
    } else {
      console.warn('[i18n] Fichier manquant ou invalide :', res.reason);
    }
    return acc;
  }, {});

  applyLang(); // applique selon la variable 'lang' d√©j√† g√©r√©e (localStorage / navigateur)
}).catch(err => {
  console.error('i18n_load_failed:', err);
  translations = {};
  applyLang();
});
    function applyLang() {
  if (!translations || !translations[lang]) return;
  const tr = translations[lang];

  // Petite fonction utilitaire pour √©viter les erreurs
  const setText = (id, value) => {
    const el = document.getElementById(id);
    if (el && value !== undefined) el.textContent = value;
  };

  setText("title", tr.title);
  setText("subtitle", tr.subtitle);
  setText("lbl-wallet", tr.wallet);
  setText("lbl-token", tr.token);
  setText("lbl-amount", tr.amount);
  setText("lbl-phone", tr.phone);
  setText("hint", tr.hint);
  setText("generateBtn", tr.generate);
  setText("connectWalletLink", tr.connectWallet);
  setText("dialSearch", tr.search);
  setText("resultTitle", tr.resultTitle);
  setText("validityText", tr.validity);

  if (saveNameInput)  saveNameInput.placeholder = tr.savePh || '';
  if (saveConfirmBtn) saveConfirmBtn.textContent = `‚úÖ ${tr.save || 'Save'}`;
  if (saveCancelBtn)  saveCancelBtn.textContent  = `‚úñÔ∏è ${tr.cancel || 'Cancel'}`;
}
   if (dialPanel.style.display === 'block') {
  renderDialList(dialSearch.value.toLowerCase());
}    
    // --- Globe + menu langues ---
const langBtn  = document.getElementById('langBtn');
const langMenu = document.getElementById('langMenu');

function closeLangMenuOnOutside(e){
  if (!langMenu.contains(e.target) && !langBtn.contains(e.target)){
    langMenu.style.display = 'none';
    langBtn.setAttribute('aria-expanded','false');
    document.removeEventListener('click', closeLangMenuOnOutside);
  }
}

if (langBtn && langMenu){
  langBtn.addEventListener('click', (e)=>{
    e.stopPropagation();
    const open = langMenu.style.display === 'block';
    langMenu.style.display = open ? 'none' : 'block';
    langBtn.setAttribute('aria-expanded', String(!open));
    if (!open) document.addEventListener('click', closeLangMenuOnOutside);
  });

  langMenu.querySelectorAll('button[data-lang]').forEach(b=>{
    b.addEventListener('click', ()=>{
      lang = b.dataset.lang;               // variable lang d√©j√† existante dans ton code
      localStorage.setItem('lang', lang);
      applyLang();
      langMenu.style.display = 'none';
      langBtn.setAttribute('aria-expanded','false');
    });
  });
}
    function getWcGlobal(){
      const mod=window['@walletconnect/ethereum-provider'];
      if(mod&&(mod.EthereumProvider?.init||mod.default?.EthereumProvider?.init)){return mod.EthereumProvider||mod.default.EthereumProvider}
      return window.EthereumProvider||window.WalletConnectEthereumProvider||(window.WalletConnectProvider&&(window.WalletConnectProvider.init?window.WalletConnectProvider:window.WalletConnectProvider.default))||(window.WalletConnect&&window.WalletConnect.EthereumProvider)
    }

    async function loadWalletConnectProvider(){
      try{await window.__wcProviderBootstrap}catch{} // attend le bootstrap local/CDN
      let EP=getWcGlobal(); if(EP) return EP;
      const umd=["https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider@2/dist/index.umd.js","https://unpkg.com/@walletconnect/ethereum-provider@2/dist/index.umd.js"];
      for(const u of umd){try{await loadScript(u+"?v="+Date.now());EP=getWcGlobal();if(EP)return EP}catch{}}
      return null;
    }

    function renderDialList(f = "") {
  dialList.innerHTML = "";
  const filter = (f || "").toLowerCase();
  const normFilter = filter.replace(/^\+/, "");


  COUNTRIES
    .filter(d =>
      !filter ||
      d.en.toLowerCase().includes(filter) ||
      d.fr.toLowerCase().includes(filter) ||
      d.code.replace("+","").includes(normFilter) ||
      d.iso.toLowerCase().includes(filter)
    )
    .sort((a, b) => {
  // si l'indicatif commence exactement par la recherche ‚Üí priorit√©
  if (a.code.startsWith(filter) && !b.code.startsWith(filter)) return -1;
  if (!a.code.startsWith(filter) && b.code.startsWith(filter)) return 1;
  // sinon tri alphab√©tique des codes (ou des noms)
  return a.code.localeCompare(b.code);
})
    .forEach(d => {
      const name = (lang === "fr") ? d.fr : d.en;
      const row = document.createElement("div");
      row.className = "dial-item";

      row.innerHTML = `
        <span class="fi fi-${d.iso.toLowerCase()}"
              style="width:18px;height:12px;border-radius:2px;object-fit:cover;display:inline-block"></span>
        <span class="dialcode">${d.code}</span>
        <span class="country">${name}</span>
      `;

      row.onclick = () => {
        currentDial = { iso: d.iso, code: d.code };
        dialBtn.innerHTML =
          `<span class="fi fi-${d.iso.toLowerCase()}"
                  style="width:18px;height:12px;border-radius:2px;object-fit:cover;display:inline-block;margin-right:6px;"></span>
           <span id="dialCode">${d.code}</span>`;
        dialPanel.style.display = "none";
      };

      dialList.appendChild(row);
    });
}

// Fermer le panneau quand on clique ailleurs (en dehors de la fonction)
    document.addEventListener("click",e=>{if(!dialPanel.contains(e.target)&&!dialBtn.contains(e.target)){dialPanel.style.display="none"}});
    const actionsBar=document.querySelector('.contact-actions');const saveInline=document.createElement('div');saveInline.style.display='none';saveInline.style.marginTop='8px';
    saveInline.style.padding='10px';saveInline.style.border='1px solid var(--stroke)';saveInline.style.borderRadius='8px';saveInline.style.background='#0e1420';saveInline.style.boxShadow='var(--shadow)';
    saveInline.style.gap='8px';saveInline.style.alignItems='center';saveInline.style.justifyContent='space-between';
    saveNameInput = document.createElement('input');saveNameInput.type='text';saveNameInput.id='saveName';saveNameInput.placeholder = '';saveNameInput.style.width='100%';
    saveNameInput.style.padding='8px 10px';saveNameInput.style.border='1px solid var(--stroke)';saveNameInput.style.borderRadius='6px';saveNameInput.style.background='#0a1220';saveNameInput.style.color='#e6edf3';
    saveNameInput.style.marginRight='8px';
    const btnsWrap=document.createElement('div');btnsWrap.style.display='flex';btnsWrap.style.gap='8px';btnsWrap.style.marginTop='8px';
  saveConfirmBtn=document.createElement('button');saveConfirmBtn.textContent = '‚úÖ';saveConfirmBtn.style.border='1px solid var(--stroke)';
    saveConfirmBtn.style.background='#0a1220';saveConfirmBtn.style.color='#ffffff';saveConfirmBtn.style.borderRadius='8px';saveConfirmBtn.style.padding='6px 10px';saveConfirmBtn.style.cursor='pointer';
    saveCancelBtn = document.createElement('button');
saveCancelBtn.type = 'button';
saveCancelBtn.textContent = '‚ùå';
saveCancelBtn.style.border = '1px solid var(--stroke)';
    saveCancelBtn.style.background='#0a1220';saveCancelBtn.style.color='#ffffff';saveCancelBtn.style.borderRadius='8px';saveCancelBtn.style.padding='6px 10px';saveCancelBtn.style.cursor='pointer';
    saveInline.appendChild(saveNameInput);btnsWrap.appendChild(saveConfirmBtn);btnsWrap.appendChild(saveCancelBtn);saveInline.appendChild(btnsWrap);actionsBar.insertAdjacentElement('afterend',saveInline);
    function toggleSaveInline(open){saveInline.style.display=open?'block':'none';if(open){saveNameInput.value='';saveNameInput.focus()}}
    document.getElementById('showContacts').onclick=()=>{contactsList.style.display=(contactsList.style.display==="block"?"none":"block");renderContacts()};
    document.getElementById('generateBtn').addEventListener('click',async()=>{
      const amount=parseFloat(document.getElementById('amount').value);
      const currency=document.getElementById('currency').value;
      const sender_wallet=walletInput.value.trim();
      const localPhone=document.getElementById('phone').value.trim();
      const recipient_phone=`${currentDial.code}${localPhone}`;
      resultDiv.style.display='none';errorDiv.style.display='none';
      if(!amount||!currency||!sender_wallet||!localPhone){errorDiv.textContent=(lang==='fr')?"Merci de remplir tous les champs obligatoires.":"Please fill in all required fields.";
      errorDiv.style.display='block';return}
      
      // V√©rifie que le wallet contient bien des fonds
const selOpt = currencySel.options[currencySel.selectedIndex];
let balanceNum = 0;
if (selOpt) {
  // Exemple d'option : "USDC ‚Äî 117.91809"
  const txt = selOpt.textContent || "";
  const parts = txt.split("‚Äî");
  if (parts.length > 1) {
    const raw = parts[1].trim().replace(",", ".");
    balanceNum = parseFloat(raw);
  }
}

if (!balanceNum || isNaN(balanceNum) || balanceNum <= 0) {
  errorDiv.textContent =
    translations?.[lang]?.noBalance ||
    (lang === "fr"
      ? "Solde insuffisant pour g√©n√©rer un lien."
      : "Insufficient balance to generate a link.");
  errorDiv.style.display = "block";
  return;
}
      try{
        const res=await fetch(`${BACKEND}/create-link`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({amount,currency,sender_wallet,recipient_phone})});
        const data=await res.json();if(!res.ok)throw new Error(data.detail||"Erreur lors de la g√©n√©ration du lien");
        const lien=`https://linkisend.io/${data.short_id}`;linkEl.textContent=lien;resultDiv.style.display='block';
      }catch(err){errorDiv.textContent=err.message||(lang==='fr'?'Erreur r√©seau':'Network error');errorDiv.style.display='block'}
    });

    const copyBtn=document.getElementById('copyLinkBtn');if(copyBtn){copyBtn.addEventListener('click',()=>{navigator.clipboard.writeText(linkEl.textContent).then(()=>{copyBtn.textContent="‚úÖ";setTimeout(()=>copyBtn.textContent="üìã",1500)})})}

    if("serviceWorker" in navigator){navigator.serviceWorker.register("/service-worker.js").then(()=>console.log("SW enregistr√© ‚úÖ")).catch(err=>console.error("SW erreur:",err))}
    let deferredPrompt=null;window.addEventListener('beforeinstallprompt',(e)=>{e.preventDefault();deferredPrompt=e;const b=document.getElementById('installBtn');if(b)b.style.display='inline-flex'});
    document.getElementById('installBtn').addEventListener('click',async()=>{if(!deferredPrompt)return;deferredPrompt.prompt();await deferredPrompt.userChoice;deferredPrompt=null;document.getElementById('installBtn').style.display='none'});
    window.addEventListener('appinstalled',()=>{const b=document.getElementById('installBtn');if(b)b.style.display='none'});
    applyLang();
  });
  </script>

  <button id="installBtn" aria-label="Installer l‚Äôapplication">üì≤ Installer</button>
  <script>
// Mapping entre symboles et IDs CoinGecko
const COINGECKO_IDS = {
  ETH: "ethereum",
  BNB: "binancecoin",
  MATIC: "matic-network",
  AVAX: "avalanche-2",
  SOL: "solana",
  USDT: "tether",
  USDC: "usd-coin",
  DAI: "dai",
  WBTC: "wrapped-bitcoin",
  LINK: "chainlink",
  BONK: "bonk",
  RAY: "raydium"
};

async function updateUsdValue(){
  const amountEl = document.getElementById("amount");
  const tokenEl  = document.getElementById("currency");
  const usdEl    = document.getElementById("usdValue");

  if (!amountEl || !tokenEl || !usdEl) return;

  const amount = parseFloat(amountEl.value);
const raw = tokenEl.value;
const sym = raw.split("‚Äî")[0].trim();
const id = COINGECKO_IDS[sym];

  if (!amount || !id){
    usdEl.textContent = "‚âà 0.00 $ (index√© sur CoinGecko)";
    return;
  }

  try {
    const url = `${BACKEND}/price?symbol=${sym}`;
    const res = await fetch(url);
    const data = await res.json();
    const price = data.usd;
    const usdVal = (amount * price).toFixed(2);
    usdEl.textContent = `‚âà ${usdVal} $ (index√© sur CoinGecko)`;
  } catch(e){
    console.error("Erreur CoinGecko", e);
    usdEl.textContent = "(Erreur CoinGecko)";
  }
}

// Mettre √† jour quand on change le montant ou le token
document.getElementById("amount")?.addEventListener("input", updateUsdValue);
document.getElementById("currency")?.addEventListener("change", updateUsdValue);
</script>
  <script>
/* Fermer la liste de contacts par d√©faut et ne l‚Äôouvrir que via üìñ */
document.addEventListener('DOMContentLoaded', () => {
  const box = document.getElementById('contactsList');
  const btn = document.getElementById('showContacts');
  if (!box) return;

  // 1) Toujours cach√© au chargement, m√™me s'il y a des contacts
  box.style.display = 'none';

  // 2) Ouvrir/fermer uniquement via le bouton üìñ
  if (btn) {
    btn.onclick = () => {
      box.style.display = (box.style.display === 'block') ? 'none' : 'block';
    };
  }
});
</script>
  <!-- ====== LINKISEND: START SCANNER INTERNE (EVM + SOL) ====== -->
<script>
(function(){
  const walletInput = document.getElementById('wallet');
  walletInput.value = '';
  const currencySel = document.getElementById('currency');

  /* --- Prix CoinGecko pour la ligne ‚Äú‚âà $‚Äù sous Token --- */
  const CG_ID = {
    ETH:'ethereum', BNB:'binancecoin', MATIC:'matic-network', AVAX:'avalanche-2', SOL:'solana',
    USDT:'tether', USDC:'usd-coin', DAI:'dai', WBTC:'wrapped-bitcoin', LINK:'chainlink',
    BONK:'bonk', RAY:'raydium'
  };
  async function setBalanceLine(symbol, amountStr){
  try{
    const id = CG_ID[symbol];
    if (!id){ 
      balInfoEl.textContent = ""; // rien en dessous si pas de prix
      return; 
    }
    const r = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${id}&vs_currencies=usd`);
    const j = await r.json();
    const p = j?.[id]?.usd;
    if (typeof p !== 'number'){ 
      balInfoEl.textContent = ""; 
      return; 
    }

    const usd = parseFloat(amountStr || "0") * p;
    balInfoEl.textContent = usd < 0.01 
      ? "‚âà < 0.01 $" 
      : `‚âà ${usd.toFixed(2)} $`;

  }catch{
    balInfoEl.textContent = "";
  }
}
  currencySel.addEventListener('change', ()=>{
    const opt = currencySel.options[currencySel.selectedIndex];
    if (!opt) return;
    const sym = opt.value;
    const amountStr = (opt.textContent || '').split(/‚Äî|‚Äì|-/).pop().trim();

    setBalanceLine(sym, amountStr);
  });

  /* --- Outils EVM --- */
  function toDecimalString(hexOrStr, decimals){
    if (hexOrStr == null) return "0";
    let big;
    if (typeof hexOrStr === "string" && hexOrStr.startsWith("0x")) big = BigInt(hexOrStr);
    else big = BigInt(String(hexOrStr));
    const d = BigInt(decimals);
    const base = 10n ** d;
    const intPart = big / base;
    const frac = big % base;
    if (frac === 0n) return intPart.toString();
    return `${intPart}.${frac.toString().padStart(Number(d),'0')}`.replace(/0+$/,'');
  }
  function erc20BalanceOfData(owner){
    return '0x70a08231' + owner.replace(/^0x/,'').padStart(64,'0');
  }
  function setSelect(items){
  const prev = currencySel.value;
  currencySel.innerHTML = '';
  items.forEach(it=>{
    const o = document.createElement('option');
    o.value = it.symbol;
    // ‚úÖ on s√©curise ici : si amountStr n‚Äôest pas un nombre ‚Üí 0
    const num = parseFloat(it.amountStr);
    const safe = isNaN(num) ? 0 : num;
    o.textContent = `${it.symbol} ‚Äî ${safe.toFixed(5)}`;
    currencySel.appendChild(o);
  });
  if (items.some(i=>i.symbol===prev)) currencySel.value = prev;
}

  /* --- Registres supports (mainnets) --- */
  const EVM = {
    '0x1': { native:{symbol:'ETH',dec:18}, tokens:{
      USDT:{addr:'0xdAC17F958D2ee523a2206206994597C13D831ec7',dec:6},
      USDC:{addr:'0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606EB48',dec:6},
      DAI :{addr:'0x6B175474E89094C44Da98b954EedeAC495271d0F',dec:18},
      WBTC:{addr:'0x2260FAC5E5542a773Aa44fBCfeDf7C193bc2C599',dec:8},
      LINK:{addr:'0x514910771AF9Ca656af840dff83E8264EcF986CA',dec:18}
    }},
    '0x38': { native:{symbol:'BNB',dec:18}, tokens:{
      USDT:{addr:'0x55d398326f99059Ff775485246999027B3197955',dec:18},
      USDC:{addr:'0x8ac76a51cc950d9822d68b83fe1ad97b32cd580d',dec:18},
      DAI :{addr:'0x1AF3F329e8BE154074D8769D1FFa4eE058B1DBc3',dec:18},
      WBTC:{addr:'0x7130d2A12B9BCbFAe4f2634d864A1Ee1Ce3Ead9c',dec:18},
      LINK:{addr:'0xF8A0BF9cF54Bb92F17374d9e9A321E6a111a51bD',dec:18}
    }},
    '0x89': { native:{symbol:'MATIC',dec:18}, tokens:{
      USDT:{addr:'0xC2132D05D31c914a87C6611C10748AaCbD9b0f',dec:6},
      USDC:{addr:'0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174',dec:6},
      DAI :{addr:'0x8f3Cf7ad23Cd3CaDbD9735AFf958023239c6A063',dec:18},
      WBTC:{addr:'0x1BFD67037B42Cf73acF2047067bd4F2C47D9BfD6',dec:8},
      LINK:{addr:'0x53E0bca35eC356BD5ddDFebbD1Fc0fD03Fabad39',dec:18}
    }},
    '0xa86a': { native:{symbol:'AVAX',dec:18}, tokens:{
      USDT:{addr:'0x9702230A8Ea53601f5cD2dc00fDBc13d4dF4A8c7',dec:6},
      USDC:{addr:'0xB97EF9Ef8734C71904D8002F8b6Bc66Dd9c48a6E',dec:6},
      DAI :{addr:'0xd586E7F844cEa2F87f50152665BCbc2C279D8d70',dec:18},
      WBTC:{addr:'0x50b7545627a5162F82A992c33b87aDc75187B218',dec:8},
      LINK:{addr:'0x5947BB275c521040051D82396192181b413227A3',dec:18}
    }}
  };
  const NATIVE_FALLBACK = { // pour testnets ou r√©seau non mapp√© ‚Üí on montre au moins le natif
    '0x1':'ETH','0x5':'ETH','0xaa36a7':'ETH',
    '0x38':'BNB','0x61':'BNB',
    '0x89':'MATIC','0x13881':'MATIC',
    '0xa86a':'AVAX','0xa869':'AVAX'
  };
  const DEFAULT_EVM_TOKENS = ['USDT','USDC','DAI','WBTC','LINK'];

  async function scanEvm(eth, account){
    let chainId;
    try{ chainId = await eth.request({method:'eth_chainId'}); }catch{ chainId = undefined; }

    const reg = chainId ? EVM[chainId] : undefined;
    const items = [];

    // Natif
    let natSymbol = (chainId && (reg?.native?.symbol || NATIVE_FALLBACK[chainId])) || 'ETH';
    let natDec    = (reg?.native?.dec) ?? 18;
    let nativeHex = '0x0';
    try{ nativeHex = await eth.request({method:'eth_getBalance', params:[account,'latest']}); }catch{}
    const natStr = toDecimalString(nativeHex, natDec);
    items.push({symbol:natSymbol, amountStr:natStr, amountNum:parseFloat(natStr||'0')});

    // ERC20 (soit adresses connues du r√©seau, soit tokens par d√©faut √† 0 si r√©seau inconnu)
    if (reg){
      const data = erc20BalanceOfData(account);
      for (const [sym,tok] of Object.entries(reg.tokens)){
        try{
          const hex = await eth.request({method:'eth_call', params:[{to:tok.addr,data},'latest']});
          const str = toDecimalString(hex, tok.dec);
          items.push({symbol:sym, amountStr:str, amountNum:parseFloat(str||'0')});
        }catch{
          items.push({symbol:sym, amountStr:'0', amountNum:0});
        }
      }
    } else {
      for (const sym of DEFAULT_EVM_TOKENS){
        items.push({symbol:sym, amountStr:'0', amountNum:0});
      }
    }

    items.sort((a,b)=> b.amountNum - a.amountNum);
    setSelect(items);
    const first = items[0]; if (first) setBalanceLine(first.symbol, first.amountStr);
  }

  /* --- Solana (SOL + quelques SPL connus) --- */
  const SOLANA_RPC = "https://api.mainnet-beta.solana.com";
  const TOKEN_PROGRAM_ID = "TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA";
  const SOLANA = {
    native:{symbol:'SOL',dec:9},
    tokens:{
      USDC:{mint:'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v',dec:6},
      USDT:{mint:'Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB',dec:6},
      BONK:{mint:'DezXAZ8z7PnrnRJjz3wXBoRgixCa6xjnB7YaB1pPB263',dec:5},
      RAY :{mint:'4k3Dyjzvzp8eMZWUXbBCaJXipqAVCbi6y5b9VPVuyV7y',dec:6}
    }
  };
  async function solanaRpc(body){
    const r = await fetch(SOLANA_RPC,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    return r.json();
  }
  async function scanSolana(address){
    const items = [];

    // SOL
    let lamports = 0;
    try{
      const r = await solanaRpc({jsonrpc:"2.0", id:1, method:"getBalance", params:[address]});
      lamports = r?.result?.value || 0;
    }catch{}
    const solStr = (lamports/1e9).toString();
    items.push({symbol:'SOL', amountStr:solStr, amountNum:parseFloat(solStr||'0')});

    // Comptes SPL de l‚Äôadresse
    let accs = [];
    try{
      const r = await solanaRpc({
        jsonrpc:"2.0", id:2, method:"getTokenAccountsByOwner",
        params:[address, { programId: TOKEN_PROGRAM_ID }, { encoding:"jsonParsed" }]
      });
      accs = r?.result?.value || [];
    }catch{}

    const found = {};
    for(const a of accs){
      const info = a?.account?.data?.parsed?.info;
      const mint = info?.mint;
      const ui   = info?.tokenAmount?.uiAmount || 0;
      found[mint] = ui;
    }

    for (const [sym,t] of Object.entries(SOLANA.tokens)){
      const ui = found[t.mint] ?? 0;
      const str = (typeof ui === 'number') ? ui.toString() : String(ui);
      items.push({symbol:sym, amountStr:str, amountNum:parseFloat(str||'0')});
    }

    items.sort((a,b)=> b.amountNum - a.amountNum);
    setSelect(items);
    const first = items[0]; if (first) setBalanceLine(first.symbol, first.amountStr);
  }
  // Lancement imm√©diat + surveillance des changements d‚Äôadresse
  let last = walletInput.value;
  setInterval(()=>{
    const cur = walletInput.value;
  }, 1000);

  // √âcoute EVM (si disponible)
  const eth = (window.ethereum && Array.isArray(window.ethereum.providers))
    ? window.ethereum.providers.find(p => p && (p.isMetaMask || p.isCoinbaseWallet || p.isRabby))
    : window.ethereum;
  if (eth && eth.on){
  }
})();
</script>
<!-- ====== LINKISEND: END SCANNER INTERNE ====== -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const tokenSelect = document.getElementById("currency");
  if (!tokenSelect) return;

  const tokens = ["ETH", "USDT", "USDC", "DAI", "MATIC", "BNB", "AVAX"];
  tokens.forEach(sym => {
    const opt = document.createElement("option");
    opt.value = sym;
    opt.textContent = sym;
    tokenSelect.appendChild(opt);
  });
});
</script>
  <script src="/vendor/libphonenumber-js.min.js"></script>
</body>
</html>
