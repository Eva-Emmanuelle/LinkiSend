<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>LinkiSend — Envoyer des cryptos</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
 <style>
  :root{
    --brand:#27ae60;           /* vert principal (boutons) */
    --brand-press:#219653;     /* vert pressé */
    --accent:#5a2ca0;          /* violet secondaire éventuel */
    --text:#e5e7eb;
    --muted:#9ca3af;
    --bg:#0f172a;              /* ardoise foncé */
    --card:#0b1020;            /* carte foncée */
    --ring:rgba(39,174,96,.35);
  }

  *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}

  body{
    margin:0; background:linear-gradient(180deg,#0a0f1f,#0f172a 60%);
    color:var(--text);
  }

  .wrap{max-width:480px;margin:32px auto;padding:0 16px}
  .card{
    background:var(--card);
    border:1px solid rgba(255,255,255,.06);
    border-radius:16px; padding:24px; box-shadow:0 10px 30px rgba(0,0,0,.35)
  }

  h1{display:flex;align-items:center;gap:10px;margin:0 0 18px}
  h2{margin:0 0 6px;font-size:22px}
  p.helper{margin:0 0 18px;color:var(--muted);font-size:14px}

  label{display:block;margin:12px 0 6px;font-size:13px;color:#cbd5e1}
  input,select{
    width:100%;padding:12px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.08);
    background:#0f1a32;color:var(--text);outline:none
  }
  input:focus,select:focus{border-color:var(--ring);box-shadow:0 0 0 4px var(--ring)}

  .wallet-row{display:flex;gap:10px}
  .wallet-row input{flex:1}
  .btn{
    width:100%;display:inline-flex;justify-content:center;align-items:center;gap:8px;
    padding:12px 14px;border:0;border-radius:12px;
    background:linear-gradient(90deg,var(--brand),#32d36c);
    color:white;font-weight:600;cursor:pointer;transition:transform .04s ease,filter .2s ease
  }
  .btn:active{transform:translateY(1px);filter:brightness(.95)}
  .btn[disabled]{opacity:.6;cursor:not-allowed}

  /* ENCART Lien généré — fort contraste */
  .result{
    margin-top:14px; padding:14px 16px; border-radius:12px;
    background:rgba(39,174,96,.12);              /* léger fond vert */
    border:1px solid rgba(39,174,96,.55);        /* bordure verte visible */
    color:#d1fae5;                                /* texte très clair */
    word-break:break-word;
  }
  .result strong{display:block;margin-bottom:6px;color:#bbf7d0}
  .result a{
    color:#86efac;                               /* vert clair lisible */
    text-decoration:underline;
  }
  .result a:hover{opacity:.9;text-decoration:none}

  /* petite pastille sous le bouton */
  .note{margin-top:8px;color:#94a3b8;font-size:12.5px}
</style>

</head>
<body>
  <!-- CONFIG (URL backend) -->
  <script src="config.js"></script>

  <div class="wrap">
    <div class="brand">
      <img src="assets/branding/logo-arrow.svg" alt="Flèche" class="arrow" />
      <img src="assets/branding/logo-word.svg" alt="LinkiSend" class="word" />
    </div>

    <div class="card" role="region" aria-label="Formulaire d’envoi">
      <h2>Envoyer des cryptos</h2>
      <p class="sub">Génère un lien en 10&nbsp;secondes.</p>

      <!-- 1) WALLET EN PREMIER -->
      <label for="wallet">Ton wallet (expéditeur)</label>
      <input type="text" id="wallet" placeholder="0xABCDEF..." autocomplete="off" />
      <a href="#" id="connectWalletLink" class="wallet-link" aria-haspopup="dialog">Connecter un wallet</a>

      <!-- 2) TOKEN & MONTANT -->
      <div class="row">
        <div class="col">
          <label for="currency">Token</label>
          <select id="currency">
            <option>USDT</option><option>USDC</option><option>ETH</option>
            <option>BTC</option><option>SOL</option><option>BNB</option>
            <option>AVAX</option><option>DAI</option><option>LINK</option>
          </select>
        </div>
        <div class="col">
          <label for="amount">Montant (crypto)</label>
          <input type="number" id="amount" inputmode="decimal" min="0" step="0.00001" placeholder="0.01" />
        </div>
      </div>

      <!-- 3) RÉSEAU -->
      <label for="network">Réseau</label>
      <select id="network">
        <option>Ethereum</option><option>BNB Chain</option>
        <option>Polygon</option><option>Solana</option><option>Avalanche</option>
      </select>

      <!-- 4) TÉLÉPHONE EN DERNIER -->
      <label for="phone">Numéro du destinataire</label>
      <input type="text" id="phone" placeholder="+33..." inputmode="tel" />

      <button id="generateBtn" class="btn">Générer le lien</button>

      <p class="hint">Aucun transfert on-chain n’est effectué tant que le lien n’est pas réclamé.</p>

      <div id="result" class="result" style="display:none"></div>
      <div id="error"  class="error"  style="display:none"></div>
    </div>
  </div>

  <!-- Modal choix wallet -->
  <div class="modal" id="walletModal" role="dialog" aria-modal="true" aria-labelledby="walletModalTitle">
    <div class="modal-card">
      <div class="modal-head">
        <h3 id="walletModalTitle">Connecter un wallet</h3>
        <button class="x" id="walletModalClose" aria-label="Fermer">✕</button>
      </div>
      <div class="providers">
        <button class="pv" data-wallet="metamask">
          <img src="assets/wallets/metamask.svg" alt="MetaMask" />
          MetaMask <span class="tag">EVM</span>
        </button>
        <button class="pv" data-wallet="walletconnect">
          <img src="assets/wallets/walletconnect.svg" alt="WalletConnect" />
          WalletConnect <span class="tag">Bientôt</span>
        </button>
        <button class="pv" data-wallet="coinbase">
          <img src="assets/wallets/coinbase.svg" alt="Coinbase Wallet" />
          Coinbase Wallet <span class="tag">Bientôt</span>
        </button>
        <button class="pv" data-wallet="phantom">
          <img src="assets/wallets/phantom.svg" alt="Phantom" />
          Phantom <span class="tag">Solana</span>
        </button>
      </div>
    </div>
  </div>

  <script>
    // Config backend (fallback localhost)
    const BACKEND = (window.LINKISEND_CONFIG && window.LINKISEND_CONFIG.BACKEND_BASE)
      ? window.LINKISEND_CONFIG.BACKEND_BASE
      : `${location.protocol}//${location.hostname}:8000`;

    // Elements
    const resultDiv = document.getElementById('result');
    const errorDiv  = document.getElementById('error');
    const walletInput = document.getElementById('wallet');

    // Modal helpers
    const modal = document.getElementById('walletModal');
    const openModal = () => { modal.classList.add('open'); };
    const closeModal = () => { modal.classList.remove('open'); };

    document.getElementById('connectWalletLink').addEventListener('click', (e)=>{
      e.preventDefault(); openModal();
    });
    document.getElementById('walletModalClose').addEventListener('click', closeModal);
    modal.addEventListener('click', (e)=>{ if (e.target === modal) closeModal(); });

    // Choix provider
    modal.querySelectorAll('.pv').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const provider = btn.getAttribute('data-wallet');
        if(provider === 'metamask'){
          if(!window.ethereum){ alert("MetaMask non détecté."); return; }
          try{
            const accounts = await window.ethereum.request({ method:'eth_requestAccounts' });
            if(accounts && accounts[0]) walletInput.value = accounts[0];
            closeModal();
          }catch(e){ alert("Connexion refusée."); }
        }else{
          alert("Connexion via " + provider + " arrive bientôt.");
        }
      });
    });

    // Génération du lien
    document.getElementById('generateBtn').addEventListener('click', async ()=>{
      const amount = parseFloat(document.getElementById('amount').value);
      const currency = document.getElementById('currency').value;
      const sender_wallet = walletInput.value.trim();
      const recipient_phone = document.getElementById('phone').value.trim();
      const network = document.getElementById('network').value;

      resultDiv.style.display='none';
      errorDiv.style.display='none';

      if (!amount || !currency || !sender_wallet || !recipient_phone || !network){
        errorDiv.textContent = "Merci de remplir tous les champs obligatoires.";
        errorDiv.style.display='block';
        return;
      }

      try{
        const res = await fetch(`${BACKEND}/create-link`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ amount, currency, sender_wallet, recipient_phone, network })
        });
        const data = await res.json();
        if(!res.ok) throw new Error(data.detail || "Erreur lors de la génération du lien");

        const lien = `${BACKEND}/s/${data.short_id}`;
        resultDiv.innerHTML = `<b>Lien généré :</b><br><a href="${lien}" target="_blank" rel="noopener">${lien}</a>`;
        resultDiv.style.display='block';
      }catch(err){
        errorDiv.textContent = err.message || 'Erreur réseau';
        errorDiv.style.display='block';
      }
    });
  </script>
</body>
</html>
