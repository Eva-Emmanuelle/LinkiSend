<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>LinkiSend ‚Äî Envoyer des cryptos</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <!-- PWA -->
<link rel="manifest" href="manifest.json">
  <!-- PWA iOS (splash & mode app) -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="assets/icons/icon-maskable-512.png">
<meta name="theme-color" content="#0b0f14">
  <style>
    :root{
      --bg:#0b0f14;--bg-soft:#0f141b;--card:#121821;--card-2:#0f1620;
      --text:#e6edf3;--text-dim:#9fb0c0;--stroke:#1f2a37;--focus:#334155;
      --shadow:0 12px 40px rgba(0,0,0,.45);--radius:14px;--radius-sm:10px;--gap:12px;
    }
    *,*:before,*:after{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif;
      background:
        radial-gradient(1200px 600px at 20% -10%,#132034 0%,transparent 60%),
        radial-gradient(900px 500px at 110% 0%,#1a2334 0%,transparent 60%),
        var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
    }
    .wrap{max-width:420px;margin:40px auto 64px;padding:0 16px;}
    .brand{display:flex;align-items:center;justify-content:center;margin-bottom:18px;position:relative;}
    .brand img.word{max-width:240px;height:auto;display:block;}
    .brand img.arrow{position:absolute;left:0;top:50%;transform:translateY(-50%);max-width:60px;height:auto;}
    .lang-toggle{
      position:absolute;right:0;top:50%;transform:translateY(-50%);
      font-size:12px;color:#9fb0c0;cursor:pointer;border:1px solid var(--stroke);
      padding:4px 8px;border-radius:999px;background:#0e141c;
    }
    .lang-toggle:hover{background:#101924}

    .card{
      background:linear-gradient(180deg,var(--card),var(--card-2));
      border:1px solid var(--stroke);border-radius:var(--radius);
      box-shadow:var(--shadow);padding:18px 16px;
    }
    .card h2{margin:4px 2px 2px;font-size:22px;font-weight:750;}
    .sub{color:var(--text-dim);margin:0 2px 14px;font-size:13px;}
    .row{display:flex;gap:var(--gap)}
    .col{flex:1}
    label{display:block;margin:10px 2px 6px;font-size:13px;color:var(--text-dim);}
    select,input{
      width:100%;height:44px;padding:10px 12px;border-radius:var(--radius-sm);
      border:1px solid var(--stroke);background:#0e141c;color:var(--text);outline:none;
    }
    select:focus,input:focus{border-color:var(--focus);box-shadow:0 0 0 3px rgba(51,65,85,.35);}
    .hint{font-size:12px;color:var(--text-dim);margin:6px 2px 0}
    .btn{
      width:100%;height:46px;border:0;border-radius:12px;font-weight:700;font-size:15px;cursor:pointer;
      background:radial-gradient(circle at 20% 20%,#8b5cf6,#06b6d4,#22c55e);color:#fff;
      box-shadow:0 10px 24px rgba(34,197,94,.2);margin-top:14px;
    }
    .btn:hover{box-shadow:0 12px 32px rgba(34,197,94,.28)}
    .btn:active{transform:translateY(1px)}
    .wallet-link{
      display:inline-flex;align-items:center;gap:8px;color:#93c5fd;text-decoration:none;font-weight:600;font-size:14px;
      padding:8px 10px;border-radius:10px;border:1px dashed var(--stroke);background:#0a1220;margin:8px 2px 4px;width:max-content;
    }
    .wallet-link:hover{background:#0d1729}

    .result,.error{
      margin:14px 2px 0;padding:10px 12px;border-radius:10px;font-size:13px;border:1px solid var(--stroke);
    }
    .error{background:#fee2e2;color:#991b1b;border:1px solid #f87171;}
    .result-cta{
      margin:14px 2px 0;padding:16px;border-radius:14px;background:#ecfdf5;border:1px solid #bbf7d0;color:#064e3b;display:none;
    }
    .row-cta{display:flex;gap:10px;align-items:stretch;flex-wrap:wrap}
    .linkbox{flex:1 1 auto;min-width:260px;background:#ffffff;border:1px dashed #a7f3d0;border-radius:10px;padding:12px 14px;display:flex;align-items:center}
    .linkbox code{font-family:ui-monospace,Menlo,Consolas,"Roboto Mono",monospace;font-size:16px;color:#065f46;white-space:nowrap;overflow:auto}

    .toast{
      position:fixed;right:16px;bottom:16px;background:#10b981;color:white;padding:10px 14px;border-radius:10px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);opacity:0;transform:translateY(6px);transition:opacity .2s,transform .2s;z-index:60;
    }
    .toast.show{opacity:1;transform:translateY(0)}

    /* Modal */
    .modal { position:fixed; inset:0; display:none; place-items:center;background:rgba(3,6,12,.6); backdrop-filter:blur(4px); z-index:50; padding:20px; }
    .modal.open{display:grid;}
    .modal-card{width:min(420px,95vw);background:linear-gradient(180deg,var(--card),var(--card-2));border:1px solid var(--stroke);border-radius:16px;box-shadow:var(--shadow);padding:16px;}
    .modal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .modal-head h3{margin:0;font-size:18px}
    .x{appearance:none;border:0;background:transparent;color:var(--text-dim);font-size:22px;cursor:pointer}
    .providers{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
    .pv{
      display:flex;align-items:center;gap:10px;padding:10px;border:1px solid var(--stroke);
      border-radius:12px;background:#0e141c;color:var(--text);cursor:pointer;font-weight:600
    }
    .pv img{width:20px;height:20px}
    .tag{
      margin-left:auto;font-size:11px;padding:2px 6px;border-radius:999px;
      background:linear-gradient(90deg,#8b5cf6,#06b6d4,#22c55e);
      color:#fff;border:0;font-weight:600;
    }
    .pv:hover{background:#101924}

    /* Phone & contacts */
    .phone-row{display:flex;gap:8px;align-items:center}
    .dial{position:relative;display:flex}
    .dial-btn{
      height:36px;padding:0 10px;border-radius:8px;border:1px solid var(--stroke);background:#0a1220;color:#e6edf3;
      display:inline-flex;align-items:center;gap:6px;cursor:pointer;
    }
    .dial-btn:hover{background:#0d1729}
    .dial-panel{
      position:absolute;left:0;top:44px;z-index:30;width:260px;background:#0d1420;border:1px solid var(--stroke);
      border-radius:10px;box-shadow:var(--shadow);display:none;
    }
    .dial-head{display:flex;align-items:center;gap:6px;padding:8px 10px;border-bottom:1px solid rgba(255,255,255,.06)}
    .dial-search-input{flex:1;height:32px;border:1px solid var(--stroke);background:#0e141c;color:#e6edf3;border-radius:8px;padding:0 8px;outline:none}
    .dial-list{max-height:260px;overflow:auto}
    .dial-item{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.04);cursor:pointer}
    .dial-item:last-child{border-bottom:0}
    .iso{font-weight:600;color:#e6edf3;width:26px;display:inline-block}
    .dialcode{color:#cfe1ff}
    .country{color:#9fb0c0;font-size:12px}

    .contact-actions{display:flex;gap:8px;margin-top:6px}
    .emoji-btn{cursor:pointer;font-size:18px}
    .contacts{margin-top:8px;display:none}
    .contact-item{padding:6px 8px;border:1px solid var(--stroke);border-radius:8px;margin-top:6px;cursor:pointer;font-size:13px;}
    .contact-item:hover{background:#101924}
    /* === Fix mobile header: emp√™cher le chevauchement logo/texte === */
@media (max-width: 540px){
  .brand{
    justify-content:flex-start !important;   /* plus centr√©, on aligne √† gauche */
    gap:8px !important;
    margin:10px 0 20px !important;
    padding:0 8px;
  }
  .brand img.arrow{
    position:static !important;              /* on annule la position absolue */
    transform:none !important;
    max-width:28px !important;               /* taille fixe petite */
    height:auto !important;
    margin-right:6px;
  }
  .brand img.word{
    max-width:170px !important;              /* r√©duit le mot "LinkiSend" */
  }
  .lang-toggle{
    right:8px !important;                    /* bouton langue un peu √† droite */
    font-size:11px;
    padding:3px 8px;
  }
}
    /* Bouton d'installation PWA (mobile) */
#installBtn{
  position:fixed;right:14px;bottom:90px;z-index:80;
  display:none;align-items:center;gap:8px;
  padding:10px 14px;border-radius:999px;border:1px solid var(--stroke);
  background:#0e141c;color:#e6edf3;font-weight:700;cursor:pointer;
  box-shadow:var(--shadow);
}
#installBtn:active{transform:translateY(1px)}
    /* Splash */
#splash{
  position:fixed; inset:0; z-index:9999;
  display:grid; place-items:center;
  background: radial-gradient(1200px 600px at 20% -10%,#132034 0%,transparent 60%),
              radial-gradient(900px 500px at 110% 0%,#1a2334 0%,transparent 60%),
              var(--bg);
  transition: opacity .35s ease;
}
#splash img{
  width: 300px;   /* √©tait 120px */
  height: auto;
  filter: drop-shadow(0 12px 30px rgba(0,0,0,.35));
  opacity:.96;
}
#splash.hide{ opacity:0; pointer-events:none; }
    /* --- Fix modal on small screens --- */
.modal{
  padding: env(safe-area-inset-top) 16px env(safe-area-inset-bottom) 16px;
}
.modal-card{
  width: min(440px, 92vw);
  max-height: 88vh;        /* emp√™che de d√©passer verticalement */
  overflow: auto;          /* scroll interne si besoin */
}
@media (max-width: 380px){
  .modal-card{ width: 94vw; }
  .providers{ grid-template-columns: 1fr !important; } /* 1 colonne sur tr√®s petit √©cran */
}
@media (max-height: 640px){
  .modal-card{ max-height: 84vh; } /* un peu plus compact si la hauteur est faible */
}
  </style>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const s = document.getElementById('splash');
  if (!s) return;

  // Mode standalone (PWA install√©e) ?
  const isStandalone =
    (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) ||
    (window.navigator.standalone === true);

  if (isStandalone) {
    // Laisse Android/iOS g√©rer leur propre splash, retire le n√¥tre
    s.remove();
    return;
  }

  let done = false;
  function hideSplash() {
    if (done) return;
    done = true;
    s.classList.add('hide');
    setTimeout(() => s.remove(), 400);
  }

  // Normal : masque au chargement
  window.addEventListener('load', hideSplash);

  // S√©curit√© : force apr√®s 1200 ms
  setTimeout(hideSplash, 1200);
});
</script>
</head>
<body>
  <body>
<script>
// Gate d'installation PWA : bloque l'usage si l'app n'est pas install√©e
(function () {
  const isStandalone =
    (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) ||
    (window.navigator.standalone === true);

  if (isStandalone) return; // App install√©e : on laisse charger le reste

  function browserHelp() {
    const ua = navigator.userAgent.toLowerCase();
    if (ua.includes('samsungbrowser')) {
      return "Sur Samsung Internet : menu ‚ãÆ > Ajouter page √† > √âcran d'accueil.";
    } else if (ua.includes('firefox')) {
      return "Sur Firefox Android : menu ‚ãÆ > Installer.";
    } else if (ua.includes('crios') || ua.includes('iphone') || ua.includes('ipad')) {
      return "Sur iPhone/iPad (Safari) : bouton Partager ‚éã > Ajouter √† l‚Äô√©cran d‚Äôaccueil.";
    } else if (ua.includes('chrome')) {
      return "Sur Chrome Android : menu ‚ãÆ > Installer l‚Äôapplication (ou Ajouter √† l‚Äô√©cran d‚Äôaccueil).";
    }
    return "Ouvre le menu du navigateur et choisis ¬´ Ajouter √† l‚Äô√©cran d‚Äôaccueil ¬ª ou ¬´ Installer l‚Äôapplication ¬ª.";
  }

  document.write(`
    <style>body > :not(#install-gate){display:none!important}</style>
    <div id="install-gate" style="
      min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;
      text-align:center;padding:24px;background:#0b0f14;color:#e6edf3;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;">
      <img src="assets/branding/logo-arrow.svg" alt="LinkiSend" style="width:96px;height:auto;margin-bottom:18px;opacity:.95;"/>
      <h2 style="margin:0 0 10px;font-size:22px;">Installe l‚Äôapp LinkiSend üì≤</h2>
      <p style="margin:0 0 16px;color:#9fb0c0;font-size:14px;max-width:340px;">
        Pour utiliser LinkiSend, installe l‚Äôapplication sur ton t√©l√©phone.
      </p>
      <button id="installNow" style="
        display:inline-flex;align-items:center;gap:8px;padding:10px 16px;border-radius:999px;
        border:1px solid #1f2a37;background:#0e141c;color:#e6edf3;font-weight:700;cursor:pointer;">
        üì≤ Installer l‚Äôapp
      </button>
      <div id="installHint" style="margin-top:10px;color:#9fb0c0;font-size:12px;">
        ${browserHelp()}
      </div>
    </div>
  `);

  // On capte la prompt si le navigateur la fournit
  let _deferred = null;
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    _deferred = e;
  });

  // Clic sur le bouton : on tente la prompt ; sinon on affiche une aide claire
  window.addEventListener('click', async (ev) => {
    const btn = document.getElementById('installNow');
    if (!btn || ev.target !== btn) return;

    if (_deferred) {
      _deferred.prompt();
      try { await _deferred.userChoice; } catch {}
      _deferred = null;
    } else {
      alert(document.getElementById('installHint').textContent);
    }
  });
})();
</script>
  <!-- Splash screen -->
<div id="splash">
  <img src="assets/branding/logo-arrow.svg" alt="LinkiSend" />
</div>
  <!-- CONFIG (URL backend) -->
  <script src="config.js"></script>
  <!-- Pays + indicatifs (EN/FR) -->
  <script src="countries.js"></script>

  <div class="wrap">
    <div class="brand">
      <img src="assets/branding/logo-arrow.svg" alt="Fl√®che" class="arrow" />
      <img src="assets/branding/logo-word.svg" alt="LinkiSend" class="word" />
      <span id="langToggle" class="lang-toggle">FR / EN</span>
    </div>

    <div class="card" role="region" aria-label="Formulaire d‚Äôenvoi">
      <h2 id="title">Envoyer des cryptos</h2>
      <p class="sub" id="subtitle">G√©n√®re un lien en 10&nbsp;secondes.</p>

      <!-- 1) WALLET -->
      <label for="wallet" id="lbl-wallet">Ton wallet (exp√©diteur)</label>
      <input type="text" id="wallet" placeholder="0xABCDEF..." autocomplete="off" />
      <a href="#" id="connectWalletLink" class="wallet-link" aria-haspopup="dialog">Connecter un wallet</a>

      <!-- 2) TOKEN & MONTANT -->
      <div class="row">
        <div class="col">
          <label for="currency" id="lbl-token">Token</label>
          <select id="currency">
            <option>USDT</option><option>USDC</option><option>ETH</option>
            <option>BTC</option><option>SOL</option><option>BNB</option>
            <option>AVAX</option><option>DAI</option><option>LINK</option>
          </select>
        </div>
        <div class="col">
          <label for="amount" id="lbl-amount">Montant</label>
          <input type="number" id="amount" inputmode="decimal" min="0" step="0.00001" placeholder="0.01" />
        </div>
      </div>

      <!-- 3) R√âSEAU -->
      <label for="network" id="lbl-network">R√©seau</label>
      <select id="network">
        <option>Ethereum</option><option>BNB Chain</option>
        <option>Polygon</option><option>Solana</option><option>Avalanche</option>
      </select>

      <!-- 4) T√âL√âPHONE -->
      <label id="lbl-phone">Num√©ro du destinataire</label>
      <div class="phone-row">
        <div class="dial">
          <button id="dialBtn" class="dial-btn"><span class="iso">FR</span><span id="dialCode">+33</span></button>
          <div id="dialPanel" class="dial-panel">
            <div class="dial-head"><input id="dialSearch" class="dial-search-input" placeholder="Rechercher..."/></div>
            <div id="dialList" class="dial-list"></div>
          </div>
        </div>
        <input type="text" id="phone" placeholder="612345678" inputmode="tel"/>
      </div>

      <!-- üìñ/üíæ actions contacts -->
      <div class="contact-actions">
        <span class="emoji-btn" id="showContacts" title="Afficher les contacts">üìñ</span>
        <span class="emoji-btn" id="saveContact" title="Enregistrer ce num√©ro">üíæ</span>
      </div>
      <div class="contacts" id="contactsList"></div>

      <button id="generateBtn" class="btn">G√©n√©rer le lien</button>

      <p class="hint" id="hint">Aucun transfert on-chain n‚Äôest effectu√© tant que le lien n‚Äôest pas r√©clam√©.</p>

      <!-- Bloc r√©sultat -->
<div id="result" class="result-cta" aria-live="polite">
  <h3 id="resultTitle" style="margin:0 0 10px;font-size:18px;">Lien pr√™t ‚úÖ</h3>
  <div class="row-cta" style="display:inline-flex;align-items:center;">
  <code id="the-link"></code>
  <span id="copyLinkBtn" style="cursor:pointer;margin-left:4px;" title="Copier">üìã</span>
</div>
  <div class="sub-cta" id="validityText" style="margin-top:10px;">
    ‚è≥ Validit√© : 24h ‚Ä¢ Aucun transfert on-chain n‚Äôa lieu tant que le lien n‚Äôest pas r√©clam√©.
  </div>
</div>
      <!-- Erreurs -->
      <div id="error"  class="error"  style="display:none"></div>
    </div>
  </div>

  <!-- Toast copie (conserv√© au cas o√π) -->
  <div class="toast" id="toast">Lien copi√© ‚úÖ</div>

  <!-- Modal choix wallet (inchang√©e) -->
  <div class="modal" id="walletModal" role="dialog" aria-modal="true" aria-labelledby="walletModalTitle">
    <div class="modal-card">
      <div class="modal-head">
        <h3 id="walletModalTitle">Connecter un wallet</h3>
        <button class="x" id="walletModalClose" aria-label="Fermer">‚úï</button>
      </div>
      <div class="providers">
        <button class="pv" data-wallet="metamask">
          <img src="assets/wallets/metamask.svg" alt="MetaMask" />
          MetaMask <span class="tag">EVM</span>
        </button>
        <button class="pv" data-wallet="walletconnect">
          <img src="assets/wallets/walletconnect.svg" alt="WalletConnect" />
          WalletConnect <span class="tag">Bient√¥t</span>
        </button>
        <button class="pv" data-wallet="coinbase">
          <img src="assets/wallets/coinbase.svg" alt="Coinbase Wallet" />
          Coinbase Wallet <span class="tag">Bient√¥t</span>
        </button>
        <button class="pv" data-wallet="phantom">
          <img src="assets/wallets/phantom.svg" alt="Phantom" />
          Phantom <span class="tag">Solana</span>
        </button>
      </div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', ()=> {
  // ====== Backend ======
  const BACKEND = (window.LINKISEND_CONFIG && window.LINKISEND_CONFIG.BACKEND_BASE)
    ? window.LINKISEND_CONFIG.BACKEND_BASE
    : `${location.protocol}//${location.hostname}:8000`;

  // ====== Elements ======
  const resultDiv = document.getElementById('result');
  const errorDiv  = document.getElementById('error');
  const walletInput = document.getElementById('wallet');
  const linkEl  = document.getElementById('the-link');

  // ====== Indicatifs ======
  const dialBtn = document.getElementById('dialBtn');
  const dialPanel = document.getElementById('dialPanel');
  const dialSearch = document.getElementById('dialSearch');
  const dialList = document.getElementById('dialList');
  let currentDial = { iso:"FR", code:"+33" };

  // ====== Langue (FR/EN) ======
  const langToggle = document.getElementById('langToggle');
  const userPref = localStorage.getItem('lang');
  let lang = userPref || ((navigator.language||'fr').toLowerCase().startsWith('fr') ? 'fr' : 'en');

  const t = {
    fr:{title:"Envoyer des cryptos",subtitle:"G√©n√®re un lien en 10 secondes.",wallet:"Ton wallet (exp√©diteur)",token:"Token",amount:"Montant",network:"R√©seau",phone:"Num√©ro du destinataire",hint:"Aucun transfert on-chain n‚Äôest effectu√© tant que le lien n‚Äôest pas r√©clam√©.",generate:"G√©n√©rer le lien",search:"Rechercher...",resultTitle:"Lien pr√™t ‚úÖ",validity:"‚è≥ Validit√© : 24h ‚Ä¢ Aucun transfert on-chain n‚Äôa lieu tant que le lien n‚Äôest pas r√©clam√©.",connectWallet:"Connecter un wallet",savePh:"Nom du contact",save:"Enregistrer",cancel:"Annuler",saved:"Contact enregistr√© ‚úÖ",needNumber:"Saisis un num√©ro avant."},
    en:{title:"Send crypto",subtitle:"Generate a link in 10 seconds.",wallet:"Your wallet (sender)",token:"Token",amount:"Amount",network:"Network",phone:"Recipient phone",hint:"No on-chain transfer happens until the link is claimed.",generate:"Generate link",search:"Search...",resultTitle:"Link ready ‚úÖ",validity:"‚è≥ Valid for 24h ‚Ä¢ No on-chain transfer until the link is claimed.",connectWallet:"Connect a wallet",savePh:"Contact name",save:"Save",cancel:"Cancel",saved:"Contact saved ‚úÖ",needNumber:"Enter a number first."}
  };

  function applyLang(){
    document.getElementById("title").textContent = t[lang].title;
    document.getElementById("subtitle").textContent = t[lang].subtitle;
    document.getElementById("lbl-wallet").textContent = t[lang].wallet;
    document.getElementById("lbl-token").textContent = t[lang].token;
    document.getElementById("lbl-amount").textContent = t[lang].amount;
    document.getElementById("lbl-network").textContent = t[lang].network;
    document.getElementById("lbl-phone").textContent = t[lang].phone;
    document.getElementById("hint").textContent = t[lang].hint;
    document.getElementById("generateBtn").textContent = t[lang].generate;
    document.getElementById("connectWalletLink").textContent = t[lang].connectWallet;
    document.getElementById("dialSearch").placeholder = t[lang].search;
    document.getElementById("resultTitle").textContent = t[lang].resultTitle;
    document.getElementById("validityText").textContent = t[lang].validity;
    document.getElementById("langToggle").textContent = (lang === 'fr') ? 'FR / EN' : 'EN / FR';
    if (dialPanel.style.display === 'block') renderDialList(dialSearch.value.toLowerCase());
    // MAJ textes du mini-formulaire contact
    if (saveNameInput) saveNameInput.placeholder = t[lang].savePh;
    if (saveConfirmBtn) saveConfirmBtn.textContent = `‚úÖ ${t[lang].save}`;
    if (saveCancelBtn) saveCancelBtn.textContent = `‚úñÔ∏è ${t[lang].cancel}`;
  }

  langToggle.addEventListener('click', ()=>{
    lang = (lang === 'fr') ? 'en' : 'fr';
    localStorage.setItem('lang', lang);
    applyLang();
  });

  // ====== Wallet Modal (inchang√©) ======
  const modal = document.getElementById('walletModal');
  const openModal = () => { modal.classList.add('open'); };
  const closeModal = () => { modal.classList.remove('open'); };
  document.getElementById('connectWalletLink').addEventListener('click', (e)=>{e.preventDefault(); openModal();});
  document.getElementById('walletModalClose').addEventListener('click', closeModal);
  modal.addEventListener('click', (e)=>{ if (e.target === modal) closeModal(); });

  modal.querySelectorAll('.pv').forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    const provider = btn.getAttribute('data-wallet');

    if(provider === 'metamask'){
      if(!window.ethereum){ alert("MetaMask non d√©tect√©."); return; }
      try{
        const accounts = await window.ethereum.request({ method:'eth_requestAccounts' });
        if(accounts && accounts[0]) walletInput.value = accounts[0];
        closeModal();
      }catch(e){ alert("Connexion refus√©e."); }
    } else if (provider === "phantom") {
      // Connexion Phantom
      if (window.solana && window.solana.isPhantom) {
        window.solana.connect()
          .then(resp => {
            const walletAddress = resp.publicKey.toString();
            walletInput.value = walletAddress;
            closeModal();
            alert("Phantom connect√© : " + walletAddress);
          })
          .catch(err => {
            console.error(err);
            alert("Connexion Phantom refus√©e ou erreur.");
          });
      } else {
        window.open("https://phantom.app/", "_blank");
      }
    } else {
      // Tous les autres wallets encore non impl√©ment√©s
      alert("Connexion via " + provider + " arrive bient√¥t.");
    }
  });
});

  // ====== Indicatifs (COUNTRIES) ======
  function renderDialList(f=""){
    dialList.innerHTML="";
    const filter = f.toLowerCase();
    COUNTRIES
      .filter(d =>
        !filter ||
        d.en.toLowerCase().includes(filter) ||
        d.fr.toLowerCase().includes(filter) ||
        d.code.includes(filter) ||
        d.iso.toLowerCase().includes(filter)
      )
      .forEach(d=>{
        const name = (lang === "fr") ? d.fr : d.en;
        const row = document.createElement("div");
        row.className = "dial-item";
        row.innerHTML = `<span class="iso">${d.iso}</span><span class="dialcode">${d.code}</span><span class="country">${name}</span>`;
        row.onclick = ()=>{
          currentDial = { iso:d.iso, code:d.code };
          dialBtn.innerHTML = `<span class="iso">${d.iso}</span><span id="dialCode">${d.code}</span>`;
          dialPanel.style.display = "none";
        };
        dialList.appendChild(row);
      });
  }

  // ‚Äî‚Äî‚Äî Indics: ouverture/fermeture robuste
  dialBtn.addEventListener('click', (e)=>{
    e.stopPropagation();
    dialPanel.style.display = (dialPanel.style.display === "block" ? "none" : "block");
    if (dialPanel.style.display === "block"){
      renderDialList("");
      dialSearch.value = "";
      dialSearch.focus();
    }
  });
  dialSearch.oninput = ()=> renderDialList(dialSearch.value);
  document.addEventListener("click", e=>{
    if(!dialPanel.contains(e.target) && !dialBtn.contains(e.target)){
      dialPanel.style.display="none";
    }
  });

  // ====== Contacts (localStorage) ======
  const contactsList = document.getElementById("contactsList");
  const showContacts = document.getElementById("showContacts");
  const saveContact = document.getElementById("saveContact");
  let contacts = JSON.parse(localStorage.getItem("contacts") || "[]");

  // Forcer l‚Äôemoji agenda üìñ
  if (showContacts) showContacts.textContent = "üìñ";

  function persistContacts(){ localStorage.setItem("contacts", JSON.stringify(contacts)); }

  function renderContacts(){
    contactsList.innerHTML = "";
    if(contacts.length === 0){ contactsList.style.display = "none"; return; }

    contacts.forEach((c, idx)=>{
      const row = document.createElement("div");
      row.className = "contact-item";
      row.style.display = "flex";
      row.style.alignItems = "center";
      row.style.justifyContent = "space-between";
      row.style.gap = "8px";

      const left = document.createElement("div");
      left.textContent = `${c.name} (${c.phone})`;
      left.style.flex = "1 1 auto";
      left.style.whiteSpace = "nowrap";
      left.style.overflow = "hidden";
      left.style.textOverflow = "ellipsis";

      const del = document.createElement("button");
      del.type = "button";
      del.title = (lang==='fr') ? "Supprimer" : "Delete";
      del.textContent = "üóëÔ∏è";
      del.style.border = "1px solid var(--stroke)";
      del.style.background = "#0a1220";
      del.style.color = "#ffffff";
      del.style.borderRadius = "6px";
      del.style.padding = "4px 6px";
      del.style.cursor = "pointer";
      del.style.flex = "0 0 auto";

      left.onclick = ()=>{
        document.getElementById("phone").value = c.phone.replace(c.code, "");
        currentDial = { iso:c.iso, code:c.code };
        dialBtn.innerHTML = `<span class="iso">${c.iso}</span><span id="dialCode">${c.code}</span>`;
        contactsList.style.display = "none";
      };

      del.onclick = (ev)=>{
        ev.stopPropagation();
        contacts.splice(idx, 1);
        persistContacts();
        renderContacts();
      };

      row.appendChild(left);
      row.appendChild(del);
      contactsList.appendChild(row);
    });
  }
  renderContacts();

  // ====== Mini-formulaire inline pour enregistrer un contact (remplace le prompt) ======
  const actionsBar = document.querySelector('.contact-actions');

  // conteneur
  const saveInline = document.createElement('div');
  saveInline.style.display = 'none';
  saveInline.style.marginTop = '8px';
  saveInline.style.padding = '10px';
  saveInline.style.border = '1px solid var(--stroke)';
  saveInline.style.borderRadius = '8px';
  saveInline.style.background = '#0e1420';
  saveInline.style.boxShadow = 'var(--shadow)';
  saveInline.style.gap = '8px';
  saveInline.style.alignItems = 'center';
  saveInline.style.justifyContent = 'space-between';

  // champ nom
  const saveNameInput = document.createElement('input');
  saveNameInput.type = 'text';
  saveNameInput.id = 'saveName';
  saveNameInput.placeholder = t[lang].savePh;
  saveNameInput.style.width = '100%';
  saveNameInput.style.padding = '8px 10px';
  saveNameInput.style.border = '1px solid var(--stroke)';
  saveNameInput.style.borderRadius = '6px';
  saveNameInput.style.background = '#0a1220';
  saveNameInput.style.color = '#e6edf3';
  saveNameInput.style.marginRight = '8px';

  // boutons
  const btnsWrap = document.createElement('div');
  btnsWrap.style.display = 'flex';
  btnsWrap.style.gap = '8px';
  btnsWrap.style.marginTop = '8px';

  const saveConfirmBtn = document.createElement('button');
  saveConfirmBtn.type = 'button';
  saveConfirmBtn.textContent = `‚úÖ ${t[lang].save}`;
  saveConfirmBtn.style.border = '1px solid var(--stroke)';
  saveConfirmBtn.style.background = '#0a1220';
  saveConfirmBtn.style.color = '#ffffff';
  saveConfirmBtn.style.borderRadius = '8px';
  saveConfirmBtn.style.padding = '6px 10px';
  saveConfirmBtn.style.cursor = 'pointer';

  const saveCancelBtn = document.createElement('button');
  saveCancelBtn.type = 'button';
  saveCancelBtn.textContent = `‚úñÔ∏è ${t[lang].cancel}`;
  saveCancelBtn.style.border = '1px solid var(--stroke)';
  saveCancelBtn.style.background = '#0a1220';
  saveCancelBtn.style.color = '#ffffff';
  saveCancelBtn.style.borderRadius = '8px';
  saveCancelBtn.style.padding = '6px 10px';
  saveCancelBtn.style.cursor = 'pointer';

  saveInline.appendChild(saveNameInput);
  btnsWrap.appendChild(saveConfirmBtn);
  btnsWrap.appendChild(saveCancelBtn);
  saveInline.appendChild(btnsWrap);

  // ins√©rer juste apr√®s la barre d'actions
  actionsBar.insertAdjacentElement('afterend', saveInline);

  // ouverture/fermeture du mini-formulaire
  function toggleSaveInline(open){
    saveInline.style.display = open ? 'block' : 'none';
    if (open){
      saveNameInput.value = '';
      saveNameInput.focus();
    }
  }

  // clic sur üìñ : aucune incidence
  showContacts.onclick = ()=>{
    contactsList.style.display = (contactsList.style.display === "block" ? "none" : "block");
    renderContacts();
  };

  // clic sur üíæ : ouvrir le mini-formulaire
  saveContact.onclick = ()=>{
    const num = document.getElementById("phone").value.trim();
    if(!num){ alert(t[lang].needNumber); return; }
    toggleSaveInline(true);
  };

  // Enregistrer
  saveConfirmBtn.onclick = ()=>{
    const num = document.getElementById("phone").value.trim();
    if(!num){ alert(t[lang].needNumber); return; }
    const pseudo = saveNameInput.value.trim();
    if(!pseudo){ saveNameInput.focus(); return; }
    const phone = currentDial.code + num;
    contacts.push({ name:pseudo, phone, iso:currentDial.iso, code:currentDial.code });
    persistContacts();
    renderContacts();
    toggleSaveInline(false);
    // petit feedback sans popup bloquante
    // (on garde un alert court si tu pr√©f√®res le retour visuel fort)
    // alert(t[lang].saved);
  };

  // Annuler
  saveCancelBtn.onclick = ()=> toggleSaveInline(false);

  // ====== G√©n√©ration du lien ======
  document.getElementById('generateBtn').addEventListener('click', async ()=>{
    const amount = parseFloat(document.getElementById('amount').value);
    const currency = document.getElementById('currency').value;
    const sender_wallet = walletInput.value.trim();
    const localPhone = document.getElementById('phone').value.trim();
    const recipient_phone = `${currentDial.code}${localPhone}`;
    const network = document.getElementById('network').value;

    resultDiv.style.display='none';
    errorDiv.style.display='none';

    if (!amount || !currency || !sender_wallet || !localPhone || !network){
      errorDiv.textContent = (lang==='fr')
        ? "Merci de remplir tous les champs obligatoires."
        : "Please fill in all required fields.";
      errorDiv.style.display='block';
      return;
    }

    try{
      const res = await fetch(`${BACKEND}/create-link`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ amount, currency, sender_wallet, recipient_phone, network })
      });
      const data = await res.json();
      if(!res.ok) throw new Error(data.detail || "Erreur lors de la g√©n√©ration du lien");

      const lien = `https://linkisend.io/${data.short_id}`;
      linkEl.textContent = lien;
      resultDiv.style.display='block';
    }catch(err){
      errorDiv.textContent = err.message || (lang==='fr'?'Erreur r√©seau':'Network error');
      errorDiv.style.display='block';
    }
  });
// Ic√¥ne "Copier le lien"
const copyBtn = document.getElementById('copyLinkBtn');
if (copyBtn) {
  copyBtn.addEventListener('click', ()=>{
    navigator.clipboard.writeText(linkEl.textContent).then(()=>{
      copyBtn.textContent = "‚úÖ";
      setTimeout(()=> copyBtn.textContent = "üìã", 1500);
    });
  });
}
  // === Service Worker ===
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/service-worker.js")
    .then(() => console.log("SW enregistr√© ‚úÖ"))
    .catch(err => console.error("SW erreur:", err));
}
  // === Bouton d'installation PWA ===
let deferredPrompt = null;

window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault();            // emp√™che l‚Äôinfobar automatique
  deferredPrompt = e;            // on garde la prompt
  const b = document.getElementById('installBtn');
  if (b) b.style.display = 'inline-flex';   // on affiche le bouton
});

document.getElementById('installBtn').addEventListener('click', async ()=>{
  if (!deferredPrompt) return;
  deferredPrompt.prompt();       // ouvre la bo√Æte ‚ÄúInstaller‚Äù
  await deferredPrompt.userChoice;
  deferredPrompt = null;
  document.getElementById('installBtn').style.display = 'none';
});

window.addEventListener('appinstalled', ()=>{
  const b = document.getElementById('installBtn');
  if (b) b.style.display = 'none';
});

  // ---- Appliquer la langue
  applyLang();
});
</script>
  <button id="installBtn" aria-label="Installer l‚Äôapplication">üì≤ Installer</button>
</body>
</html>
