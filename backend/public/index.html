<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>LinkiSend â€” Envoyer des cryptos</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <style>
    :root{
      --bg:#0c0c12;
      --card:#12121b;
      --muted:#8a8aa0;
      --text:#e9e9f1;
      --primary:#7c3aed;           /* violet */
      --accent:#22c55e;            /* vert */
      --danger:#ef4444;
      --border:#222231;
      --input:#1a1a25;
      --shadow:0 10px 30px #00000040;
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Arial,sans-serif}
    .wrap{max-width:480px;margin:24px auto;padding:0 14px}
    .brand{display:flex;align-items:center;gap:10px;margin:6px 0 14px}
    .brand-logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--primary),var(--accent));display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow)}
    .brand h1{font-size:20px;margin:0;font-weight:800;letter-spacing:.2px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px 14px;box-shadow:var(--shadow)}
    .title{font-size:16px;margin:2px 0 14px;color:#fff;font-weight:700}
    .row{display:flex;gap:10px}
    label{display:block;font-weight:700;font-size:13px;margin:10px 0 6px;color:#cfd0ff}
    select,input{width:100%;padding:12px 12px;border-radius:10px;border:1px solid var(--border);background:var(--input);color:var(--text);font-size:14px;outline:none}
    select:disabled,input:disabled{opacity:.6}
    .helper{font-size:12px;color:var(--muted);margin-top:6px}
    .btn{width:100%;padding:12px 14px;border:none;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--accent));color:#fff;font-weight:800;cursor:pointer;box-shadow:var(--shadow);transition:transform .05s}
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:#1b1b27;color:#dcdcf5;border:1px solid var(--border);font-weight:700}
    .btn.ghost{background:transparent;border:1px dashed var(--border);color:#cfcfed}
    .inline{display:flex;align-items:center;gap:10px}
    .pill{background:#171724;border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;color:#cfcfed}
    .status{margin:10px 0 0;font-size:13px;color:var(--muted)}
    .error{background:#220f10;border:1px solid #4d1e22;color:#ffb4b8;padding:10px;border-radius:10px;margin-top:12px;display:none}
    .success{background:#0f2216;border:1px solid #214d30;color:#b4ffd0;padding:10px;border-radius:10px;margin-top:12px;display:none}
    .divider{height:1px;background:var(--border);margin:14px 0}
    .summary{background:#0f1220;border:1px solid var(--border);border-radius:12px;padding:12px;font-size:14px;line-height:1.45}
    .pair{display:flex;justify-content:space-between;gap:8px;margin:6px 0}
    .pair b{color:#fff}
    .copy{padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:#141423;color:#d6d6ff;cursor:pointer;font-size:12px}
    .badge{font-size:11px;border:1px solid var(--border);padding:3px 8px;border-radius:999px;background:#171724;color:#bdbdf3}
    .muted{color:var(--muted)}
    .hidden{display:none !important}

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:#0008;display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
    .modal{width:100%;max-width:420px;background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
    .modal header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--border)}
    .modal header h3{margin:0;font-size:16px}
    .modal .content{padding:14px;display:grid;gap:10px}
    .wallet-opt{display:flex;align-items:center;gap:12px;padding:12px;border:1px solid var(--border);border-radius:12px;background:#151526;cursor:pointer}
    .wallet-opt:hover{border-color:#3a3a55}
    .wallet-opt .icon{width:28px;height:28px;border-radius:8px;background:#22223a;display:flex;align-items:center;justify-content:center}
    .wallet-opt .meta{display:flex;flex-direction:column}
    .wallet-opt .meta small{color:var(--muted)}
    .disabled{opacity:.6;cursor:not-allowed}
  </style>
</head>
<body>
  <!-- CONFIG CENTRALE (BACKEND_BASE) -->
  <script src="config.js"></script>

  <div class="wrap">
    <div class="brand">
      <div class="brand-logo">â†—</div>
      <h1>LinkiSend</h1>
      <span class="badge">MVP</span>
    </div>

    <div class="card" id="card-wallet">
      <div class="title">1) Connecter mon wallet</div>
      <button class="btn" id="btn-connect">Connecter un wallet</button>
      <div class="status" id="wallet-status">Aucun wallet connectÃ©.</div>
      <div class="helper">Support v1 : <b>MetaMask</b> (navigateur) & <b>WalletConnect</b> (bientÃ´t).</div>
    </div>

    <div class="card hidden" id="card-token">
      <div class="title">2) Choisir la crypto Ã  envoyer</div>
      <label for="token">Token disponible (solde & USD)</label>
      <select id="token" disabled></select>
      <div class="helper" id="balance-helper">DÃ©mo : soldes simulÃ©s jusquâ€™Ã  lâ€™intÃ©gration complÃ¨te.</div>

      <label for="amount">Montant</label>
      <input type="number" id="amount" placeholder="Ex : 0.01" min="0" step="0.000001" inputmode="decimal" />
      <div class="helper" id="usd-preview" aria-live="polite">â‰ˆ $0.00</div>
    </div>

    <div class="card hidden" id="card-network">
      <div class="title">3) RÃ©seau</div>
      <div class="row">
        <div style="flex:1">
          <label for="network">RÃ©seau dÃ©tectÃ©</label>
          <select id="network"></select>
        </div>
        <div class="inline" style="align-self:flex-end">
          <span class="pill" id="chain-pill">Non dÃ©tectÃ©</span>
        </div>
      </div>
      <div class="helper">Le rÃ©seau suit ton wallet. Tu peux changer si besoin (une demande de switch sera envoyÃ©e Ã  ton wallet).</div>
      <div class="error" id="net-error"></div>
    </div>

    <div class="card hidden" id="card-phone">
      <div class="title">4) Destinataire</div>
      <label for="phone">NumÃ©ro (format international)</label>
      <div class="row">
        <input id="phone" placeholder="+33 6 12 34 56 78" />
        <button class="btn secondary" id="btn-contacts" title="Choisir dans mes contacts" style="white-space:nowrap;">ðŸ“‡ Contacts</button>
      </div>
      <div class="helper">Sur mobile, lâ€™accÃ¨s Ã  lâ€™agenda peut Ãªtre proposÃ© si disponible. Sinon, colle le numÃ©ro.</div>
      <div class="error" id="phone-error"></div>
    </div>

    <div class="card hidden" id="card-summary">
      <div class="title">5) RÃ©sumÃ©</div>
      <div class="summary" id="summary-box">
        <div class="pair"><span class="muted">Wallet</span><b id="s-wallet">â€”</b></div>
        <div class="pair"><span class="muted">Token</span><b id="s-token">â€”</b></div>
        <div class="pair"><span class="muted">Montant</span><b id="s-amount">â€”</b></div>
        <div class="pair"><span class="muted">â‰ˆ USD</span><b id="s-usd">â€”</b></div>
        <div class="pair"><span class="muted">RÃ©seau</span><b id="s-network">â€”</b></div>
        <div class="pair"><span class="muted">TÃ©lÃ©phone</span><b id="s-phone">â€”</b></div>
      </div>
      <div class="divider"></div>
      <button class="btn" id="btn-generate" disabled>GÃ©nÃ©rer le lien</button>
      <div class="error" id="api-error"></div>
      <div class="success" id="api-success">
        Lien gÃ©nÃ©rÃ© :
        <div class="inline" style="gap:8px;margin-top:6px">
          <a id="gen-link" href="#" target="_blank" class="pill" style="overflow:hidden;text-overflow:ellipsis;max-width:100%"></a>
          <button class="copy" id="btn-copy">Copier</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal connexion wallet -->
  <div class="modal-backdrop" id="modal-connect">
    <div class="modal">
      <header>
        <h3>Choisir un wallet</h3>
        <button class="copy" id="close-modal">Fermer</button>
      </header>
      <div class="content">
        <div class="wallet-opt" id="opt-metamask">
          <div class="icon">ðŸ¦Š</div>
          <div class="meta">
            <b>MetaMask</b>
            <small>Extension navigateur / App mobile</small>
          </div>
        </div>
        <div class="wallet-opt disabled" title="BientÃ´t">
          <div class="icon">ðŸ”—</div>
          <div class="meta">
            <b>WalletConnect</b>
            <small>BientÃ´t (Trust, Rainbow, Zerion, Ledgerâ€¦)</small>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  // -------------------- CONFIG BACKEND --------------------
  const BACKEND = (window.LINKISEND_CONFIG && window.LINKISEND_CONFIG.BACKEND_BASE)
    ? window.LINKISEND_CONFIG.BACKEND_BASE
    : `${location.protocol}//${location.hostname}:8000`;

  // -------------------- STATE --------------------
  const state = {
    wallet: { address: null, chainId: null, networkKey: null, networkName: null },
    tokens: [],       // {symbol, name, balance, priceUsd}
    selectedToken: null, // object
    amount: null,
    phone: "",
  };

  // -------------------- UTILS --------------------
  const CHAINS = {
    "0x1":  { key: "ethereum", name: "Ethereum" },
    "0x89": { key: "polygon",  name: "Polygon" },
    "0x38": { key: "bsc",      name: "BNB Chain" },
    "0xa4b1": { key: "arbitrum", name: "Arbitrum One" },
    "0x2105": { key: "base", name: "Base" },
  };

  // DÃ©mo : soldes simulÃ©s en attendant lâ€™intÃ©gration balances on-chain
  const MOCK_TOKENS_BY_CHAIN = {
    ethereum: [
      { symbol:"USDC", name:"USD Coin", balance: 152.35, priceUsd:1 },
      { symbol:"ETH",  name:"Ether",    balance: 0.42,  priceUsd:3200 },
    ],
    polygon: [
      { symbol:"USDT", name:"Tether",   balance: 98.1, priceUsd:1 },
      { symbol:"MATIC",name:"Polygon",  balance: 180,  priceUsd:0.55 },
    ],
    bsc: [
      { symbol:"USDT", name:"Tether",   balance: 34.5, priceUsd:1 },
      { symbol:"BNB",  name:"BNB",      balance: 1.2,  priceUsd:520 },
    ],
    arbitrum: [
      { symbol:"USDC", name:"USD Coin", balance: 75.9, priceUsd:1 },
      { symbol:"ETH",  name:"Ether",    balance: 0.15, priceUsd:3200 },
    ],
    base: [
      { symbol:"USDC", name:"USD Coin", balance: 210.4, priceUsd:1 },
      { symbol:"ETH",  name:"Ether",    balance: 0.08, priceUsd:3200 },
    ]
  };

  function shorten(addr){ return addr ? addr.slice(0,6)+"â€¦"+addr.slice(-4) : ""; }
  function formatUSD(v){ return "$"+(Math.round(v*100)/100).toFixed(2); }
  function e164Ok(s){
    if(!s) return false;
    const t = s.trim();
    return /^\+?[1-9]\d{6,14}$/.test(t.replace(/\s/g,""));
  }

  // -------------------- DOM --------------------
  const $ = sel => document.querySelector(sel);
  const cardWallet  = $("#card-wallet");
  const cardToken   = $("#card-token");
  const cardNetwork = $("#card-network");
  const cardPhone   = $("#card-phone");
  const cardSummary = $("#card-summary");

  const btnConnect = $("#btn-connect");
  const statusWallet = $("#wallet-status");

  const tokenSelect = $("#token");
  const amountInput = $("#amount");
  const usdPreview  = $("#usd-preview");

  const networkSelect = $("#network");
  const chainPill = $("#chain-pill");
  const netError = $("#net-error");

  const phoneInput = $("#phone");
  const phoneError = $("#phone-error");
  const btnContacts = $("#btn-contacts");

  const sWallet = $("#s-wallet");
  const sToken  = $("#s-token");
  const sAmount = $("#s-amount");
  const sUsd    = $("#s-usd");
  const sNetwork= $("#s-network");
  const sPhone  = $("#s-phone");

  const btnGenerate = $("#btn-generate");
  const apiError = $("#api-error");
  const apiSuccess = $("#api-success");
  const genLink = $("#gen-link");
  const btnCopy = $("#btn-copy");

  // Modal
  const modal = $("#modal-connect");
  const optMetamask = $("#opt-metamask");
  const closeModal = $("#close-modal");

  // -------------------- WALLET (MetaMask) --------------------
  btnConnect.addEventListener("click", ()=> { modal.style.display = "flex"; });

  closeModal.addEventListener("click", ()=> { modal.style.display = "none"; });

  optMetamask.addEventListener("click", async ()=>{
    if(!window.ethereum){
      alert("MetaMask non dÃ©tectÃ©. Installe lâ€™extension ou ouvre via lâ€™app MetaMask.");
      return;
    }
    try{
      const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
      const chainId = await window.ethereum.request({ method: 'eth_chainId' });

      state.wallet.address = accounts?.[0] || null;
      state.wallet.chainId = chainId;
      const chainInfo = CHAINS[chainId];
      if(chainInfo){
        state.wallet.networkKey = chainInfo.key;
        state.wallet.networkName = chainInfo.name;
      }else{
        state.wallet.networkKey = null;
        state.wallet.networkName = "RÃ©seau non supportÃ©";
      }

      statusWallet.textContent = `ConnectÃ© : ${shorten(state.wallet.address)}`;
      chainPill.textContent = state.wallet.networkName || "Inconnu";

      modal.style.display = "none";

      // Afficher Ã©tapes suivantes
      hydrateNetworkSelect();
      loadTokensForNetwork();   // dÃ©mo : soldes simulÃ©s
      cardToken.classList.remove("hidden");
      cardNetwork.classList.remove("hidden");
      cardPhone.classList.remove("hidden");
      cardSummary.classList.remove("hidden");

      refreshSummary();
      validateReady();
      // Ecouteurs rÃ©seau / compte
      window.ethereum.on?.('chainChanged', (cid)=>{
        state.wallet.chainId = cid;
        const info = CHAINS[cid];
        state.wallet.networkKey = info?.key || null;
        state.wallet.networkName = info?.name || "RÃ©seau non supportÃ©";
        chainPill.textContent = state.wallet.networkName;
        hydrateNetworkSelect();
        loadTokensForNetwork(); // re-remplir tokens
        // reset amount et sÃ©lection
        amountInput.value = "";
        state.amount = null;
        refreshSummary();
        validateReady();
      });
      window.ethereum.on?.('accountsChanged', (accs)=>{
        state.wallet.address = accs?.[0] || null;
        statusWallet.textContent = state.wallet.address ? `ConnectÃ© : ${shorten(state.wallet.address)}` : "Aucun wallet connectÃ©.";
        refreshSummary();
        validateReady();
      });
    }catch(err){
      alert("Connexion refusÃ©e.");
    }
  });

  // -------------------- NETWORK SELECT --------------------
  function hydrateNetworkSelect(){
    networkSelect.innerHTML = "";
    const entries = Object.values(CHAINS);
    entries.forEach(ch=>{
      const opt = document.createElement("option");
      opt.value = ch.key;
      opt.textContent = ch.name;
      if(state.wallet.networkKey === ch.key) opt.selected = true;
      networkSelect.appendChild(opt);
    });
  }

  networkSelect.addEventListener("change", async ()=>{
    const desiredKey = networkSelect.value;
    const entry = Object.entries(CHAINS).find(([hex,info])=> info.key===desiredKey);
    if(!entry){ return; }
    const [targetChainId, info] = entry;

    if(window.ethereum && state.wallet.chainId !== targetChainId){
      try{
        await window.ethereum.request({ method:'wallet_switchEthereumChain', params:[{ chainId: targetChainId }] });
      }catch(err){
        // Lâ€™utilisatrice a peut-Ãªtre refusÃ© ; on remet lâ€™UI sur lâ€™ancien rÃ©seau.
        netError.textContent = "Le rÃ©seau nâ€™a pas Ã©tÃ© changÃ© dans le wallet.";
        netError.style.display = "block";
        setTimeout(()=> netError.style.display="none", 3000);
        hydrateNetworkSelect();
        return;
      }
    }
    // Si succÃ¨s (ou pas de MetaMask), on aligne lâ€™Ã©tat
    state.wallet.chainId = entry[0];
    state.wallet.networkKey = info.key;
    state.wallet.networkName = info.name;
    chainPill.textContent = state.wallet.networkName;

    loadTokensForNetwork();
    amountInput.value = "";
    state.amount = null;
    refreshSummary();
    validateReady();
  });

  // -------------------- TOKENS (dÃ©mo) --------------------
  function loadTokensForNetwork(){
    const key = state.wallet.networkKey;
    const list = key ? (MOCK_TOKENS_BY_CHAIN[key] || []) : [];
    // Ne garder que > 0
    state.tokens = list.filter(t => (t.balance || 0) > 0);

    tokenSelect.innerHTML = "";
    state.tokens.forEach((t, idx)=>{
      const opt = document.createElement("option");
      opt.value = String(idx);
      opt.textContent = `${t.name} (${t.symbol}) â€¢ ${t.balance} â€¢ â‰ˆ ${formatUSD(t.balance * (t.priceUsd||0))}`;
      tokenSelect.appendChild(opt);
    });

    tokenSelect.disabled = state.tokens.length === 0;
    state.selectedToken = state.tokens.length ? state.tokens[0] : null;

    updateUSDPreview();
    refreshSummary();
  }

  tokenSelect.addEventListener("change", ()=>{
    const idx = Number(tokenSelect.value);
    state.selectedToken = state.tokens[idx] || null;
    // Reset montant quand on change de token, pour Ã©viter erreurs
    amountInput.value = "";
    state.amount = null;
    updateUSDPreview();
    refreshSummary();
    validateReady();
  });

  amountInput.addEventListener("input", ()=>{
    const v = parseFloat(amountInput.value);
    state.amount = isNaN(v) ? null : v;
    updateUSDPreview();
    refreshSummary();
    validateReady();
  });

  function updateUSDPreview(){
    const amt = parseFloat(amountInput.value);
    if(state.selectedToken && !isNaN(amt)){
      const usd = amt * (state.selectedToken.priceUsd || 0);
      usdPreview.textContent = "â‰ˆ " + formatUSD(usd);
    }else{
      usdPreview.textContent = "â‰ˆ $0.00";
    }
  }

  // -------------------- PHONE --------------------
  phoneInput.addEventListener("input", ()=>{
    state.phone = phoneInput.value.trim();
    phoneError.style.display = "none";
    refreshSummary();
    validateReady();
  });

  btnContacts.addEventListener("click", async ()=>{
    // Best-effort simple (demo) : on affiche une info.
    alert("SÃ©lecteur de contacts disponible sur certains navigateurs mobiles. Pour lâ€™instant, colle le numÃ©ro manuellement.");
  });

  // -------------------- SUMMARY + GENERATE --------------------
  function refreshSummary(){
    sWallet.textContent  = state.wallet.address ? shorten(state.wallet.address) : "â€”";
    sToken.textContent   = state.selectedToken ? `${state.selectedToken.symbol}` : "â€”";
    sAmount.textContent  = (state.amount && !isNaN(state.amount)) ? String(state.amount) : "â€”";
    sUsd.textContent     = (state.selectedToken && state.amount) ? formatUSD(state.amount * (state.selectedToken.priceUsd||0)) : "â€”";
    sNetwork.textContent = state.wallet.networkName || "â€”";
    sPhone.textContent   = state.phone || "â€”";
  }

  function validateReady(){
    const ok =
      !!state.wallet.address &&
      !!state.selectedToken &&
      !!state.wallet.networkKey &&
      (state.amount && state.amount > 0) &&
      e164Ok(state.phone);

    btnGenerate.disabled = !ok;
    return ok;
  }

  btnGenerate.addEventListener("click", async ()=>{
    apiError.style.display = "none";
    apiSuccess.style.display = "none";

    if(!validateReady()){
      apiError.textContent = "Champs incomplets ou invalides.";
      apiError.style.display = "block";
      return;
    }
    try{
      const payload = {
        amount: state.amount,
        currency: state.selectedToken.symbol,
        sender_wallet: state.wallet.address,
        recipient_phone: state.phone.replace(/\s/g,""),
        network: state.wallet.networkName || "Ethereum"
      };
      const res = await fetch(`${BACKEND}/create-link`, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if(!res.ok) throw new Error(data.detail || "Erreur lors de la gÃ©nÃ©ration du lien");
      const lien = `${BACKEND}/s/${data.short_id}`;
      genLink.textContent = lien;
      genLink.href = lien;
      apiSuccess.style.display = "block";
    }catch(err){
      apiError.textContent = err.message || "Erreur rÃ©seau";
      apiError.style.display = "block";
    }
  });

  btnCopy.addEventListener("click", async ()=>{
    const text = genLink.textContent || "";
    try{
      await navigator.clipboard.writeText(text);
      btnCopy.textContent = "CopiÃ© âœ“";
      setTimeout(()=> btnCopy.textContent = "Copier", 1200);
    }catch{
      btnCopy.textContent = "Ã‰chec";
      setTimeout(()=> btnCopy.textContent = "Copier", 1200);
    }
  });
</script>
</body>
</html>
