<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>LinkiSend — Envoyer des cryptos</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <style>
    :root{
      --bg: #0b0f14;
      --bg-soft:#0f141b;
      --card:#121821;
      --card-2:#0f1620;
      --text:#e6edf3;
      --text-dim:#9fb0c0;
      --stroke:#1f2a37;
      --focus:#334155;
      --shadow: 0 12px 40px rgba(0,0,0,.45);
      --radius:14px;
      --radius-sm:10px;
      --gap:12px;
    }
    *,*:before,*:after{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      background:
        radial-gradient(1200px 600px at 20% -10%, #132034 0%, transparent 60%),
        radial-gradient(900px 500px at 110% 0%, #1a2334 0%, transparent 60%),
        var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .wrap{
      max-width:420px;
      margin:40px auto 64px;
      padding:0 16px;
    }
    .brand{
      display:flex;
      align-items:center;
      justify-content:center;
      margin-bottom:18px;
      position: relative;
    }
    .brand img.word{
      max-width: 240px;
      height: auto;
      display: block;
    }
    .brand img.arrow{
      position:absolute;
      left:0;
      top:50%;
      transform: translateY(-50%);
      max-width: 60px;
      height:auto;
    }
    .card{
      background:linear-gradient(180deg,var(--card),var(--card-2));
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px 16px;
    }
    .card h2{
      margin:4px 2px 2px;
      font-size:22px;font-weight:750;
    }
    .sub{
      color:var(--text-dim);
      margin:0 2px 14px;
      font-size:13px;
    }
    .row{display:flex;gap:var(--gap)}
    .col{flex:1}
    label{
      display:block;
      margin:10px 2px 6px;
      font-size:13px;
      color:var(--text-dim);
    }
    select,input{
      width:100%;
      height:44px;
      padding:10px 12px;
      border-radius:var(--radius-sm);
      border:1px solid var(--stroke);
      background:#0e141c;
      color:var(--text);
      outline:none;
      transition:.15s border,.15s box-shadow,.15s background;
    }
    select:focus,input:focus{
      border-color:var(--focus);
      box-shadow:0 0 0 3px rgba(51,65,85,.35);
    }
    .hint{font-size:12px;color:var(--text-dim);margin:6px 2px 0}
    .btn{
      width:100%;height:46px;border:0;border-radius:12px;
      font-weight:700;font-size:15px;cursor:pointer;
      background: radial-gradient(circle at 20% 20%, #8b5cf6, #06b6d4, #22c55e);
      color:#fff;
      box-shadow:0 10px 24px rgba(34,197,94,.2);
      transition:transform .06s ease, box-shadow .2s ease, background .12s ease;
      margin-top:14px;
    }
    .btn:hover{box-shadow:0 12px 32px rgba(34,197,94,.28)}
    .btn:active{transform:translateY(1px)}
    .wallet-link{
      display:inline-flex;align-items:center;gap:8px;
      color:#93c5fd;text-decoration:none;font-weight:600;font-size:14px;
      padding:8px 10px;border-radius:10px;border:1px dashed var(--stroke);
      background:#0a1220; margin:8px 2px 4px; width:max-content;
    }
    .wallet-link:hover{background:#0d1729}
    .result,.error{
      margin:14px 2px 0;padding:10px 12px;border-radius:10px;font-size:13px;
      border:1px solid var(--stroke);
    }
    .result{background:#0a1b13;color:#a7f3d0;border-color:#134e32}
    .error{background:#1b0e10;color:#fecaca;border-color:#6b1d24}

    /* Modal */
    .modal {
      position:fixed;inset:0;display:none;place-items:center;
      background:rgba(3,6,12,.6);backdrop-filter:blur(4px);z-index:50;
      padding:20px;
    }
    .modal.open{display:grid;}
    .modal-card{
      width:min(420px,95vw);
      background:linear-gradient(180deg,var(--card),var(--card-2));
      border:1px solid var(--stroke);border-radius:16px;box-shadow:var(--shadow);
      padding:16px;
    }
    .modal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .modal-head h3{margin:0;font-size:18px}
    .x{appearance:none;border:0;background:transparent;color:var(--text-dim);font-size:22px;cursor:pointer}
    .providers{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
    .pv{
      display:flex;align-items:center;gap:10px;padding:10px;border:1px solid var(--stroke);
      border-radius:12px;background:#0e141c;color:var(--text);cursor:pointer;font-weight:600
    }
    .pv img{width:20px;height:20px}
    .tag{
      margin-left:auto;font-size:11px;padding:2px 6px;border-radius:999px;
      background:linear-gradient(90deg,#8b5cf6,#06b6d4,#22c55e);
      color:#fff;border:0;font-weight:600;
    }
    .pv:hover{background:#101924}

    @media (max-width:420px){
      .wrap{margin:26px auto 54px}
      .card h2{font-size:20px}
    }
  </style>
</head>
<body>
  <!-- CONFIG (URL backend) -->
  <script src="config.js"></script>

  <div class="wrap">
    <div class="brand">
      <img src="assets/branding/logo-arrow.svg" alt="Flèche" class="arrow" />
      <img src="assets/branding/logo-word.svg" alt="LinkiSend" class="word" />
    </div>

    <div class="card" role="region" aria-label="Formulaire d’envoi">
      <h2>Envoyer des cryptos</h2>
      <p class="sub">Génère un lien en 10&nbsp;secondes.</p>

      <!-- 1) WALLET EN PREMIER -->
      <label for="wallet">Ton wallet (expéditeur)</label>
      <input type="text" id="wallet" placeholder="0xABCDEF..." autocomplete="off" />
      <a href="#" id="connectWalletLink" class="wallet-link" aria-haspopup="dialog">Connecter un wallet</a>

      <!-- 2) TOKEN & MONTANT -->
      <div class="row">
        <div class="col">
          <label for="currency">Token</label>
          <select id="currency">
            <option>USDT</option><option>USDC</option><option>ETH</option>
            <option>BTC</option><option>SOL</option><option>BNB</option>
            <option>AVAX</option><option>DAI</option><option>LINK</option>
          </select>
        </div>
        <div class="col">
          <label for="amount">Montant (crypto)</label>
          <input type="number" id="amount" inputmode="decimal" min="0" step="0.00001" placeholder="0.01" />
        </div>
      </div>

      <!-- 3) RÉSEAU -->
      <label for="network">Réseau</label>
      <select id="network">
        <option>Ethereum</option><option>BNB Chain</option>
        <option>Polygon</option><option>Solana</option><option>Avalanche</option>
      </select>

      <!-- 4) TÉLÉPHONE EN DERNIER -->
      <label for="phone">Numéro du destinataire</label>
      <input type="text" id="phone" placeholder="+33..." inputmode="tel" />

      <button id="generateBtn" class="btn">Générer le lien</button>

      <p class="hint">Aucun transfert on-chain n’est effectué tant que le lien n’est pas réclamé.</p>

      <div id="result" class="result" style="display:none"></div>
      <div id="error"  class="error"  style="display:none"></div>
    </div>
  </div>

  <!-- Modal choix wallet -->
  <div class="modal" id="walletModal" role="dialog" aria-modal="true" aria-labelledby="walletModalTitle">
    <div class="modal-card">
      <div class="modal-head">
        <h3 id="walletModalTitle">Connecter un wallet</h3>
        <button class="x" id="walletModalClose" aria-label="Fermer">✕</button>
      </div>
      <div class="providers">
        <button class="pv" data-wallet="metamask">
          <img src="assets/wallets/metamask.svg" alt="MetaMask" />
          MetaMask <span class="tag">EVM</span>
        </button>
        <button class="pv" data-wallet="walletconnect">
          <img src="assets/wallets/walletconnect.svg" alt="WalletConnect" />
          WalletConnect <span class="tag">Bientôt</span>
        </button>
        <button class="pv" data-wallet="coinbase">
  <img src="assets/wallets/coinbase.svg" alt="Coinbase Wallet" />
  Coinbase Wallet <span class="tag">Bientôt</span>
</button>

<button class="pv" data-wallet="phantom">
  <img src="assets/wallets/phantom.svg" alt="Phantom" />
  Phantom <span class="tag">Solana</span>
</button>
      </div>
    </div>
  </div>

  <script>
    // Config backend (fallback localhost)
    const BACKEND = (window.LINKISEND_CONFIG && window.LINKISEND_CONFIG.BACKEND_BASE)
      ? window.LINKISEND_CONFIG.BACKEND_BASE
      : `${location.protocol}//${location.hostname}:8000`;

    // Elements
    const resultDiv = document.getElementById('result');
    const errorDiv  = document.getElementById('error');
    const walletInput = document.getElementById('wallet');

    // Modal helpers
    const modal = document.getElementById('walletModal');
    const openModal = () => { modal.classList.add('open'); };
    const closeModal = () => { modal.classList.remove('open'); };

    document.getElementById('connectWalletLink').addEventListener('click', (e)=>{
      e.preventDefault(); openModal();
    });
    document.getElementById('walletModalClose').addEventListener('click', closeModal);
    modal.addEventListener('click', (e)=>{ if (e.target === modal) closeModal(); });

    // Choix provider
    modal.querySelectorAll('.pv').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const provider = btn.getAttribute('data-wallet');
        if(provider === 'metamask'){
          if(!window.ethereum){ alert("MetaMask non détecté."); return; }
          try{
            const accounts = await window.ethereum.request({ method:'eth_requestAccounts' });
            if(accounts && accounts[0]) walletInput.value = accounts[0];
            closeModal();
          }catch(e){ alert("Connexion refusée."); }
        }else{
          alert("Connexion via " + provider + " arrive bientôt.");
        }
      });
    });

    // Génération du lien
    document.getElementById('generateBtn').addEventListener('click', async ()=>{
      const amount = parseFloat(document.getElementById('amount').value);
      const currency = document.getElementById('currency').value;
      const sender_wallet = walletInput.value.trim();
      const recipient_phone = document.getElementById('phone').value.trim();
      const network = document.getElementById('network').value;

      resultDiv.style.display='none';
      errorDiv.style.display='none';

      if (!amount || !currency || !sender_wallet || !recipient_phone || !network){
        errorDiv.textContent = "Merci de remplir tous les champs obligatoires.";
        errorDiv.style.display='block';
        return;
      }

      try{
        const res = await fetch(`${BACKEND}/create-link`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ amount, currency, sender_wallet, recipient_phone, network })
        });
        const data = await res.json();
        if(!res.ok) throw new Error(data.detail || "Erreur lors de la génération du lien");

        const lien = `${BACKEND}/s/${data.short_id}`;
        resultDiv.innerHTML = `<b>Lien généré :</b><br><a href="${lien}" target="_blank" rel="noopener">${lien}</a>`;
        resultDiv.style.display='block';
      }catch(err){
        errorDiv.textContent = err.message || 'Erreur réseau';
        errorDiv.style.display='block';
      }
    });
  </script>
</body>
</html>
